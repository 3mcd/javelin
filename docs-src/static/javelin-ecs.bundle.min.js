!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Javelin={})}(this,(function(e){"use strict";function t(e,t="",n){if(!e)throw new Error(void 0!==n?`${r[n]}: ${t}`:t)}var n;!function(e){e[e.Internal=0]="Internal"}(n||(n={}));const r={[n.Internal]:"Internal Error"};function o(e){for(;e.length>0;)e.pop()}var s,i;!function(e){e[e.Array=0]="Array",e[e.Map=1]="Map",e[e.Primitive=2]="Primitive"}(s||(s={})),function(e){e.Number="number",e.Boolean="boolean",e.String="string"}(i||(i={}));const c={__kind__:s.Primitive,__type__:i.Number,create:()=>0,reset:(e,t)=>e[t]=0},l={__kind__:s.Primitive,__type__:i.String,create:()=>"",reset:(e,t)=>e[t]=0},a={__kind__:s.Primitive,__type__:i.Boolean,create:()=>!1,reset:(e,t)=>e[t]=0},u=e=>"__kind__"in e&&e.__kind__===s.Primitive,p=e=>"__kind__"in e&&e.__kind__===s.Array;var f;!function(e){e[e.Primitive=0]="Primitive",e[e.Struct=1]="Struct",e[e.Array=2]="Array",e[e.Map=3]="Map"}(f||(f={}));const _=(e,t)=>e.localeCompare(t),d=(e,r,o,i)=>{const c=++o;let l;switch(r.__kind__){case s.Array:l=f.Array;break;case s.Map:l=f.Map;break;case s.Primitive:l=f.Primitive;break;default:l=f.Struct}const a={id:c,lo:c,hi:-1,inCollection:e.inCollection||e.kind===f.Array||e.kind===f.Map,kind:l};let _;var y;return u(r)?_={...a,kind:f.Primitive,type:r}:p(r)?(_={...a,kind:f.Array},o=d(_,r.__type__,o)):"__kind__"in(y=r)&&y.__kind__===s.Map?(_={...a,kind:f.Map},o=d(_,r.__type__,o)):(_={...a,kind:f.Struct,edges:[],keys:{},idsByKey:{}},o=h(r,_,o)),_.hi=o,i?(_.key=i,t(e.kind===f.Struct,"expected target node to be struct",n.Internal),function(e){t("key"in e,"",n.Internal)}(_),e.edges.push(_),e.keys[_.key]=_,e.idsByKey[_.key]=c):(t(e.kind===f.Array||e.kind===f.Map,"expected target node to be collection",n.Internal),e.edge=_),o},h=(e,t,n=-1)=>{const r=Object.keys(e).sort(_);for(let o=0;o<r.length;o++){const s=r[o],i=e[s];n=d(t,i,n,s)}return t.hi=n,n},y=e=>{const t={};return e.forEach((e,n)=>{const r={edges:[],hi:1/0,lo:-1,id:-1,idsByKey:{},inCollection:!1,keys:{},kind:f.Struct};h(e,r),t[n]=r}),t};const g=()=>{const e=[];return{subscribe:t=>(e.push(t),()=>function(e,t){const n=e.length,r=e.indexOf(t);if(-1===r)return!1;const o=e.pop();return r<n-1&&(e[r]=o),!0}(e,t)),dispatch:(t,n,r)=>{for(let o=0;o<e.length;o++)e[o](t,n,r)}}};function m(e){const t="snapshot"in e?e.snapshot:null,n=t?Object.keys(t.indices).map(Number):[],r=t?function(e){const t=[];for(const n in e){const r=parseInt(n,10);isNaN(r)||(t[r]=e[n])}return t}(t.indices):[],o=("signature"in e?e.signature:e.snapshot.signature).slice().sort((e,t)=>e-t),s=t?t.table.map(e=>e.slice()):o.map(()=>[]),i=o.reduce((e,t,n)=>(e[t]=n,e),[]);return{entities:n,indices:r,signature:o,signatureInverse:i,table:s}}function v(e){const{signature:t,signatureInverse:n,entities:r,indices:o,table:s}=m(e),i=g(),c=g();return{entities:r,indices:o,insert:function(e,t){for(let e=0;e<t.length;e++){const r=t[e],o=n[r.__type__];s[o].push(r)}o[e]=r.push(e)-1,i.dispatch(e)},inserted:i,remove:function(e){const t=r.length,n=o[e],i=r.pop();if(delete o[e],n===t-1)for(const e of s)e.pop();else{for(const e of s)e[n]=e.pop();r[n]=i,o[i]=n}c.dispatch(e)},removed:c,signature:t,signatureInverse:n,table:s}}const b={__MODEL__:{},__WORLDS__:[],__CURRENT_WORLD__:-1},k=g(),T=Symbol("javelin_component_type");function w(e,t,n){const r=[],o=()=>{for(let t=0;t<n;t++)r.push(e(s))},s={allocate:o,retain:()=>(r.length||o(),r.pop()),release:e=>{r.push(t(e))}};return s}let O=0;function S(e){return Object.defineProperties({},{__type__:{value:e[T],writable:!1,enumerable:!0}})}const x=new Map;function C(e,t){return w(()=>function e(t,n){for(const r in n){const o=n[r];u(o)?t[r]=o.create():o.__kind__===s.Array?t[r]=[]:t[r]=e({},o)}return t}(S(e),e),t=>function e(t,n){for(const r in n){const s=n[r];u(s)?s.reset(t,r,void 0):p(s)?o(s):e(t[r],s)}return t}(t,e),t)}const D=new Map,E=(e,t,n=1e3)=>{let r=e[T];if(void 0!==r)return r;if(r=t,void 0===r){for(;D.has(O++););r=e[T]=O}else if(D.has(r))throw new Error("Failed to register component type: a component with same id is already registered");return x.set(r,C(e,n)),D.set(r,e),b.__MODEL__=y(D),r};function A(e,t={throw:!1,global:!1}){const{global:n}=t,r=[];let o,s,i,c,l,a=-1;return function(...t){c=b.__CURRENT_WORLD__;const u=b.__WORLDS__[c],p=u.state.currentTick;l=n?0:u.state.currentSystem;let f=r[c];void 0===r[c]&&(f=r[c]=[]);let _=f[l];if(void 0===_&&(_=f[l]={cells:[],cellCount:-1}),!0===n||s!==c&&void 0!==s)a=0;else if(void 0===i||o===p&&i===l)a++;else{let e=f[i];if(-1!==e.cellCount&&e.cellCount!==a)throw new Error(`Failed to execute effect: encountered too ${e.cellCount>a?"few":"many"} effects this tick`);e.cellCount=a,a=0}let d=_.cells[a];if(d||(d=_.cells[a]={executor:e(u),lockGlobal:!1,lockAsync:!1,lockGlobalTick:-1,state:null}),n&&(d.lockGlobalTick!==u.state.currentTick?(d.lockGlobal=!1,d.lockGlobalTick=u.state.currentTick):d.lockGlobal=!0),d.lockGlobal||d.lockAsync)return d.state;const h=d.executor(...t);var y;return"object"==typeof(y=h)&&null!==y&&"then"in y?(d.lockAsync=!0,h.then(e=>d.state=e).catch(e=>console.error("Uncaught error in effect: "+e.message,e)).then(()=>d.lockAsync=!1)):d.state=h,o=p,s=c,i=l,d.state}}const R=A(()=>{let e=!0;const t={value:null};return function(n){return e&&(t.value=n,e=!1),t}}),M=A(()=>{let e,t=0;return function(n,r=!1){return r&&(t=0,clearTimeout(e)),0===t&&(t=1,e=setTimeout(()=>{t=2},n)),2===t}}),W=A(()=>function(e){const t=R(!1),n=M(e,t.value);return t.value=n,n}),I=(e,t)=>((e,t)=>{let n=0,r=0;if(e.length<t.length)return!1;for(;n<e.length&&r<t.length;)if(e[n]<t[r])n++;else{if(e[n]!==t[r])return!1;n++,r++}return r===t.length})(t.signature,e.signature)&&t.signature.every(t=>!e.filters.not.has(t));const L=A(e=>{const{storage:{entityRelocated:t}}=e;let n=[],r=[],s=[],i=[],c=null;return t.subscribe((e,t,o)=>{null!==c&&(I(c,o)?n.push(e):I(c,t)&&r.push(e))}),function(e,t,l){let a;for(c!==e&&(e=>{c=e,o(n),o(r),o(s),o(i);for(const[t]of e)for(let e=0;e<t.length;e++)n.push(t[e])})(e),o(s),o(i);void 0!==(a=n.pop());)s.push(a);for(;void 0!==(a=r.pop());)i.push(a);if(void 0!==t)for(let e=0;e<s.length;e++)t(s[e]);if(void 0!==l)for(let e=0;e<i.length;e++)l(i[e])}}),P=w(()=>[-1,null],e=>(e[0]=-1,e[1]=null,e),1e3),N=A(e=>{const{storage:{archetypes:t}}=e,n=new Set,r=[],o=[],s=[],i=[];let c,l;const a=(e,t,r)=>{const o=P.retain();o[0]=e,o[1]=t,r.push(o),n.add(e)};return e.attached.subscribe((e,t)=>{for(let n=0;n<t.length;n++){const o=t[n];o.__type__===l&&a(e,o,r)}}),e.detached.subscribe((e,t)=>{for(let n=0;n<t.length;n++){const r=t[n];r.__type__===l&&a(e,r,o)}}),function(e,u,p){let f,_,d,h;for(e!==c&&(e=>{for(let n=0;n<t.length;n++){const{table:o,entities:s,signatureInverse:i}=t[n],c=i[e[T]];if(void 0!==c){const e=o[c];for(let t=0;t<s.length;t++)a(s[t],e[t],r)}}c=e,l=e[T]})(e);f=s.pop();)P.release(f);for(;_=i.pop();)P.release(_);for(;d=r.pop();)s.push(d);for(;h=o.pop();)i.push(h);if(n.clear(),u)for(let e=0;e<s.length;e++){const[t,n]=s[e];u(t,n)}if(p)for(let e=0;e<i.length;e++){const[t,n]=i[e];p(t,n)}}}),j={},B="object"==typeof window?()=>window.performance.now():()=>require("perf_hooks").performance.now,G=()=>{const e=new WeakMap,t=(e,t)=>{const{__type__:n}=e,r=b.__MODEL__[n];let o=j[n];void 0===o&&(o=j[n]={});let s=o[t];if(void 0===s){let e=r;const n=[],i=t.split(".");for(let t=0;t<i.length;t++){const r=i[t];switch(e.kind){case f.Array:case f.Map:e=e.edge,n.push(r);break;case f.Struct:e=e.keys[r]}}o[t]=s={traverse:n,path:t,split:i,field:e.id}}return s},n=t=>{let n=e.get(t);return void 0===n&&(n={object:{},array:{}},e.set(t,n)),n};return{track:(e,r,o)=>{const s=t(e,r),{object:i}=n(e);return i[r]?i[r].value=o:i[r]={pointer:s,value:o},s},trackArray:function(e,r,o,s,...i){const c=t(e,r),{array:l}=n(e);return l[(()=>{let e=(new Date).getTime(),t=1e3*B();return"xxxxxxxxxxxxxxxx".replace(/[xy]/g,n=>{let r=16*Math.random();return e>0?(r=(e+r)%16|0,e=Math.floor(e/16)):(r=(t+r)%16|0,t=Math.floor(t/16)),("x"===n?r:3&r|8).toString(16)})})()]={index:o,remove:s,insert:i,pointer:c},c},changesOf:t=>e.get(t)||null}},U=A(()=>{const e=G();return function(){return e}}),F=A(()=>{let e,t={response:null,error:null,done:!1},n=!1,r=new window.AbortController;return function(o,s,i=void 0!==e&&o!==e){return(null===o||i)&&(r.abort(),r=new AbortController),null===o?t:(i&&(t={response:t.response,error:null,done:!1}),t.done||n||(n=!0,e=o,fetch(o,{...s,signal:r.signal}).then(e=>{t={response:e,error:null,done:!0}}).catch(e=>{t={response:t.response,error:e,done:!0}}).then(()=>{n=!1})),t)}}),J=A(()=>{let e;return function(...t){const n=R(null),r=F(...t);return r.response&&r.response!==n.value&&(r.response.json().then(t=>{e=t}),n.value=r.response),{...r,response:e||null}}});function $(e={}){const t=g(),n=g(),r=e.snapshot?e.snapshot.archetypes.map(e=>v({snapshot:e})):[],s=[];function i(e){let n=function(e){const t=e.length;for(let n=0;n<r.length;n++){const o=r[n],{signature:s}=o;if(s.length!==t)continue;let i=!0;for(let n=0;n<t;n++)if(-1===s.indexOf(e[n].__type__)){i=!1;break}if(i)return o}return null}(e);return n||(n=v({signature:e.map(e=>e.__type__)}),r.push(n),t.dispatch(n)),n}function c(e){const t=s[e];if(void 0===t)throw new Error("Failed to locate entity. Entity does not exist.");if(null===t)throw new Error("Failed to locate entity. Entity has been removed.");return r[t]}function l(e,t,o){e.remove(t);const c=i(o);c.insert(t,o),s[t]=r.indexOf(c),n.dispatch(t,e,c)}function a(e,t){const n=c(e),r=n.indices[e];let o=t.slice();for(let e=0;e<n.signature.length;e++){const s=n.signature[e];if(t.find(e=>e.__type__===s))throw new Error(`Failed to attach component with type ${s}: entity already has component of type`);o.push(n.table[e][r])}l(n,e,o)}function u(e,t){p(e,t.map(e=>e.__type__))}function p(e,t){const n=c(e),r=n.indices[e];let o=[];for(let e=0;e<n.signature.length;e++){const s=n.signature[e],i=n.table[e][r];t.includes(s)||o.push(i)}l(n,e,o)}const f=[];function _(e,t){const n=c(e),r=n.signatureInverse[t];if(void 0===r)return null;const o=n.indices[e];return n.table[r][o]}function d(e){const t=c(e),n=t.indices[e],r=[];for(let e=0;e<t.table.length;e++)r.push(t.table[e][n]);return r}return{archetypeCreated:t,archetypes:r,clear:function(){o(r),o(s)},create:function(e,t){const n=i(t);return n.insert(e,t),s[e]=r.indexOf(n),e},destroy:function(e){u(e,d(e)),s[e]=null},entityRelocated:n,findComponent:function(e,t){return _(e,t[T])},findComponentByComponentTypeId:_,getEntityComponents:d,hasComponent:function(e,t){return c(e).signature.includes(t[T])},insert:a,remove:u,removeByTypeIds:p,snapshot:function(){return{archetypes:r.map(e=>{return{signature:e.signature.slice(),table:e.table.map(e=>e.map(e=>({...e}))),indices:(t=e.indices,t.reduce((e,t,n)=>(e[n]=t,e),{}))};var t})}},upsert:function(e,t){const n=c(e),r=n.indices[e];o(f);for(let e=0;e<t.length;e++){const o=t[e],s=n.signatureInverse[o.__type__];void 0===s?f.push(o):Object.assign(n.table[s][r],o)}f.length>0&&a(e,f)}}}var q;(q=e.WorldOpType||(e.WorldOpType={}))[q.Spawn=0]="Spawn",q[q.Attach=1]="Attach",q[q.Detach=2]="Detach",q[q.Mutate=3]="Mutate",q[q.Destroy=4]="Destroy",e.arrayOf=e=>({__kind__:s.Array,__type__:e}),e.boolean=a,e.component=e=>(E(e),x.get(e[T]).retain()),e.componentTypePools=x,e.createArchetype=v,e.createComponentBase=S,e.createComponentPool=C,e.createEffect=A,e.createObserver=G,e.createQuery=function(...e){const t=e.length,n=e.map(e=>E(e)),r={not:new Set},s=n.slice().sort((e,t)=>e-t),i=[],c=(e,t)=>{if(I(u,e)){const r=n.map(t=>e.table[e.signature.indexOf(t)]);t.push([e.entities,r])}},l=e=>{const t=b.__WORLDS__[e],n=[];return i[e]=n,t.storage.archetypes.forEach(e=>c(e,n)),t.storage.archetypeCreated.subscribe(e=>c(e,n)),n},a=w(()=>[],e=>(o(e),e),1e3),u=e=>{const n=i[b.__CURRENT_WORLD__]||l(b.__CURRENT_WORLD__),r=a.retain();for(let o=0;o<n.length;o++){const[s,i]=n[o];for(let n=0;n<s.length;n++){for(let e=0;e<t;e++)r[e]=i[e][n];e(s[n],r)}}a.release(r)};return u.layout=n,u.signature=s,u.filters=r,u.not=(...e)=>{for(let t=0;t<e.length;t++)r.not.add(e[t][T]);return u},u[Symbol.iterator]=()=>(i[b.__CURRENT_WORLD__]||l(b.__CURRENT_WORLD__))[Symbol.iterator](),u},e.createStorage=$,e.createTopic=()=>{const e=[],t=[];return{*[Symbol.iterator](){for(let e=0;e<t.length;e++)yield t[e]},push:t=>e.push(t),pushImmediate:e=>t.push(e),flush:()=>{o(t);for(let n=e.length-1;n>=0;n--)t[n]=e.pop()},clear:()=>{o(e),o(t)}}},e.createWorld=function(t={}){var n,r;const{topics:s=[]}=t,i=[],c=[],l=[],a=w(()=>[],e=>(o(e),e),1e3),u=g(),p=g(),f=g(),_=g(),d=new Set,h=$({snapshot:null===(n=t.snapshot)||void 0===n?void 0:n.storage});let y={currentTickData:null,currentTick:0,currentSystem:0},m=0;function v(...e){const t=a.retain();for(let n=0;n<e.length;n++)t[n]=e[n];return t}function k(e){h.create(e,[]),f.dispatch(e)}function O(e,t){h.insert(e,t),u.dispatch(e,t)}function S(e,t){h.remove(e,t),p.dispatch(e,t)}function C(e){h.destroy(e),_.dispatch(e)}function D(t,n=!0){switch(!0===n&&l.push(t),t[0]){case e.WorldOpType.Spawn:return function(e){const[,t]=e;k(t)}(t);case e.WorldOpType.Attach:return function(e){const[,t,n]=e;O(t,n)}(t);case e.WorldOpType.Detach:return function(e){const[,t,n]=e;S(t,n)}(t);case e.WorldOpType.Destroy:return function(e){const[,t]=e;C(t)}(t)}}function A(e){const t=x.get(e.__type__);t&&t.release(e)}function R(e){i.push(e),e.__JAVELIN_SYSTEM_ID__=0}function M(e,t){E(t);const n=h.findComponent(e,t);if(null===n)throw new Error("Component not found");return n}null===(r=t.systems)||void 0===r||r.forEach(R),p.subscribe((e,t)=>t.forEach(A));const W={addSystem:R,addTopic:function(e){s.push(e)},applyOps:function(e){for(let t=0;t<e.length;t++)D(e[t],!1)},attach:function(t,...n){c.push(v(e.WorldOpType.Attach,t,n))},destroy:function(t){if(d.has(t))return;const n=h.getEntityComponents(t);c.push(v(e.WorldOpType.Detach,t,n),v(e.WorldOpType.Destroy,t)),d.add(t)},detach:function(t,...n){0!==n.length&&(T in n[0]&&(n=n.map(e=>M(t,e))),c.push(v(e.WorldOpType.Detach,t,n)))},get:M,has:function(e,t){return E(t),h.hasComponent(e,t)},id:-1,ops:l,removeSystem:function(e){const t=i.indexOf(e);t>-1&&i.splice(t,1)},removeTopic:function(e){const t=s.indexOf(e);t>-1&&s.splice(t,1)},reserve:function(){return++m},reset:function(){for(o(c),o(l),o(i),d.clear(),y={currentTickData:null,currentTick:0,currentSystem:0},m=0;c.length>0;)a.release(c.pop());for(;l.length>0;)a.release(l.pop());for(let e=0;e<h.archetypes.length;e++){const t=h.archetypes[e];for(let e=0;e<t.signature.length;e++){const n=t.table[e],r=x.get(t.signature[e]);for(let e=0;e<n.length;e++){const t=n[e];null==r||r.release(t)}}}h.clear()},snapshot:function(){return{storage:h.snapshot()}},spawn:function(...t){const n=m++;return c.push(v(e.WorldOpType.Spawn,n),v(e.WorldOpType.Attach,n,t)),n},state:y,storage:h,tick:function(e){for(b.__CURRENT_WORLD__=I,y.currentTickData=e;l.length>0;)a.release(l.pop());for(let e=0;e<c.length;e++)D(c[e]);o(c);for(let e=0;e<s.length;e++)s[e].flush();for(let e=0;e<i.length;e++){const t=i[e];W.state.currentSystem=t.__JAVELIN_SYSTEM_ID__,t(W)}d.clear(),y.currentTick++},tryGet:function(e,t){return E(t),h.findComponent(e,t)},attached:u,detached:p,spawned:f,destroyed:_,internalSpawn:k,internalAttach:O,internalDetach:S,internalDestroy:C};let I=W.id=b.__WORLDS__.push(W)-1;return W},e.effInterval=W,e.effJson=J,e.effMonitor=L,e.effObserve=U,e.effRef=R,e.effRequest=F,e.effTimer=M,e.effTrigger=N,e.globals=b,e.isComponentOf=function(e,t){return e.__type__===t[T]},e.mapOf=e=>({__kind__:s.Map,__type__:e}),e.modelChanged=k,e.number=c,e.queryMatchesArchetype=I,e.registerComponentType=E,e.string=l,Object.defineProperty(e,"__esModule",{value:!0})}));
