!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Javelin={})}(this,(function(t){"use strict";function e(t){const e=[],n=[],o=[],r=t.length,c=t.reduce((t,e,n)=>(t[e]=n,t),[]);const p=[];return{entities:n,forEach:function(t){for(let o=0;o<n.length;o++){const c=o*r;for(let t=0;t<r;t++)p[t]=e[c+t];t(n[o],p)}},get:function(n){const c=o[n];if("number"!=typeof c)throw new Error(`Entity ${n} not found in archetype (${t.toString()}).`);const p=c*r,i=p+r,s=[];for(let t=p;t<i;t++)s.push(e[t]);return s},getByType:function(n,p){if("number"!=typeof o[n])throw new Error(`Entity ${n} not found in archetype (${t.toString()}).`);return e[o[n]*r+c[p]]},has:function(t){return void 0!==o[t]},indexByType:c,insert:function(t,r){const p=n.push(t)-1,i=e.length;for(let t=0;t<r.length;t++){const n=r[t];e[i+c[n.type]]=n}o[t]=p},layout:t,layoutSize:r,remove:function(t){const c=o[t];if(c===n.length-1){n.pop();for(let t=0;t<r;t++)e.pop();return}const p=n.pop(),i=o[t]*r;for(let t=i+r-1;t>=i;t--)e[t]=e.pop();n[c]=p,o[p]=c,delete o[t]},table:e}}var n;function o(t){return e=>({componentType:e,componentPredicate:t()})}(n=t.ComponentState||(t.ComponentState={}))[n.Initial=0]="Initial",n[n.Detached=1]="Detached";const r=o(()=>(t,{attached:e})=>e.has(t)),c=o(()=>(t,{isComponentChanged:e})=>e(t)),p=o(()=>({state:e})=>e===t.ComponentState.Detached);function i(t,e,n){const o=[],r=()=>{for(let e=0;e<n;e++)o.push(t())};return{allocate:r,retain:()=>(o.length||r(),o.pop()),release:t=>{o.push(e(t))}}}const s=Symbol("world_storage"),a=Symbol("is_data_type");function u(t){return{...t,[a]:!0}}function l(t){return"object"==typeof t&&null!==t&&t[a]}function f(t,e){for(const n in e){const o=e[n];if(l(o))t[n]=o.create(void 0);else if("type"in o&&l(o.type)){const{type:e,defaultValue:r}=o;t[n]=e.create(r)}else f(t,o)}return t}function y(e,n){e.state=t.ComponentState.Initial;for(const t in n){const o=n[t];if(l(o))o.reset(e,t,void 0);else if("type"in o&&l(o.type)){const{type:n,defaultValue:r}=o;n.reset(e,t,r)}else y(e,o)}return e}function h(e,n){return i(()=>{const n={type:e.type};return Object.defineProperty(n,"state",{value:t.ComponentState.Initial,enumerable:!1,writable:!0}),f(n,e.schema)},t=>y(t,e.schema),n)}function d(...t){}function m(t){for(;t.length>0;)t.pop()}function g(t=0,e=d){return Array(t).fill(void 0).map((t,n)=>e(n))}const C=u({name:"number",create:(t=0)=>t,reset(t,e,n=0){t[e]=n}}),w=u({name:"boolean",create:(t=!1)=>t,reset(t,e,n=!1){t[e]=n}}),S=u({name:"string",create:(t="")=>t,reset(t,e,n=""){t[e]=n}}),b=/^\d+\(\)$/,v=/\d+/;let T={};function O(t,e,n){var o;const r=function(t){let e=T[t];if(!e){e=t.split(".");for(let t=0;t<e.length;t++){const n=e[t];v.test(n)&&(e[t]=Number(n))}T[t]=e}return e}(e),c=r[r.length-1];let p=t;for(let t=0;t<r.length-1;t++)p=p[r[t]];const i="string"==typeof c&&c.match(b),s=i?Number(i[0]):null;"number"==typeof s&&(null===(o=A.get(s))||void 0===o||o.apply(r[r.length-2],n)),p[c]=n}var E;!function(t){t[t.Push=0]="Push",t[t.Pop=1]="Pop",t[t.Shift=2]="Shift",t[t.Unshift=3]="Unshift",t[t.Splice=4]="Splice"}(E||(E={}));const x=new Map([[Array.prototype.push,E.Push],[Array.prototype.pop,E.Pop],[Array.prototype.shift,E.Shift],[Array.prototype.unshift,E.Unshift],[Array.prototype.splice,E.Splice]]),A=new Map([[E.Push,Array.prototype.push],[E.Pop,Array.prototype.pop],[E.Shift,Array.prototype.shift],[E.Unshift,Array.prototype.unshift],[E.Splice,Array.prototype.splice]]);function W(){const t=(({onChange:t})=>{const e=new WeakMap,n=new WeakMap,o=new WeakMap,r=new WeakMap,c=new WeakSet;function p(t,e){const o=n.get(t);return""===o?e.toString():`${o}.${e}`}function i(t,c=t,p=""){let i=o.get(t);return void 0===i&&(i=new Proxy(t,s),o.set(t,i),r.set(i,t),e.set(t,c),n.set(t,p)),i}const s={get(t,n,o){const r=Reflect.get(t,n,o);return"symbol"!=typeof n&&("object"==typeof(c=r)&&null!==c||"function"==typeof c)?i(r,e.get(t),p(t,n)):r;var c},set(n,o,r,i){const s=n[o];return n[o]=r,s===r||c.has(n)||t(e.get(n),n,p(n,o),r),!0},apply(n,o,i){const s=Array.isArray(o),a=r.get(o);let u=x.get(n),l=s&&"number"==typeof u;l&&c.add(a);const f=Reflect.apply(n,o,i);return l&&(t(e.get(a),o,p(a,u+"()"),i),c.delete(o)),f}};return{proxy:function(t){return i(t)},revoke:function(t){const e=o.get(t);o.delete(t),r.delete(e)}}})({onChange(t,e,o,r,c){let p=n.get(t);p||(p=[],n.set(t,p)),c?p.push(o,r,c):p.push(o,r)}}),n=new Map,o=[],r=[];function c(t){let n=function(t){const e=t.length;for(let n=0;n<o.length;n++){const r=o[n],{layout:c}=r;if(c.length!==e)continue;let p=!0;for(let n=0;n<e;n++)if(-1===c.indexOf(t[n].type)){p=!1;break}if(p)return r}return null}(t);return n||(n=e(t.map(t=>t.type)),o.push(n)),n}function p(t){const e=r[t];if(void 0===e)throw new Error("Failed to locate entity. Entity does not exist.");if(null===e)throw new Error("Failed to locate entity. Entity has been removed.");return o[e]}function i(t,e,n){if(t.remove(e),0===n.length)return;const p=c(n);p.insert(e,n),r[e]=o.indexOf(p)}const s=[];function a(t,e){const n=p(t),o=n.get(t);m(s);for(let t=0;t<o.length;t++)s.push(o[t]);for(let t=0;t<e.length;t++){const o=e[t].type;if(n.layout.includes(o))throw new Error(`Cannot attach component with type ${o}: entity already has component of type.`);s.push(e[t])}i(n,t,s)}function u(t,e){l(t,e.map(t=>t.type))}function l(e,o){const r=p(e),c=r.get(e);m(s);for(let e=0;e<c.length;e++){const r=c[e];o.includes(r.type)?(t.revoke(r),n.delete(r)):s.push(r)}i(r,e,s)}function f(t){return p(t).get(t)}function y(e){return t.proxy(e)}return{archetypes:o,clearMutations:function(){n.forEach(m)},create:function(t,e){const n=c(e);return n.insert(t,e),r[t]=o.indexOf(n),t},destroy:function(t){u(t,f(t)),r[t]=null},findComponent:function(t,e){return p(t).getByType(t,e.type)},getComponentMutations:function(t){const e=n.get(t);if(!e)throw new Error("ChangeSet does not exist for component.");return e},getEntityComponents:f,getObservedComponent:y,insert:a,isComponentChanged:function(t){const e=n.get(t);return!!e&&e.length>0},patch:function(t,e,n,o){const r=p(t);if(!r.has(t))return;O(y(r.getByType(t,e)),n,o)},remove:u,removeByTypeIds:l,upsert:function(t,e){const n=p(t);m(s);for(let o=0;o<e.length;o++){const r=e[o],c=r.type;if(void 0===n.indexByType[c])s.push(r);else{const e=y(n.getByType(t,c));Object.assign(e,r)}}s.length>0&&a(t,s)}}}var D;(D=t.WorldOpType||(t.WorldOpType={}))[D.Spawn=0]="Spawn",D[D.Attach=1]="Attach",D[D.Detach=2]="Detach",D[D.Mutate=3]="Mutate",D[D.Destroy=4]="Destroy";t.$isDataType=a,t.$worldStorageKey=s,t.array=t=>u({name:"array",create:(t=[])=>t,reset(t,e,n){void 0!==n?t[e]=n.slice():m(t[e])}}),t.arrayOf=g,t.attached=r,t.boolean=w,t.changed=c,t.createArchetype=e,t.createComponentFilter=o,t.createComponentPool=h,t.createComponentType=function(t){return t},t.createDataType=u,t.createStorage=W,t.createTopic=()=>{const t=[],e=[];return{*[Symbol.iterator](){for(let t=0;t<e.length;t++)yield e[t]},push:e=>t.push(e),pushImmediate:t=>e.push(t),flush:()=>{m(e);for(let n=t.length-1;n>=0;n--)e[n]=t.pop()}}},t.createWorld=(e={})=>{const{systems:n=[],componentPoolSize:o=1e3}=e,r=[],c=[],p=i(()=>[],t=>(m(t),t),1e3),a=new Map,u=W(),l=[],y=new Set,d=new Set;let g=0;function C(e){e.state=t.ComponentState.Detached}function w(e){switch(c.push(e),e[0]){case t.WorldOpType.Spawn:return function(t){const[,e,n]=t;for(let t=0;t<n.length;t++)d.add(n[t]);u.create(e,n)}(e);case t.WorldOpType.Attach:return function(t){const[,e,n]=t;for(let t=0;t<n.length;t++)d.add(n[t]);u.insert(e,n)}(e);case t.WorldOpType.Detach:return function(t){const[,e,n]=t,o=u.getEntityComponents(e);for(let t=0;t<o.length;t++){const e=o[t];n.includes(e.type)&&S(e)}u.removeByTypeIds(e,n)}(e);case t.WorldOpType.Destroy:return function(t){const[,e]=t;y.add(e)}(e)}}function S(t){const e=a.get(t.type);e&&e.release(t)}function b(t){u.getEntityComponents(t).forEach(S),u.destroy(t)}function v(...t){const e=p.retain();for(let n=0;n<t.length;n++)e[n]=t[n];return e}const{getObservedComponent:T,isComponentChanged:O,patch:E}=u,x={[s]:u,addSystem:function(t){n.push(t)},applyOps:function(e){for(let n=0;n<e.length;n++){const o=e[n];if(o[0]===t.WorldOpType.Detach){const[,t,e]=o,n=u.getEntityComponents(t);for(let t=0;t<n.length;t++){const o=n[t];e.includes(o.type)&&C(o)}}else if(o[0]===t.WorldOpType.Destroy){const[,t]=o;u.getEntityComponents(t).forEach(C)}w(o)}},attach:function(e,...n){const o=v(t.WorldOpType.Attach,e,n);r.push(o)},attached:d,component:function(t,...e){l.includes(t)||function(t,e=o){if(l.find(({type:e})=>t.type===e))throw new Error(`Tried to register componentType with type id ${t.type} more than once.`);l.push(t),a.set(t.type,h(t,e))}(t);const n=a.get(t.type),r=n?n.retain():f({type:t.type},t.schema);return t.initialize&&t.initialize(r,...e),r},componentTypes:l,destroy:function(e){const n=v(t.WorldOpType.Destroy,e),o=u.getEntityComponents(e);r.push(n),o.forEach(C)},detach:function(e,...n){const o=n.map(t=>t.type),c=v(t.WorldOpType.Detach,e,o);r.push(c),n.forEach(C)},getComponent:function(t,e){const n=u.findComponent(t,e);if(null===n)throw new Error("Component not found");return n},getObservedComponent:T,isComponentChanged:O,ops:c,patch:E,removeSystem:function(t){const e=n.indexOf(t);e>-1&&n.splice(e,1)},spawn:function(...e){const n=g++,o=v(t.WorldOpType.Spawn,n,e);return r.push(o),n},storage:u,tick:function(t){for(u.clearMutations();c.length>0;)p.release(c.pop());for(y.forEach(b),y.clear(),d.clear();r.length>0;)w(r.pop());for(let e=0;e<n.length;e++)n[e](x,t)},tryGetComponent:function(t,e){return u.findComponent(t,e)}};return x},t.detached=p,t.initializeComponentFromSchema=f,t.isComponentOf=function(t,e){return t.type===e.type},t.isDataType=l,t.mutableEmpty=m,t.mutableRemove=function(t,e){const n=t.indexOf(e);return-1!==n&&(t.splice(n,1),!0)},t.mutableRemoveUnordered=function(t,e){const n=t.length,o=t.indexOf(e);if(-1===o)return!1;const r=t.pop();return o<n-1&&(t[o]=r),!0},t.noop=d,t.number=C,t.query=function(...t){const e=t.map(t=>"componentPredicate"in t?t.componentPredicate:null),n=t.length,o=t.map(t=>"componentType"in t?t.componentType.type:t.type),r=g(n),c=[-1,r],p=[];let i,s,a,u=-1,l=-1;const f={value:c,done:!1};function y(){const{table:t,entities:o,layoutSize:s}=a,u=o.length;t:for(;++l<u;){const a=l*s;for(let o=0;o<n;o++){const n=e[o],c=t[a+p[o]];if(null===n?1===c.state:!1===n(c,i))continue t;r[o]=c}return void(c[0]=o[l])}h()}function h(){t:for(;a=s[++u];){const{indexByType:t}=a;for(let e=0;e<n;e++){const n=t[o[e]];if(void 0===n)continue t;p[e]=n}return l=-1,void y()}f.done=!0}const d={next:()=>(null===a?h():y(),f)},m={[Symbol.iterator]:()=>d};return t=>(i=t,s=t.storage.archetypes,a=null,u=-1,l=-1,f.done=!1,m)},t.resetComponentFromSchema=y,t.string=S,Object.defineProperty(t,"__esModule",{value:!0})}));
