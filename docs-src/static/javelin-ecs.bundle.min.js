!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Javelin={})}(this,(function(e){"use strict";function t(...e){}function n(e){for(;e.length>0;)e.pop()}function o(e){return e.reduce((e,t,n)=>(e[n]=t,e),{})}function r(e){const t=[];for(const n in e){const o=parseInt(n,10);isNaN(o)||(t[o]=e[n])}return t}function s(e){const{signature:t,signatureToIndex:n,entities:o,indices:s,table:i}=function(e){const t="snapshot"in e?e.snapshot:null,n=t?Object.keys(t.indices).map(Number):[],o=t?r(t.indices):[],s=("signature"in e?e.signature.slice():[...e.snapshot.signature]).sort(),i=t?t.table.map(e=>[...e]):s.map(()=>[]),c=s.reduce((e,t,n)=>(e[t]=n,e),[]);return{entities:n,indices:o,signature:s,signatureToIndex:c,table:i}}(e);return{signature:t,signatureToIndex:n,table:i,indices:s,entities:o,insert:function(e,t){for(let e=0;e<t.length;e++){const o=t[e],r=n[o._tid];i[r].push(o)}s[e]=o.push(e)-1},remove:function(e){const t=o.length,n=s[e],r=o.pop();if(delete s[e],n!==t-1){for(const e of i)e[n]=e.pop();o[n]=r,s[r]=n}else for(const e of i)e.pop()}}}var i;(i=e.ComponentState||(e.ComponentState={}))[i.Orphaned=0]="Orphaned",i[i.Attaching=1]="Attaching",i[i.Attached=2]="Attached",i[i.Detaching=3]="Detaching",i[i.Detached=4]="Detached";const c={__WORLDS__:[],__CURRENT_WORLD__:-1};function a(e,t={throw:!1,global:!1}){const{global:n}=t,o=[];let r,s,i,a,l,p=-1;return function(...t){a=c.__CURRENT_WORLD__;const u=c.__WORLDS__[a],h=u.state.currentTick;l=n?0:u.state.currentSystem;let f=o[a];void 0===o[a]&&(f=o[a]=[]);let d=f[l];if(void 0===d&&(d=f[l]={cells:[],cellCount:-1}),!0===n||s!==a&&void 0!==s)p=0;else if(void 0===i||r===h&&i===l)p++;else{let e=f[i];if(-1!==e.cellCount&&e.cellCount!==p)throw new Error(`Failed to execute effect: encountered too ${e.cellCount>p?"few":"many"} hooks this tick`);e.cellCount=p,p=0}let y=d.cells[p];if(y||(y=d.cells[p]={executor:e(u),lockGlobal:!1,lockAsync:!1,lockGlobalTick:-1,state:null}),n&&(y.lockGlobalTick!==u.state.currentTick?(y.lockGlobal=!1,y.lockGlobalTick=u.state.currentTick):y.lockGlobal=!0),y.lockGlobal||y.lockAsync)return y.state;const m=y.executor(...t);var g;return"object"==typeof(g=m)&&null!==g&&"then"in g?(y.lockAsync=!0,m.then(e=>y.state=e).catch(e=>console.error("Uncaught error in effect: "+e.message,e)).then(()=>y.lockAsync=!1)):y.state=m,r=h,s=a,i=l,y.state}}const l=a(()=>{let e=!0;const t={value:null};return n=>(e&&(t.value=n,e=!1),t)}),p=a(()=>{let e,t=0;return(n,o=!1)=>(o&&(t=0,clearTimeout(e)),0===t&&(t=1,e=setTimeout(()=>{t=2},n)),2===t)}),u=a(()=>e=>{const t=l(!1),n=p(e,t.value);return t.value=n,n}),h=a(()=>{let e,t={response:null,error:null,done:!1},n=!1,o=new window.AbortController;return(r,s,i=void 0!==e&&r!==e)=>((null===r||i)&&(o.abort(),o=new AbortController),null===r?t:(i&&(t={response:t.response,error:null,done:!1}),t.done||n||(n=!0,e=r,fetch(r,{...s,signal:o.signal}).then(e=>{t={response:e,error:null,done:!0}}).catch(e=>{t={response:t.response,error:e,done:!0}}).then(()=>{n=!1})),t))}),f=a(()=>{let e;return(...t)=>{const n=l(null),o=h(...t);return o.response&&o.response!==n.value&&(o.response.json().then(t=>{e=t}),n.value=o.response),{...o,response:e||null}}});function d(e){return t=>({componentType:t,componentPredicate:e()})}const y=d(()=>({_cst:t})=>t===e.ComponentState.Attaching),m=d(()=>(e,{isComponentChanged:t})=>t(e)),g=d(()=>({_cst:t})=>t===e.ComponentState.Detached);function C(e,t,n){const o=[],r=()=>{for(let t=0;t<n;t++)o.push(e(s))},s={allocate:r,retain:()=>(o.length||r(),o.pop()),release:e=>{o.push(t(e))}};return s}const b=Symbol("is_data_type");function _(e){return{...e,[b]:!0}}function v(e){return"object"==typeof e&&null!==e&&e[b]}function T(e,t){for(const n in t){const o=t[n];if(v(o))e[n]=o.create(void 0);else if("type"in o&&v(o.type)){const{type:t,defaultValue:r}=o;e[n]=t.create(r)}else T(e,o)}return e}function S(t,n){t._cst=e.ComponentState.Orphaned;for(const e in n){const o=n[e];if(v(o))o.reset(t,e,void 0);else if("type"in o&&v(o.type)){const{type:n,defaultValue:r}=o;n.reset(t,e,r)}else S(t,o)}return t}function w(e){const t={};for(const n in e){const o=e[n];v(o)?t[n]=o.name:"type"in o&&v(o.type)?t[n]=o.type.name:t[n]=w(o)}return t}function k(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e){const o=e[n];if(v(o)){if(t[n]!==o.name)return!1}else if("type"in o&&v(o.type)){if(t[n]!==o.type.name)return!1}else{if(!k(o,t[n]))return!1}}return!0}function A(t){return Object.defineProperties({},{_tid:{value:t.type,writable:!1,enumerable:!1},_cst:{value:e.ComponentState.Orphaned,writable:!0,enumerable:!1}})}function O(e){return{name:e.name,type:e.type,schema:w(e.schema)}}function x(e,t){return C(()=>T(A(e),e.schema),t=>S(t,e.schema),t)}function D(e,t){e._cst=t}function E(e,t){for(let n=0;n<e.length;n++)D(e[n],t)}const W=new WeakMap;class I{constructor(e,t){this.length=-1,this.layout=[],this.predicates=[],this.results=[-1],this.readIndices=[],this.onDone=null,this.onDoneBound=()=>this.onDone(this),this.entityIndex=-1,this.archetypeIndex=-1,this.currentArchetype=null,this.next=()=>(null===this.currentArchetype?this.visitNextArchetype():this.visitNextEntity(),this.iteratorResult),this.predicates=e.map(e=>"componentPredicate"in e?e.componentPredicate:null),this.layout=e.map(e=>"componentType"in e?e.componentType.type:e.type),this.length=e.length,this.iterable={next:this.next},this.iteratorResult={value:this.results,done:!1},this.onDone=t;let n=W.get(e);n||(n=new WeakMap,W.set(e,n)),this.matches=n}reset(){this.entityIndex=-1,this.archetypeIndex=-1,this.currentArchetype=null,this.iteratorResult.done=!1}visitNextArchetype(){const{layout:e,length:t,readIndices:n}=this,o=c.__WORLDS__[c.__CURRENT_WORLD__];e:for(;this.currentArchetype=o.storage.archetypes[++this.archetypeIndex];){const o=this.matches.get(this.currentArchetype);if(o)this.readIndices=o;else{const{signatureToIndex:o}=this.currentArchetype;for(let r=0;r<t;r++){const t=o[e[r]];if(void 0===t)continue e;n[r]=t}this.matches.set(this.currentArchetype,this.readIndices)}return this.entityIndex=-1,void this.visitNextEntity()}this.iteratorResult.done=!0,setTimeout(this.onDoneBound)}visitNextEntity(){var e,t;const{currentArchetype:n,readIndices:o,predicates:r}=this,s=c.__WORLDS__[c.__CURRENT_WORLD__],{table:i,entities:a}=n,l=a.length;e:for(;++this.entityIndex<l;){this.results[0]=a[this.entityIndex];for(let n=0;n<this.length;n++){const c=i[o[n]][this.entityIndex];if(!(null!==(t=null===(e=r[n])||void 0===e?void 0:e.call(r,c,s))&&void 0!==t?t:2===c._cst))continue e;this.results[n+1]=c}return}this.visitNextArchetype()}}const R=_({name:"number",create:(e=0)=>e,reset(e,t,n=0){e[t]=n}}),M=_({name:"boolean",create:(e=!1)=>e,reset(e,t,n=!1){e[t]=n}}),N=_({name:"string",create:(e="")=>e,reset(e,t,n=""){e[t]=n}}),P=/^\d+\(\)$/,j=/\d+/;let U={};function L(e,t,n){var o;const r=function(e){let t=U[e];if(!t){t=e.split(".");for(let e=0;e<t.length;e++){const n=t[e];j.test(n)&&(t[e]=Number(n))}U[e]=t}return t}(t),s=r[r.length-1];let i=e;for(let e=0;e<r.length-1;e++)i=i[r[e]];const c="string"==typeof s&&s.match(P),a=c?Number(c[0]):null;"number"==typeof a&&(null===(o=G.get(a))||void 0===o||o.apply(r[r.length-2],n)),i[s]=n}var B;!function(e){e[e.Push=0]="Push",e[e.Pop=1]="Pop",e[e.Shift=2]="Shift",e[e.Unshift=3]="Unshift",e[e.Splice=4]="Splice"}(B||(B={}));const F=new Map([[Array.prototype.push,B.Push],[Array.prototype.pop,B.Pop],[Array.prototype.shift,B.Shift],[Array.prototype.unshift,B.Unshift],[Array.prototype.splice,B.Splice]]),G=new Map([[B.Push,Array.prototype.push],[B.Pop,Array.prototype.pop],[B.Shift,Array.prototype.shift],[B.Unshift,Array.prototype.unshift],[B.Splice,Array.prototype.splice]]);function z(e={}){const t=(({onChange:e})=>{const t=new WeakMap,n=new WeakMap,o=new WeakMap,r=new WeakMap,s=new WeakSet;function i(e,t){const o=n.get(e);return""===o?t.toString():`${o}.${t}`}function c(e,s=e,i=""){let c=o.get(e);return void 0===c&&(c=new Proxy(e,a),o.set(e,c),r.set(c,e),t.set(e,s),n.set(e,i)),c}const a={get(e,n,o){const r=Reflect.get(e,n,o);return"symbol"!=typeof n&&("object"==typeof(s=r)&&null!==s||"function"==typeof s)?c(r,t.get(e),i(e,n)):r;var s},set(n,o,r,c){const a=n[o];return n[o]=r,a===r||s.has(n)||"symbol"==typeof o||e(t.get(n),n,i(n,o),r),!0},apply(n,o,c){const a=Array.isArray(o),l=r.get(o);let p=F.get(n),u=a&&"number"==typeof p;u&&s.add(l);const h=Reflect.apply(n,o,c);return u&&(e(t.get(l),o,i(l,p+"()"),c),s.delete(o)),h}};return{proxy:function(e){return c(e)},revoke:function(e){const t=o.get(e);o.delete(e),r.delete(t)}}})({onChange(e,t,n,o,s){let i=r.get(e);i||(i=[],r.set(e,i)),s?i.push(n,o,s):i.push(n,o)}}),r=new Map,i=e.snapshot?e.snapshot.archetypes.map(e=>s({snapshot:e})):[],c=[];function a(e){let t=function(e){const t=e.length;for(let n=0;n<i.length;n++){const o=i[n],{signature:r}=o;if(r.length!==t)continue;let s=!0;for(let n=0;n<t;n++)if(-1===r.indexOf(e[n]._tid)){s=!1;break}if(s)return o}return null}(e);return t||(t=s({signature:e.map(e=>e._tid)}),i.push(t)),t}function l(e){const t=c[e];if(void 0===t)throw new Error("Failed to locate entity. Entity does not exist.");if(null===t)throw new Error("Failed to locate entity. Entity has been removed.");return i[t]}function p(e,t,n){if(e.remove(t),0===n.length)return;const o=a(n);o.insert(t,n),c[t]=i.indexOf(o)}function u(e,t){const n=l(e),o=n.indices[e];let r=t.slice();for(let e=0;e<n.signature.length;e++){const s=n.signature[e];if(t.find(e=>e._tid===s))throw new Error(`Cannot attach component with type ${s} â€” entity already has component of type.`);r.push(n.table[e][o])}p(n,e,r)}function h(e,t){f(e,t.map(e=>e._tid))}function f(e,n){const o=l(e),s=o.indices[e];let i=[];for(let e=0;e<o.signature.length;e++){const c=o.signature[e],a=o.table[e][s];n.includes(c)?(t.revoke(a),r.delete(a)):i.push(a)}p(o,e,i)}const d=[];function y(e,t){const n=l(e),o=n.signatureToIndex[t];if(void 0===o)return null;const r=n.indices[e];return n.table[o][r]}function m(e){const t=l(e),n=t.indices[e],o=[];for(let e=0;e<t.table.length;e++)o.push(t.table[e][n]);return o}function g(e){return t.proxy(e)}return{archetypes:i,clear:function(){r.clear(),n(i),n(c)},clearMutations:function(){r.forEach(n)},create:function(e,t){const n=a(t);return n.insert(e,t),c[e]=i.indexOf(n),e},destroy:function(e){h(e,m(e)),c[e]=null},findComponent:function(e,t){return y(e,t.type)},findComponentByComponentTypeId:y,getComponentMutations:function(e){const t=r.get(e);if(!t)throw new Error("ChangeSet does not exist for component.");return t},getEntityComponents:m,getObservedComponent:g,insert:u,isComponentChanged:function(e){const t=r.get(e);return!!t&&t.length>0},patch:function(e,t,n,o){const r=l(e),s=r.indices[e],i=r.signatureToIndex[t];if(void 0===i)return;L(g(r.table[i][s]),n,o)},remove:h,removeByTypeIds:f,snapshot:function(){return{archetypes:i.map(e=>({signature:e.signature.slice(),table:e.table.map(e=>e.map(e=>({...e}))),indices:o(e.indices)}))}},upsert:function(e,t){const o=l(e),r=o.indices[e];n(d);for(let e=0;e<t.length;e++){const n=t[e],s=o.signatureToIndex[n._tid];if(void 0===s)d.push(n);else{const e=g(o.table[s][r]);Object.assign(e,n)}}d.length>0&&u(e,d)}}}var $;($=e.WorldOpType||(e.WorldOpType={}))[$.Spawn=0]="Spawn",$[$.Attach=1]="Attach",$[$.Detach=2]="Detach",$[$.Mutate=3]="Mutate",$[$.Destroy=4]="Destroy",e.$isDataType=b,e.array=e=>_({name:"array",create:(e=[])=>e,reset(e,t,o){void 0!==o?e[t]=o.slice():n(e[t])}}),e.arrayOf=function(e=0,n=t){return Array(e).fill(void 0).map((e,t)=>n(t))},e.attached=y,e.boolean=M,e.changed=m,e.createArchetype=s,e.createComponentBase=A,e.createComponentFilter=d,e.createComponentPool=x,e.createComponentType=function(e){return e},e.createDataType=_,e.createEffect=a,e.createStorage=z,e.createTopic=()=>{const e=[],t=[];return{*[Symbol.iterator](){for(let e=0;e<t.length;e++)yield t[e]},push:t=>e.push(t),pushImmediate:e=>t.push(e),flush:()=>{n(t);for(let n=e.length-1;n>=0;n--)t[n]=e.pop()}}},e.createWorld=function(t={}){var o,r;const{componentPoolSize:s=1e3}=t,i=[],a=[],l=C(()=>[],e=>(n(e),e),1e3),p=[],u=new Map,h=z({snapshot:null===(o=t.snapshot)||void 0===o?void 0:o.storage}),f=new Set,d=new Map,y=[],m=[],g=new WeakMap;let b={currentTickData:null,currentTick:0,currentSystem:0},_=0,v=0;function T(t,n=!0){switch(!0===n&&a.push(t),t[0]){case e.WorldOpType.Spawn:return function(t){const[,n,o]=t;E(o,e.ComponentState.Attaching),y.push(o),h.create(n,o)}(t);case e.WorldOpType.Attach:return function(t){const[,n,o]=t;E(o,e.ComponentState.Attaching),y.push(o),h.insert(n,o)}(t);case e.WorldOpType.Detach:return function(t){const[,n,o]=t;for(let t=0;t<o.length;t++){D(h.findComponentByComponentTypeId(n,o[t]),e.ComponentState.Detached)}d.set(n,o)}(t);case e.WorldOpType.Destroy:return function(t){const[,n]=t;E(h.getEntityComponents(n),e.ComponentState.Detached),f.add(n)}(t)}}function S(e){const t=u.get(e._tid);t&&t.release(e)}function w(e){h.getEntityComponents(e).forEach(S),h.destroy(e)}function A(e,t){for(let n=0;n<e.length;n++){S(h.findComponentByComponentTypeId(t,e[n]))}h.removeByTypeIds(t,e)}function W(){for(h.clearMutations();a.length>0;)l.release(a.pop());for(;y.length>0;)E(y.pop(),e.ComponentState.Attached);for(d.forEach(A),d.clear(),f.forEach(w),f.clear();i.length>0;)T(i.pop())}function I(e){m.push(e),g.set(e,v++)}function R(...e){const t=l.retain();for(let n=0;n<e.length;n++)t[n]=e[n];return t}null===(r=t.systems)||void 0===r||r.forEach(I);const{getObservedComponent:M,isComponentChanged:N,patch:P}=h,j={addSystem:I,applyOps:function(t){for(let n=0;n<t.length;n++){const o=t[n];switch(o[0]){case e.WorldOpType.Detach:{const[,t,n]=o,r=n.map(e=>h.findComponentByComponentTypeId(t,e));for(let t=0;t<r.length;t++){const n=r[t];n&&D(n,e.ComponentState.Detaching)}break}case e.WorldOpType.Destroy:{const[,t]=o;E(h.getEntityComponents(t),e.ComponentState.Detaching);break}}T(o,!1)}},attach:function(t,...n){const o=R(e.WorldOpType.Attach,t,n);i.push(o)},component:function(e,...n){p.includes(e)||function(e,n=s){if(p.find(({type:t})=>e.type===t))throw new Error("Failed to register component type: a componentType with same id is already registered");if(t.snapshot){const n=t.snapshot.componentTypes.find(t=>t.type===e.type);if(n&&!k(e.schema,n.schema))throw new Error("Failed to register component type: component type schema does not match world snapshot")}p.push(e),u.set(e.type,x(e,n))}(e);const o=u.get(e.type).retain();return e.initialize&&e.initialize(o,...n),o},componentTypes:p,destroy:function(t){const n=R(e.WorldOpType.Destroy,t);E(h.getEntityComponents(t),e.ComponentState.Detaching),i.push(n)},detach:function(t,...n){const o=n.map(e=>e._tid),r=R(e.WorldOpType.Detach,t,o);E(n,e.ComponentState.Detaching),i.push(r)},getComponent:function(e,t){const n=h.findComponent(e,t);if(null===n)throw new Error("Component not found");return n},getObservedComponent:M,id:-1,isComponentChanged:N,ops:a,patch:P,removeSystem:function(e){const t=m.indexOf(e);t>-1&&(m.splice(t,1),g.delete(e))},reset:function(){for(n(i),n(a),n(p),n(m),n(y),u.clear(),f.clear(),d.clear(),b={currentTickData:null,currentTick:0,currentSystem:0},_=0;i.length>0;)l.release(i.pop());for(;a.length>0;)l.release(a.pop());for(let e=0;e<h.archetypes.length;e++){const t=h.archetypes[e];for(let e=0;e<t.signature.length;e++){const n=t.table[e],o=u.get(t.signature[e]);for(let e=0;e<n.length;e++){const t=n[e];null==o||o.release(t)}}}h.clear()},snapshot:function(){return{componentTypes:p.map(O),storage:h.snapshot()}},spawn:function(...t){const n=_++,o=R(e.WorldOpType.Spawn,n,t);return i.push(o),n},state:b,storage:h,tick:function(e){c.__CURRENT_WORLD__=U,b.currentTickData=e,0===b.currentTick&&W(),W();for(let e=0;e<m.length;e++){const t=m[e];j.state.currentSystem=g.get(t),t(j)}b.currentTick++},tryGetComponent:function(e,t){return h.findComponent(e,t)}};let U=j.id=c.__WORLDS__.push(j)-1;return j},e.detached=g,e.flagComponent=D,e.flagComponents=E,e.initializeComponentFromSchema=T,e.interval=u,e.isComponentOf=function(e,t){return e._tid===t.type},e.isDataType=v,e.json=f,e.mutableEmpty=n,e.mutableRemove=function(e,t){const n=e.indexOf(t);return-1!==n&&(e.splice(n,1),!0)},e.mutableRemoveUnordered=function(e,t){const n=e.length,o=e.indexOf(t);if(-1===o)return!1;const r=e.pop();return o<n-1&&(e[o]=r),!0},e.noop=t,e.number=R,e.packSparseArray=o,e.query=function(...e){const t=C(t=>new I(e,t.release),e=>(e.reset(),e),1e3);return{[Symbol.iterator]:()=>t.retain().iterable}},e.ref=l,e.request=h,e.resetComponentFromSchema=S,e.schemaEqualsSerializedSchema=k,e.serializeComponentType=O,e.serializeSchema=w,e.string=N,e.timer=p,e.unpackSparseArray=r,Object.defineProperty(e,"__esModule",{value:!0})}));
