!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Javelin={})}(this,(function(t){"use strict";function e(t){const e=t.length,n=[],o=[],r=[];for(let t=0;t<e;t++)n[t]=[];let c=-1;return{layout:t,table:n,indices:r,entities:o,insert:function(e,i){c++;for(let e=0;e<i.length;e++){const o=i[e],r=t.indexOf(o.type);n[r][c]=o}o[c]=e,r[e]=c},remove:function(t){const e=r[t];if(e===c)for(const t of n)t[c]=null;else for(const t of n)t[e]=t[c],t[c]=null;o[e]=o[c],r[o[c]]=e,r[t]=-1,o.pop(),c--}}}function n(t){return e=>({componentType:e,componentPredicate:t()})}const o=n(()=>(t,{attached:e})=>e.has(t)),r=n(()=>(t,{isComponentChanged:e})=>e(t)),c=Symbol("world_storage"),i=Symbol("is_data_type"),s=Symbol("detached"),p=n(()=>t=>!0===t[s]);function a(t,e,n){const o=[],r=()=>{for(let e=0;e<n;e++)o.push(t())};return{allocate:r,retain:()=>(o.length||r(),o.pop()),release:t=>{o.push(e(t))}}}function l(t){return{...t,[i]:!0}}function u(t){return"object"==typeof t&&null!==t&&t[i]}function f(t,e){for(const n in e){const o=e[n];if(u(o))t[n]=o.create(void 0);else if("type"in o&&u(o.type)){const{type:e,defaultValue:r}=o;t[n]=e.create(r)}else f(t,o)}return t}function y(t,e){t[s]=!1;for(const n in e){const o=e[n];if(u(o))o.reset(t,n,void 0);else if("type"in o&&u(o.type)){const{type:e,defaultValue:r}=o;e.reset(t,n,r)}else y(t,o)}return t}function h(t,e){return a(()=>f({[s]:!1,type:t.type},t.schema),e=>y(e,t.schema),e)}function d(...t){}function m(t){for(;t.length>0;)t.pop()}function g(t=0,e=d){return Array(t).fill(void 0).map((t,n)=>e(n))}const b=l({name:"number",create:(t=0)=>t,reset(t,e,n=0){t[e]=n}}),w=l({name:"boolean",create:(t=!1)=>t,reset(t,e,n=!1){t[e]=n}}),C=l({name:"string",create:(t="")=>t,reset(t,e,n=""){t[e]=n}}),O=/^\d+\(\)$/,v=/\d+/;let S={};function T(t,e,n){var o;const r=function(t){let e=S[t];if(!e){e=t.split(".");for(let t=0;t<e.length;t++){const n=e[t];v.test(n)&&(e[t]=Number(n))}S[t]=e}return e}(e),c=r[r.length-1];let i=t;for(let t=0;t<r.length-1;t++)i=i[r[t]];const s="string"==typeof c&&c.match(O),p=s?Number(s[0]):null;"number"==typeof p&&(null===(o=A.get(p))||void 0===o||o.apply(r[r.length-2],n)),i[c]=n}var E;!function(t){t[t.Push=0]="Push",t[t.Pop=1]="Pop",t[t.Shift=2]="Shift",t[t.Unshift=3]="Unshift",t[t.Splice=4]="Splice"}(E||(E={}));const x=new Map([[Array.prototype.push,E.Push],[Array.prototype.pop,E.Pop],[Array.prototype.shift,E.Shift],[Array.prototype.unshift,E.Unshift],[Array.prototype.splice,E.Splice]]),A=new Map([[E.Push,Array.prototype.push],[E.Pop,Array.prototype.pop],[E.Shift,Array.prototype.shift],[E.Unshift,Array.prototype.unshift],[E.Splice,Array.prototype.splice]]);function W(){const t=(({onChange:t})=>{const e=new WeakMap,n=new WeakMap,o=new WeakMap,r=new WeakMap,c=new WeakSet;function i(t,e){const o=n.get(t);return""===o?e.toString():`${o}.${e}`}function s(t,c=t,i=""){let s=o.get(t);return void 0===s&&(s=new Proxy(t,p),o.set(t,s),r.set(s,t),e.set(t,c),n.set(t,i)),s}const p={get(t,n,o){const r=Reflect.get(t,n,o);return"symbol"!=typeof n&&("object"==typeof(c=r)&&null!==c||"function"==typeof c)?s(r,e.get(t),i(t,n)):r;var c},set(n,o,r,s){const p=n[o];return n[o]=r,p===r||c.has(n)||t(e.get(n),n,i(n,o),r),!0},apply(n,o,s){const p=Array.isArray(o),a=r.get(o);let l=x.get(n),u=p&&"number"==typeof l;u&&c.add(a);const f=Reflect.apply(n,o,s);return u&&(t(e.get(a),o,i(a,l+"()"),s),c.delete(o)),f}};return{proxy:function(t){return s(t)},revoke:function(t){const e=o.get(t);o.delete(t),r.delete(e)}}})({onChange(t,e,o,r,c){let i=n.get(t);i||(i=[],n.set(t,i)),c?i.push(o,r,c):i.push(o,r)}}),n=new Map,o=[],r=[];function c(t){let n=function(t){const e=t.length;for(let n=0;n<o.length;n++){const r=o[n],{layout:c}=r;if(c.length!==e)continue;let i=!0;for(let n=0;n<e;n++)if(-1===c.indexOf(t[n].type)){i=!1;break}if(i)return r}return null}(t);return n||(n=e(t.map(t=>t.type)),o.push(n)),n}function i(t){const e=r[t];if(void 0===e)throw new Error("Failed to locate entity. Entity does not exist.");if(null===e)throw new Error("Failed to locate entity. Entity has been removed.");return o[e]}function s(t,e,n){if(t.remove(e),0===n.length)return;const i=c(n);i.insert(e,n),r[e]=o.indexOf(i)}function p(t,e){const n=i(t),o=n.indices[t];let r=e.slice();for(let t=0;t<n.layout.length;t++){const c=n.layout[t];if(e.find(t=>t.type===c))throw new Error(`Cannot attach component with type ${c} â€” entity already has component of type.`);r.push(n.table[t][o])}s(n,t,r)}function a(t,e){l(t,e.map(t=>t.type))}function l(e,o){const r=i(e),c=r.indices[e];let p=[];for(let e=0;e<r.layout.length;e++){const i=r.layout[e],s=r.table[e][c];o.includes(i)?(t.revoke(s),n.delete(s)):p.push(s)}s(r,e,p)}const u=[];function f(t){const e=i(t),n=e.indices[t],o=[];for(let t=0;t<e.table.length;t++)o.push(e.table[t][n]);return o}function y(e){return t.proxy(e)}return{archetypes:o,clearMutations:function(){n.forEach(m)},create:function(t,e){const n=c(e);return n.insert(t,e),r[t]=o.indexOf(n),t},destroy:function(t){a(t,f(t)),r[t]=null},findComponent:function(t,e){const n=i(t),o=n.layout.indexOf(e.type);if(-1===o)return null;const r=n.indices[t];return n.table[o][r]},getComponentMutations:function(t){const e=n.get(t);if(!e)throw new Error("ChangeSet does not exist for component.");return e},getEntityComponents:f,getObservedComponent:y,insert:p,isComponentChanged:function(t){const e=n.get(t);return!!e&&e.length>0},patch:function(t,e,n,o){const r=i(t),c=r.indices[t],s=r.layout.indexOf(e);if(-1===s)return;T(y(r.table[s][c]),n,o)},remove:a,removeByTypeIds:l,upsert:function(t,e){const n=i(t),o=n.indices[t];m(u);for(let t=0;t<e.length;t++){const r=e[t],c=n.layout.indexOf(r.type);if(-1===c)u.push(r);else{const t=y(n.table[c][o]);Object.assign(t,r)}}u.length>0&&p(t,u)}}}var P;(P=t.WorldOpType||(t.WorldOpType={}))[P.Spawn=0]="Spawn",P[P.Attach=1]="Attach",P[P.Detach=2]="Detach",P[P.Mutate=3]="Mutate",P[P.Destroy=4]="Destroy";t.$detached=s,t.$isDataType=i,t.$worldStorageKey=c,t.array=t=>l({name:"array",create:(t=[])=>t,reset(t,e,n){void 0!==n?t[e]=n.slice():m(t[e])}}),t.arrayOf=g,t.attached=o,t.boolean=w,t.changed=r,t.createArchetype=e,t.createComponentFilter=n,t.createComponentPool=h,t.createComponentType=function(t){return t},t.createDataType=l,t.createStorage=W,t.createTopic=()=>{const t=[],e=[];return{*[Symbol.iterator](){for(let t=0;t<e.length;t++)yield e[t]},push:e=>t.push(e),pushImmediate:t=>e.push(t),flush:()=>{m(e);for(let n=t.length-1;n>=0;n--)e[n]=t.pop()}}},t.createWorld=(e={})=>{const{systems:n=[],componentPoolSize:o=1e3}=e,r=[],i=[],p=a(()=>[],t=>(m(t),t),1e3),l=new Map,u=W(),y=[],d=new Set,g=new Set;let b=0;function w(t){t[s]=!0}function C(e){switch(i.push(e),e[0]){case t.WorldOpType.Spawn:return function(t){const[,e,n]=t;for(let t=0;t<n.length;t++)g.add(n[t]);u.create(e,n)}(e);case t.WorldOpType.Attach:return function(t){const[,e,n]=t;for(let t=0;t<n.length;t++)g.add(n[t]);u.insert(e,n)}(e);case t.WorldOpType.Detach:return function(t){const[,e,n]=t,o=u.getEntityComponents(e);for(let t=0;t<o.length;t++){const e=o[t];n.includes(e.type)&&O(e)}u.removeByTypeIds(e,n)}(e);case t.WorldOpType.Destroy:return function(t){const[,e]=t;d.add(e)}(e)}}function O(t){const e=l.get(t.type);e&&e.release(t)}function v(t){u.getEntityComponents(t).forEach(O),u.destroy(t)}function S(...t){const e=p.retain();for(let n=0;n<t.length;n++)e[n]=t[n];return e}const{getObservedComponent:T,isComponentChanged:E,patch:x}=u,A={[c]:u,addSystem:function(t){n.push(t)},applyOps:function(e){for(let n=0;n<e.length;n++){const o=e[n];if(o[0]===t.WorldOpType.Detach){const[,t,e]=o,n=u.getEntityComponents(t);for(let t=0;t<n.length;t++){const o=n[t];e.includes(o.type)&&w(o)}}else if(o[0]===t.WorldOpType.Destroy){const[,t]=o;u.getEntityComponents(t).forEach(w)}C(o)}},attach:function(e,...n){const o=S(t.WorldOpType.Attach,e,n);r.push(o)},attached:g,component:function(t,...e){y.includes(t)||function(t,e=o){if(y.find(({type:e})=>t.type===e))throw new Error(`Tried to register componentType with type id ${t.type} more than once.`);y.push(t),l.set(t.type,h(t,e))}(t);const n=l.get(t.type),r=n?n.retain():f({type:t.type},t.schema);return t.initialize&&t.initialize(r,...e),r},componentTypes:y,destroy:function(e){const n=S(t.WorldOpType.Destroy,e),o=u.getEntityComponents(e);r.push(n),o.forEach(w)},detach:function(e,...n){const o=n.map(t=>t.type),c=S(t.WorldOpType.Detach,e,o);r.push(c),n.forEach(w)},getComponent:function(t,e){const n=u.findComponent(t,e);if(null===n)throw new Error("Component not found");return n},getObservedComponent:T,isComponentChanged:E,ops:i,patch:x,removeSystem:function(t){const e=n.indexOf(t);e>-1&&n.splice(e,1)},spawn:function(...e){const n=b++,o=S(t.WorldOpType.Spawn,n,e);return r.push(o),n},tick:function(t){for(u.clearMutations();i.length>0;)p.release(i.pop());for(d.forEach(v),d.clear(),g.clear();r.length>0;)C(r.pop());for(let e=0;e<n.length;e++)n[e](A,t)},tryGetComponent:function(t,e){return u.findComponent(t,e)}};return A},t.detached=p,t.initializeComponentFromSchema=f,t.isComponentOf=function(t,e){return t.type===e.type},t.isDataType=u,t.mutableEmpty=m,t.mutableRemove=function(t,e){const n=t.indexOf(e);return-1!==n&&(t.splice(n,1),!0)},t.mutableRemoveUnordered=function(t,e){const n=t.length,o=t.indexOf(e);if(-1===o)return!1;const r=t.pop();return o<n-1&&(t[o]=r),!0},t.noop=d,t.number=b,t.query=function(...t){const e=t.map(t=>"componentPredicate"in t?t.componentPredicate:null),n=t.length,o=t.map(t=>"componentType"in t?t.componentType.type:t.type),r=g(n),i=[-1,r],p=[];let a,l,u,f=-1,y=-1;const h={value:i,done:!1};function d(){const{table:t,entities:o}=u,[c]=t;t:for(;c[++y];){i[0]=o[y];for(let o=0;o<n;o++){const n=e[o],c=t[p[o]][y];if(n?!1===n(c,a):c[s])continue t;r[o]=c}return}b()}function b(){let t;t:for(;t=l[++f];){const{layout:e}=t;u=t,y=-1;for(let t=0;t<n;t++){const n=e.indexOf(o[t]);if(-1===n)continue t;p[t]=n}return void d()}h.done=!0,i[0]=-1,m(r)}const w={next:()=>(null===u?b():d(),h)},C={[Symbol.iterator]:()=>w};return t=>(a=t,l=t[c].archetypes,u=null,f=-1,y=-1,h.done=!1,C)},t.resetComponentFromSchema=y,t.string=C,Object.defineProperty(t,"__esModule",{value:!0})}));
