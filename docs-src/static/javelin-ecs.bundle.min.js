!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Javelin={})}(this,(function(t){"use strict";function e(t){const e=t.length,n=[],o=[],r=[],c=t.reduce((t,e,n)=>(t[e]=n,t),[]);for(let t=0;t<e;t++)n[t]=[];return{layout:t,layoutInverse:c,table:n,indices:r,entities:o,insert:function(t,e){for(let t=0;t<e.length;t++){const o=e[t],r=c[o._tid];n[r].push(o)}r[t]=o.push(t)-1},remove:function(t){const e=o.length,c=r[t],i=o.pop();if(r[t]=-1,c!==e-1){for(const t of n)t[c]=t.pop();o[c]=i,r[i]=c}else for(const t of n)t.pop()}}}var n;(n=t.ComponentState||(t.ComponentState={}))[n.Orphaned=0]="Orphaned",n[n.Attaching=1]="Attaching",n[n.Attached=2]="Attached",n[n.Detaching=3]="Detaching",n[n.Detached=4]="Detached";const o={__WORLDS__:[],__CURRENT_WORLD__:-1};function r(t,e={throw:!1,global:!1}){const{global:n}=e,r=[];let c,i,s,l,a,u=-1;return function(...e){l=o.__CURRENT_WORLD__;const p=o.__WORLDS__[l],h=p.state.currentTick;a=n?0:p.state.currentSystem;let f=r[l];void 0===r[l]&&(f=r[l]=[]);let y=f[a];if(void 0===y&&(y=f[a]={cells:[],cellCount:-1}),!0===n||i!==l&&void 0!==i)u=0;else if(void 0===s||c===h&&s===a)u++;else{let t=f[s];if(-1!==t.cellCount&&t.cellCount!==u)throw new Error(`Failed to execute effect: encountered too ${t.cellCount>u?"few":"many"} hooks this tick`);t.cellCount=u,u=0}let d=y.cells[u];if(d||(d=y.cells[u]={executor:t(p),lockGlobal:!1,lockAsync:!1,lockGlobalTick:-1,state:null}),n&&(d.lockGlobalTick!==p.state.currentTick?(d.lockGlobal=!1,d.lockGlobalTick=p.state.currentTick):d.lockGlobal=!0),d.lockGlobal||d.lockAsync)return d.state;const m=d.executor(...e);var g;return"object"==typeof(g=m)&&null!==g&&"then"in g?(d.lockAsync=!0,m.then(t=>d.state=t).catch(t=>console.error("Uncaught error in effect: "+t.message,t)).then(()=>d.lockAsync=!1)):d.state=m,c=h,i=l,s=a,d.state}}const c=r(()=>{let t=!0;const e={value:null};return n=>(t&&(e.value=n,t=!1),e)}),i=r(()=>{let t,e=0;return(n,o=!1)=>(o&&(e=0,clearTimeout(t)),0===e&&(e=1,t=setTimeout(()=>{e=2},n)),2===e)}),s=r(()=>t=>{const e=c(!1),n=i(t,e.value);return e.value=n,n}),l=r(()=>{let t,e={response:null,error:null,done:!1},n=!1,o=new window.AbortController;return(r,c,i=void 0!==t&&r!==t)=>null===r?e:(i&&(e={response:e.response,error:null,done:!1},o.abort(),o=new AbortController),e.done||n||(n=!0,t=r,fetch(r,{...c,signal:o.signal}).then(t=>{e={response:t,error:null,done:!0}}).catch(t=>{e={response:e.response,error:t,done:!0}}).then(()=>{n=!1})),e)}),a=r(()=>{let t;return(...e)=>{const n=c(null),o=l(...e);return o.response&&o.response!==n.value&&(o.response.json().then(e=>{t=e}),n.value=o.response),{...o,response:t||null}}});function u(t){return e=>({componentType:e,componentPredicate:t()})}const p=u(()=>({_cst:e})=>e===t.ComponentState.Attaching),h=u(()=>(t,{isComponentChanged:e})=>e(t)),f=u(()=>({_cst:e})=>e===t.ComponentState.Detached);function y(t,e,n){const o=[],r=()=>{for(let e=0;e<n;e++)o.push(t(c))},c={allocate:r,retain:()=>(o.length||r(),o.pop()),release:t=>{o.push(e(t))}};return c}const d=Symbol("is_data_type");function m(t){return{...t,[d]:!0}}function g(t){return"object"==typeof t&&null!==t&&t[d]}function C(t,e){for(const n in e){const o=e[n];if(g(o))t[n]=o.create(void 0);else if("type"in o&&g(o.type)){const{type:e,defaultValue:r}=o;t[n]=e.create(r)}else C(t,o)}return t}function _(e,n){e._cst=t.ComponentState.Orphaned;for(const t in n){const o=n[t];if(g(o))o.reset(e,t,void 0);else if("type"in o&&g(o.type)){const{type:n,defaultValue:r}=o;n.reset(e,t,r)}else _(e,o)}return e}function v(e){return Object.defineProperties({},{_tid:{value:e.type,writable:!1,enumerable:!0},_cst:{value:t.ComponentState.Orphaned,writable:!0,enumerable:!1}})}function b(t,e){return y(()=>C(v(t),t.schema),e=>_(e,t.schema),e)}function T(t,e){t._cst=e}function S(t,e){for(let n=0;n<t.length;n++)T(t[n],e)}class w{constructor(t,e){this.queryLength=-1,this.queryLayout=[],this.componentFilterPredicates=[],this.queryResult=[-1],this.readIndices=[],this.onDone=null,this.onDoneBound=()=>this.onDone(this),this.entityIndex=-1,this.archetypeIndex=-1,this.currentArchetype=null,this.next=()=>(null===this.currentArchetype?this.visitNextArchetype():this.visitNextEntity(),this.iteratorResult),this.componentFilterPredicates=t.map(t=>"componentPredicate"in t?t.componentPredicate:null),this.queryLayout=t.map(t=>"componentType"in t?t.componentType.type:t.type),this.queryLength=t.length,this.iterable={next:this.next},this.iteratorResult={value:this.queryResult,done:!1},this.onDone=e}reset(){this.entityIndex=-1,this.archetypeIndex=-1,this.currentArchetype=null,this.iteratorResult.done=!1}visitNextArchetype(){const{queryLayout:t,queryLength:e,readIndices:n}=this;t:for(;this.currentArchetype=o.__WORLDS__[o.__CURRENT_WORLD__].storage.archetypes[++this.archetypeIndex];){const{layoutInverse:o}=this.currentArchetype;for(let r=0;r<e;r++){const e=o[t[r]];if(void 0===e)continue t;n[r]=e}return this.entityIndex=-1,void this.visitNextEntity()}this.iteratorResult.done=!0,setTimeout(this.onDoneBound)}visitNextEntity(){var t,e;const{currentArchetype:n,readIndices:r,componentFilterPredicates:c}=this,{table:i,entities:s}=n,l=s.length;t:for(;++this.entityIndex<l;){this.queryResult[0]=s[this.entityIndex];for(let n=0;n<this.queryLength;n++){const s=i[r[n]][this.entityIndex];if(!(null!==(e=null===(t=c[n])||void 0===t?void 0:t.call(c,s,o.__WORLDS__[o.__CURRENT_WORLD__]))&&void 0!==e?e:2===s._cst))continue t;this.queryResult[n+1]=s}return}this.visitNextArchetype()}}function D(...t){}function A(t){for(;t.length>0;)t.pop()}const O=m({name:"number",create:(t=0)=>t,reset(t,e,n=0){t[e]=n}}),k=m({name:"boolean",create:(t=!1)=>t,reset(t,e,n=!1){t[e]=n}}),x=m({name:"string",create:(t="")=>t,reset(t,e,n=""){t[e]=n}}),R=/^\d+\(\)$/,E=/\d+/;let W={};function I(t,e,n){var o;const r=function(t){let e=W[t];if(!e){e=t.split(".");for(let t=0;t<e.length;t++){const n=e[t];E.test(n)&&(e[t]=Number(n))}W[t]=e}return e}(e),c=r[r.length-1];let i=t;for(let t=0;t<r.length-1;t++)i=i[r[t]];const s="string"==typeof c&&c.match(R),l=s?Number(s[0]):null;"number"==typeof l&&(null===(o=M.get(l))||void 0===o||o.apply(r[r.length-2],n)),i[c]=n}var P;!function(t){t[t.Push=0]="Push",t[t.Pop=1]="Pop",t[t.Shift=2]="Shift",t[t.Unshift=3]="Unshift",t[t.Splice=4]="Splice"}(P||(P={}));const L=new Map([[Array.prototype.push,P.Push],[Array.prototype.pop,P.Pop],[Array.prototype.shift,P.Shift],[Array.prototype.unshift,P.Unshift],[Array.prototype.splice,P.Splice]]),M=new Map([[P.Push,Array.prototype.push],[P.Pop,Array.prototype.pop],[P.Shift,Array.prototype.shift],[P.Unshift,Array.prototype.unshift],[P.Splice,Array.prototype.splice]]);function q(){const t=(({onChange:t})=>{const e=new WeakMap,n=new WeakMap,o=new WeakMap,r=new WeakMap,c=new WeakSet;function i(t,e){const o=n.get(t);return""===o?e.toString():`${o}.${e}`}function s(t,c=t,i=""){let s=o.get(t);return void 0===s&&(s=new Proxy(t,l),o.set(t,s),r.set(s,t),e.set(t,c),n.set(t,i)),s}const l={get(t,n,o){const r=Reflect.get(t,n,o);return"symbol"!=typeof n&&("object"==typeof(c=r)&&null!==c||"function"==typeof c)?s(r,e.get(t),i(t,n)):r;var c},set(n,o,r,s){const l=n[o];return n[o]=r,l===r||c.has(n)||"symbol"==typeof o||t(e.get(n),n,i(n,o),r),!0},apply(n,o,s){const l=Array.isArray(o),a=r.get(o);let u=L.get(n),p=l&&"number"==typeof u;p&&c.add(a);const h=Reflect.apply(n,o,s);return p&&(t(e.get(a),o,i(a,u+"()"),s),c.delete(o)),h}};return{proxy:function(t){return s(t)},revoke:function(t){const e=o.get(t);o.delete(t),r.delete(e)}}})({onChange(t,e,o,r,c){let i=n.get(t);i||(i=[],n.set(t,i)),c?i.push(o,r,c):i.push(o,r)}}),n=new Map,o=[],r=[];function c(t){let n=function(t){const e=t.length;for(let n=0;n<o.length;n++){const r=o[n],{layout:c}=r;if(c.length!==e)continue;let i=!0;for(let n=0;n<e;n++)if(-1===c.indexOf(t[n]._tid)){i=!1;break}if(i)return r}return null}(t);return n||(n=e(t.map(t=>t._tid)),o.push(n)),n}function i(t){const e=r[t];if(void 0===e)throw new Error("Failed to locate entity. Entity does not exist.");if(null===e)throw new Error("Failed to locate entity. Entity has been removed.");return o[e]}function s(t,e,n){if(t.remove(e),0===n.length)return;const i=c(n);i.insert(e,n),r[e]=o.indexOf(i)}function l(t,e){const n=i(t),o=n.indices[t];let r=e.slice();for(let t=0;t<n.layout.length;t++){const c=n.layout[t];if(e.find(t=>t._tid===c))throw new Error(`Cannot attach component with type ${c} â€” entity already has component of type.`);r.push(n.table[t][o])}s(n,t,r)}function a(t,e){u(t,e.map(t=>t._tid))}function u(e,o){const r=i(e),c=r.indices[e];let l=[];for(let e=0;e<r.layout.length;e++){const i=r.layout[e],s=r.table[e][c];o.includes(i)?(t.revoke(s),n.delete(s)):l.push(s)}s(r,e,l)}const p=[];function h(t,e){const n=i(t),o=n.layoutInverse[e];if(void 0===o)return null;const r=n.indices[t];return n.table[o][r]}function f(t){const e=i(t),n=e.indices[t],o=[];for(let t=0;t<e.table.length;t++)o.push(e.table[t][n]);return o}function y(e){return t.proxy(e)}return{archetypes:o,clear:function(){n.clear(),A(o),A(r)},clearMutations:function(){n.forEach(A)},create:function(t,e){const n=c(e);return n.insert(t,e),r[t]=o.indexOf(n),t},destroy:function(t){a(t,f(t)),r[t]=null},findComponent:function(t,e){return h(t,e.type)},findComponentByComponentTypeId:h,getComponentMutations:function(t){const e=n.get(t);if(!e)throw new Error("ChangeSet does not exist for component.");return e},getEntityComponents:f,getObservedComponent:y,insert:l,isComponentChanged:function(t){const e=n.get(t);return!!e&&e.length>0},patch:function(t,e,n,o){const r=i(t),c=r.indices[t],s=r.layoutInverse[e];if(void 0===s)return;I(y(r.table[s][c]),n,o)},remove:a,removeByTypeIds:u,upsert:function(t,e){const n=i(t),o=n.indices[t];A(p);for(let t=0;t<e.length;t++){const r=e[t],c=n.layoutInverse[r._tid];if(void 0===c)p.push(r);else{const t=y(n.table[c][o]);Object.assign(t,r)}}p.length>0&&l(t,p)}}}var N;(N=t.WorldOpType||(t.WorldOpType={}))[N.Spawn=0]="Spawn",N[N.Attach=1]="Attach",N[N.Detach=2]="Detach",N[N.Mutate=3]="Mutate",N[N.Destroy=4]="Destroy",t.$isDataType=d,t.array=t=>m({name:"array",create:(t=[])=>t,reset(t,e,n){void 0!==n?t[e]=n.slice():A(t[e])}}),t.arrayOf=function(t=0,e=D){return Array(t).fill(void 0).map((t,n)=>e(n))},t.attached=p,t.boolean=k,t.changed=h,t.createArchetype=e,t.createComponentBase=v,t.createComponentFilter=u,t.createComponentPool=b,t.createComponentType=function(t){return t},t.createDataType=m,t.createEffect=r,t.createStorage=q,t.createTopic=()=>{const t=[],e=[];return{*[Symbol.iterator](){for(let t=0;t<e.length;t++)yield e[t]},push:e=>t.push(e),pushImmediate:t=>e.push(t),flush:()=>{A(e);for(let n=t.length-1;n>=0;n--)e[n]=t.pop()}}},t.createWorld=function(e={}){const{systems:n=[],componentPoolSize:r=1e3}=e,c=[],i=[],s=y(()=>[],t=>(A(t),t),1e3),l=new Map,a=q(),u=[],p=new Set,h=new Map,f=[];let d={currentTickData:null,currentTick:0,currentSystem:0},m=0;function g(e,n=!0){switch(!0===n&&i.push(e),e[0]){case t.WorldOpType.Spawn:return function(e){const[,n,o]=e;S(o,t.ComponentState.Attaching),f.push(o),a.create(n,o)}(e);case t.WorldOpType.Attach:return function(e){const[,n,o]=e;S(o,t.ComponentState.Attaching),f.push(o),a.insert(n,o)}(e);case t.WorldOpType.Detach:return function(e){const[,n,o]=e;for(let e=0;e<o.length;e++){T(a.findComponentByComponentTypeId(n,o[e]),t.ComponentState.Detached)}h.set(n,o)}(e);case t.WorldOpType.Destroy:return function(e){const[,n]=e;S(a.getEntityComponents(n),t.ComponentState.Detached),p.add(n)}(e)}}function C(t){const e=l.get(t._tid);e&&e.release(t)}function _(t){a.getEntityComponents(t).forEach(C),a.destroy(t)}function v(t,e){for(let n=0;n<t.length;n++){C(a.findComponentByComponentTypeId(e,t[n]))}a.removeByTypeIds(e,t)}function w(){for(a.clearMutations();i.length>0;)s.release(i.pop());for(;f.length>0;)S(f.pop(),t.ComponentState.Attached);for(h.forEach(v),h.clear(),p.forEach(_),p.clear();c.length>0;)g(c.pop())}function D(...t){const e=s.retain();for(let n=0;n<t.length;n++)e[n]=t[n];return e}const{getObservedComponent:O,isComponentChanged:k,patch:x}=a,R={addSystem:function(t){n.push(t)},applyOps:function(e){for(let n=0;n<e.length;n++){const o=e[n];switch(o[0]){case t.WorldOpType.Detach:{const[,e,n]=o,r=n.map(t=>a.findComponentByComponentTypeId(e,t));for(let e=0;e<r.length;e++){const n=r[e];n&&T(n,t.ComponentState.Detaching)}break}case t.WorldOpType.Destroy:{const[,e]=o;S(a.getEntityComponents(e),t.ComponentState.Detaching);break}}g(o,!1)}},attach:function(e,...n){const o=D(t.WorldOpType.Attach,e,n);c.push(o)},component:function(t,...e){u.includes(t)||function(t,e=r){if(u.find(({type:e})=>t.type===e))throw new Error(`Tried to register componentType with type id ${t.type} more than once.`);u.push(t),l.set(t.type,b(t,e))}(t);const n=l.get(t.type).retain();return t.initialize&&t.initialize(n,...e),n},componentTypes:u,destroy:function(e){const n=D(t.WorldOpType.Destroy,e);S(a.getEntityComponents(e),t.ComponentState.Detaching),c.push(n)},detach:function(e,...n){const o=n.map(t=>t._tid),r=D(t.WorldOpType.Detach,e,o);S(n,t.ComponentState.Detaching),c.push(r)},getComponent:function(t,e){const n=a.findComponent(t,e);if(null===n)throw new Error("Component not found");return n},getObservedComponent:O,id:-1,isComponentChanged:k,ops:i,patch:x,removeSystem:function(t){const e=n.indexOf(t);e>-1&&n.splice(e,1)},reset:function(){for(A(c),A(i),A(u),A(n),A(f),l.clear(),p.clear(),h.clear(),d={currentTickData:null,currentTick:0,currentSystem:0},m=0;c.length>0;)s.release(c.pop());for(;i.length>0;)s.release(i.pop());for(let t=0;t<a.archetypes.length;t++){const e=a.archetypes[t];for(let t=0;t<e.layout.length;t++){const n=e.table[t],o=l.get(e.layout[t]);for(let t=0;t<n.length;t++){const e=n[t];null==o||o.release(e)}}}a.clear()},spawn:function(...e){const n=m++,o=D(t.WorldOpType.Spawn,n,e);return c.push(o),n},state:d,storage:a,tick:function(t){o.__CURRENT_WORLD__=E,d.currentTickData=t,0===d.currentTick&&w(),w();for(let t=0;t<n.length;t++)R.state.currentSystem=t,n[t](R);d.currentTick++},tryGetComponent:function(t,e){return a.findComponent(t,e)}};let E=R.id=o.__WORLDS__.push(R)-1;return R},t.detached=f,t.flagComponent=T,t.flagComponents=S,t.initializeComponentFromSchema=C,t.interval=s,t.isComponentOf=function(t,e){return t._tid===e.type},t.isDataType=g,t.json=a,t.mutableEmpty=A,t.mutableRemove=function(t,e){const n=t.indexOf(e);return-1!==n&&(t.splice(n,1),!0)},t.mutableRemoveUnordered=function(t,e){const n=t.length,o=t.indexOf(e);if(-1===o)return!1;const r=t.pop();return o<n-1&&(t[o]=r),!0},t.noop=D,t.number=O,t.query=function(...t){const e=y(e=>new w(t,e.release),t=>(t.reset(),t),100);return{[Symbol.iterator]:()=>e.retain().iterable}},t.ref=c,t.request=l,t.resetComponentFromSchema=_,t.string=x,t.timer=i,Object.defineProperty(t,"__esModule",{value:!0})}));
