!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Javelin={})}(this,(function(t){"use strict";function e(t){const e=t.length,n=[],o=[],r=[],c=t.reduce((t,e,n)=>(t[e]=n,t),[]);for(let t=0;t<e;t++)n[t]=[];return{layout:t,layoutInverse:c,table:n,indices:r,entities:o,insert:function(t,e){for(let t=0;t<e.length;t++){const o=e[t],r=c[o.tid];n[r].push(o)}r[t]=o.push(t)-1},remove:function(t){const e=o.length,c=r[t],i=o.pop();if(r[t]=-1,c!==e-1){for(const t of n)t[c]=t.pop();o[c]=i,r[i]=c}else for(const t of n)t.pop()}}}var n;function o(t){return e=>({componentType:e,componentPredicate:t()})}(n=t.ComponentState||(t.ComponentState={}))[n.Orphaned=0]="Orphaned",n[n.Attaching=1]="Attaching",n[n.Attached=2]="Attached",n[n.Detaching=3]="Detaching",n[n.Detached=4]="Detached";const r=o(()=>({cst:e})=>e===t.ComponentState.Attaching),c=o(()=>(t,{isComponentChanged:e})=>e(t)),i=o(()=>({cst:e})=>e===t.ComponentState.Detached);function p(t,e,n){const o=[],r=()=>{for(let e=0;e<n;e++)o.push(t())};return{allocate:r,retain:()=>(o.length||r(),o.pop()),release:t=>{o.push(e(t))}}}const a=Symbol("is_data_type");function s(t){return{...t,[a]:!0}}function u(t){return"object"==typeof t&&null!==t&&t[a]}function l(t,e){for(const n in e){const o=e[n];if(u(o))t[n]=o.create(void 0);else if("type"in o&&u(o.type)){const{type:e,defaultValue:r}=o;t[n]=e.create(r)}else l(t,o)}return t}function f(e,n){e.cst=t.ComponentState.Orphaned;for(const t in n){const o=n[t];if(u(o))o.reset(e,t,void 0);else if("type"in o&&u(o.type)){const{type:n,defaultValue:r}=o;n.reset(e,t,r)}else f(e,o)}return e}function h(e){return Object.defineProperties({},{tid:{value:e.type,writable:!1,enumerable:!0},cst:{value:t.ComponentState.Orphaned,writable:!0,enumerable:!1}})}function d(t,e){return p(()=>l(h(t),t.schema),e=>f(e,t.schema),e)}function y(t,e){t.cst=e}function m(t,e){for(let n=0;n<t.length;n++)t[n].cst=e}function g(...t){}function C(t){for(;t.length>0;)t.pop()}function v(t=0,e=g){return Array(t).fill(void 0).map((t,n)=>e(n))}const b=s({name:"number",create:(t=0)=>t,reset(t,e,n=0){t[e]=n}}),S=s({name:"boolean",create:(t=!1)=>t,reset(t,e,n=!1){t[e]=n}}),w=s({name:"string",create:(t="")=>t,reset(t,e,n=""){t[e]=n}}),O=/^\d+\(\)$/,T=/\d+/;let A={};function D(t,e,n){var o;const r=function(t){let e=A[t];if(!e){e=t.split(".");for(let t=0;t<e.length;t++){const n=e[t];T.test(n)&&(e[t]=Number(n))}A[t]=e}return e}(e),c=r[r.length-1];let i=t;for(let t=0;t<r.length-1;t++)i=i[r[t]];const p="string"==typeof c&&c.match(O),a=p?Number(p[0]):null;"number"==typeof a&&(null===(o=P.get(a))||void 0===o||o.apply(r[r.length-2],n)),i[c]=n}var E;!function(t){t[t.Push=0]="Push",t[t.Pop=1]="Pop",t[t.Shift=2]="Shift",t[t.Unshift=3]="Unshift",t[t.Splice=4]="Splice"}(E||(E={}));const W=new Map([[Array.prototype.push,E.Push],[Array.prototype.pop,E.Pop],[Array.prototype.shift,E.Shift],[Array.prototype.unshift,E.Unshift],[Array.prototype.splice,E.Splice]]),P=new Map([[E.Push,Array.prototype.push],[E.Pop,Array.prototype.pop],[E.Shift,Array.prototype.shift],[E.Unshift,Array.prototype.unshift],[E.Splice,Array.prototype.splice]]);function x(){const t=(({onChange:t})=>{const e=new WeakMap,n=new WeakMap,o=new WeakMap,r=new WeakMap,c=new WeakSet;function i(t,e){const o=n.get(t);return""===o?e.toString():`${o}.${e}`}function p(t,c=t,i=""){let p=o.get(t);return void 0===p&&(p=new Proxy(t,a),o.set(t,p),r.set(p,t),e.set(t,c),n.set(t,i)),p}const a={get(t,n,o){const r=Reflect.get(t,n,o);return"symbol"!=typeof n&&("object"==typeof(c=r)&&null!==c||"function"==typeof c)?p(r,e.get(t),i(t,n)):r;var c},set(n,o,r,p){const a=n[o];return n[o]=r,a===r||c.has(n)||t(e.get(n),n,i(n,o),r),!0},apply(n,o,p){const a=Array.isArray(o),s=r.get(o);let u=W.get(n),l=a&&"number"==typeof u;l&&c.add(s);const f=Reflect.apply(n,o,p);return l&&(t(e.get(s),o,i(s,u+"()"),p),c.delete(o)),f}};return{proxy:function(t){return p(t)},revoke:function(t){const e=o.get(t);o.delete(t),r.delete(e)}}})({onChange(t,e,o,r,c){let i=n.get(t);i||(i=[],n.set(t,i)),c?i.push(o,r,c):i.push(o,r)}}),n=new Map,o=[],r=[];function c(t){let n=function(t){const e=t.length;for(let n=0;n<o.length;n++){const r=o[n],{layout:c}=r;if(c.length!==e)continue;let i=!0;for(let n=0;n<e;n++)if(-1===c.indexOf(t[n].tid)){i=!1;break}if(i)return r}return null}(t);return n||(n=e(t.map(t=>t.tid)),o.push(n)),n}function i(t){const e=r[t];if(void 0===e)throw new Error("Failed to locate entity. Entity does not exist.");if(null===e)throw new Error("Failed to locate entity. Entity has been removed.");return o[e]}function p(t,e,n){if(t.remove(e),0===n.length)return;const i=c(n);i.insert(e,n),r[e]=o.indexOf(i)}function a(t,e){const n=i(t),o=n.indices[t];let r=e.slice();for(let t=0;t<n.layout.length;t++){const c=n.layout[t];if(e.find(t=>t.tid===c))throw new Error(`Cannot attach component with type ${c} â€” entity already has component of type.`);r.push(n.table[t][o])}p(n,t,r)}function s(t,e){u(t,e.map(t=>t.tid))}function u(e,o){const r=i(e),c=r.indices[e];let a=[];for(let e=0;e<r.layout.length;e++){const i=r.layout[e],p=r.table[e][c];o.includes(i)?(t.revoke(p),n.delete(p)):a.push(p)}p(r,e,a)}const l=[];function f(t,e){const n=i(t),o=n.layoutInverse[e];if(void 0===o)return null;const r=n.indices[t];return n.table[o][r]}function h(t){const e=i(t),n=e.indices[t],o=[];for(let t=0;t<e.table.length;t++)o.push(e.table[t][n]);return o}function d(e){return t.proxy(e)}return{archetypes:o,clearMutations:function(){n.forEach(C)},create:function(t,e){const n=c(e);return n.insert(t,e),r[t]=o.indexOf(n),t},destroy:function(t){s(t,h(t)),r[t]=null},findComponent:function(t,e){return f(t,e.type)},findComponentByComponentTypeId:f,getComponentMutations:function(t){const e=n.get(t);if(!e)throw new Error("ChangeSet does not exist for component.");return e},getEntityComponents:h,getObservedComponent:d,insert:a,isComponentChanged:function(t){const e=n.get(t);return!!e&&e.length>0},patch:function(t,e,n,o){const r=i(t),c=r.indices[t],p=r.layoutInverse[e];if(void 0===p)return;D(d(r.table[p][c]),n,o)},remove:s,removeByTypeIds:u,upsert:function(t,e){const n=i(t),o=n.indices[t];C(l);for(let t=0;t<e.length;t++){const r=e[t],c=n.layoutInverse[r.tid];if(void 0===c)l.push(r);else{const t=d(n.table[c][o]);Object.assign(t,r)}}l.length>0&&a(t,l)}}}var M;(M=t.WorldOpType||(t.WorldOpType={}))[M.Spawn=0]="Spawn",M[M.Attach=1]="Attach",M[M.Detach=2]="Detach",M[M.Mutate=3]="Mutate",M[M.Destroy=4]="Destroy";t.$isDataType=a,t.array=t=>s({name:"array",create:(t=[])=>t,reset(t,e,n){void 0!==n?t[e]=n.slice():C(t[e])}}),t.arrayOf=v,t.attached=r,t.boolean=S,t.changed=c,t.createArchetype=e,t.createComponentBase=h,t.createComponentFilter=o,t.createComponentPool=d,t.createComponentType=function(t){return t},t.createDataType=s,t.createStorage=x,t.createTopic=()=>{const t=[],e=[];return{*[Symbol.iterator](){for(let t=0;t<e.length;t++)yield e[t]},push:e=>t.push(e),pushImmediate:t=>e.push(t),flush:()=>{C(e);for(let n=t.length-1;n>=0;n--)e[n]=t.pop()}}},t.createWorld=(e={})=>{const{systems:n=[],componentPoolSize:o=1e3}=e,r=[],c=[],i=p(()=>[],t=>(C(t),t),1e3),a=new Map,s=x(),u=[],l=new Set,f=new Map,h=[];let g=0,v=0;function b(e){switch(c.push(e),e[0]){case t.WorldOpType.Spawn:return function(e){const[,n,o]=e;m(o,t.ComponentState.Attaching),h.push(o),s.create(n,o)}(e);case t.WorldOpType.Attach:return function(e){const[,n,o]=e;m(o,t.ComponentState.Attaching),h.push(o),s.insert(n,o)}(e);case t.WorldOpType.Detach:return function(e){const[,n,o]=e;for(let e=0;e<o.length;e++){y(s.findComponentByComponentTypeId(n,o[e]),t.ComponentState.Detached)}f.set(n,o)}(e);case t.WorldOpType.Destroy:return function(e){const[,n]=e;m(s.getEntityComponents(n),t.ComponentState.Detached),l.add(n)}(e)}}function S(t){const e=a.get(t.tid);e&&e.release(t)}function w(t){s.getEntityComponents(t).forEach(S),s.destroy(t)}function O(t,e){for(let n=0;n<t.length;n++){S(s.findComponentByComponentTypeId(e,t[n]))}s.removeByTypeIds(e,t)}function T(){for(s.clearMutations();c.length>0;)i.release(c.pop());for(;h.length>0;)m(h.pop(),t.ComponentState.Attached);for(f.forEach(O),f.clear(),l.forEach(w),l.clear();r.length>0;)b(r.pop())}function A(...t){const e=i.retain();for(let n=0;n<t.length;n++)e[n]=t[n];return e}const{getObservedComponent:D,isComponentChanged:E,patch:W}=s,P={addSystem:function(t){n.push(t)},applyOps:function(e){for(let n=0;n<e.length;n++){const o=e[n];switch(o[0]){case t.WorldOpType.Detach:{const[,e,n]=o,r=n.map(t=>s.findComponentByComponentTypeId(e,t));for(let e=0;e<r.length;e++){const n=r[e];n&&y(n,t.ComponentState.Detaching)}break}case t.WorldOpType.Destroy:{const[,e]=o;m(s.getEntityComponents(e),t.ComponentState.Detaching);break}}b(o)}},attach:function(e,...n){const o=A(t.WorldOpType.Attach,e,n);r.push(o)},component:function(t,...e){u.includes(t)||function(t,e=o){if(u.find(({type:e})=>t.type===e))throw new Error(`Tried to register componentType with type id ${t.type} more than once.`);u.push(t),a.set(t.type,d(t,e))}(t);const n=a.get(t.type).retain();return t.initialize&&t.initialize(n,...e),n},componentTypes:u,destroy:function(e){const n=A(t.WorldOpType.Destroy,e);m(s.getEntityComponents(e),t.ComponentState.Detaching),r.push(n)},detach:function(e,...n){const o=n.map(t=>t.tid),c=A(t.WorldOpType.Detach,e,o);m(n,t.ComponentState.Detaching),r.push(c)},getComponent:function(t,e){const n=s.findComponent(t,e);if(null===n)throw new Error("Component not found");return n},getObservedComponent:D,isComponentChanged:E,ops:c,patch:W,removeSystem:function(t){const e=n.indexOf(t);e>-1&&n.splice(e,1)},spawn:function(...e){const n=v++,o=A(t.WorldOpType.Spawn,n,e);return r.push(o),n},storage:s,tick:function(t){0===g&&T(),T();for(let e=0;e<n.length;e++)n[e](P,t);g++},tryGetComponent:function(t,e){return s.findComponent(t,e)}};return P},t.detached=i,t.flagComponent=y,t.flagComponents=m,t.initializeComponentFromSchema=l,t.isComponentOf=function(t,e){return t.tid===e.type},t.isDataType=u,t.mutableEmpty=C,t.mutableRemove=function(t,e){const n=t.indexOf(e);return-1!==n&&(t.splice(n,1),!0)},t.mutableRemoveUnordered=function(t,e){const n=t.length,o=t.indexOf(e);if(-1===o)return!1;const r=t.pop();return o<n-1&&(t[o]=r),!0},t.noop=g,t.number=b,t.query=function t(...e){const n=e.map(t=>"componentPredicate"in t?t.componentPredicate:null),o=e.length,r=e.map(t=>"componentType"in t?t.componentType.type:t.type),c=v(o),i=[-1,c],p=[];let a,s,u,l=!1,f=-1,h=-1;const d={value:i,done:!1};function y(){var t,e;const{table:r,entities:s}=u,l=s.length;t:for(;++h<l;){i[0]=s[h];for(let i=0;i<o;i++){const o=r[p[i]][h];if(!(null!==(e=null===(t=n[i])||void 0===t?void 0:t.call(n,o,a))&&void 0!==e?e:2===o.cst))continue t;c[i]=o}return}m()}function m(){t:for(;u=s[++f];){const{layoutInverse:t}=u;for(let e=0;e<o;e++){const n=t[r[e]];if(void 0===n)continue t;p[e]=n}return h=-1,void y()}l=!1,d.done=!0}const g={next:()=>(null===u?m():y(),d)},C={[Symbol.iterator]:()=>g};return n=>l?t(...e)(n):(l=!0,a=n,s=n.storage.archetypes,u=null,f=-1,h=-1,d.done=!1,C)},t.resetComponentFromSchema=f,t.string=w,Object.defineProperty(t,"__esModule",{value:!0})}));
