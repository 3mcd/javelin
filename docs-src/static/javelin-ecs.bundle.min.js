!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Javelin={})}(this,(function(t){"use strict";function e(t){const e=t.length,n=[],o=[],r=[],c=[];for(let t=0;t<e;t++)n[t]=[];let i=-1;return{layout:t,table:n,indices:r,entities:o,insert:function(e,p){i++;for(let e=0;e<p.length;e++){const o=p[e],r=t.indexOf(o.type);n[r][i]=o}o[i]=e,r[e]=i,c[i]=e},remove:function(t){const e=r[t];if(e===i)for(const t of n)t[i]=null;else for(const t of n)t[e]=t[i],t[i]=null;o[e]=o[i],c[e]=c[i],r[o[i]]=e,r[t]=-1,o.pop(),i--},entitiesByIndex:c}}function n(t){return e=>({componentType:e,componentPredicate:t()})}const o=n(()=>(t,{attached:e})=>e.has(t)),r=n(()=>(t,{isComponentChanged:e})=>e(t)),c=Symbol("world_storage"),i=Symbol("is_data_type"),p=Symbol("detached"),s=n(()=>t=>!0===t[p]);function a(t,e,n){const o=[],r=()=>{for(let e=0;e<n;e++)o.push(t())};return{allocate:r,retain:()=>(o.length||r(),o.pop()),release:t=>{o.push(e(t))}}}function l(t){return{...t,[i]:!0}}function u(t){return"object"==typeof t&&null!==t&&t[i]}function f(t,e){for(const n in e){const o=e[n];if(u(o))t[n]=o.create(void 0);else if("type"in o&&u(o.type)){const{type:e,defaultValue:r}=o;t[n]=e.create(r)}else f(t,o)}return t}function y(t,e){t[p]=!1;for(const n in e){const o=e[n];if(u(o))o.reset(t,n,void 0);else if("type"in o&&u(o.type)){const{type:e,defaultValue:r}=o;e.reset(t,n,r)}else y(t,o)}return t}function h(t,e){return a(()=>f({[p]:!1,type:t.type,_v:0},t.schema),e=>y(e,t.schema),e)}function d(...t){}function m(t){for(;t.length>0;)t.pop()}function g(t=0,e=d){return Array(t).fill(void 0).map((t,n)=>e(n))}const b=l({name:"number",create:(t=0)=>t,reset(t,e,n=0){t[e]=n}}),C=l({name:"boolean",create:(t=!1)=>t,reset(t,e,n=!1){t[e]=n}}),w=l({name:"string",create:(t="")=>t,reset(t,e,n=""){t[e]=n}}),T=/^\d+\(\)$/,S=/\d+/;let v={};function O(t,e,n){var o;const r=function(t){let e=v[t];if(!e){e=t.split(".");for(let t=0;t<e.length;t++){const n=e[t];S.test(n)&&(e[t]=Number(n))}v[t]=e}return e}(e),c=r[r.length-1];let i=t;for(let t=0;t<r.length-1;t++)i=i[r[t]];const p="string"==typeof c&&c.match(T),s=p?Number(p[0]):null;"number"==typeof s&&(null===(o=A.get(s))||void 0===o||o.apply(r[r.length-2],n)),i[c]=n}var x;!function(t){t[t.Push=0]="Push",t[t.Pop=1]="Pop",t[t.Shift=2]="Shift",t[t.Unshift=3]="Unshift",t[t.Splice=4]="Splice"}(x||(x={}));const E=new Map([[Array.prototype.push,x.Push],[Array.prototype.pop,x.Pop],[Array.prototype.shift,x.Shift],[Array.prototype.unshift,x.Unshift],[Array.prototype.splice,x.Splice]]),A=new Map([[x.Push,Array.prototype.push],[x.Pop,Array.prototype.pop],[x.Shift,Array.prototype.shift],[x.Unshift,Array.prototype.unshift],[x.Splice,Array.prototype.splice]]);function P(){const t=(({onChange:t})=>{const e=new WeakMap,n=new WeakMap,o=new WeakMap,r=new WeakMap,c=new WeakSet;function i(t,e){const o=n.get(t);return""===o?e.toString():`${o}.${e}`}function p(t,c=t,i=""){let p=o.get(t);return void 0===p&&(p=new Proxy(t,s),o.set(t,p),r.set(p,t),e.set(t,c),n.set(t,i)),p}const s={get(t,n,o){const r=Reflect.get(t,n,o);return"symbol"!=typeof n&&("object"==typeof(c=r)&&null!==c||"function"==typeof c)?p(r,e.get(t),i(t,n)):r;var c},set(n,o,r,c){const p=n[o];return n[o]=r,p!==r&&t(e.get(n),n,i(n,o),r),!0},apply(n,o,p){const s=Array.isArray(o),a=r.get(o);let l=E.get(n),u=s&&"number"==typeof l;u&&c.add(a);const f=Reflect.apply(n,o,p);return u&&(t(e.get(a),o,i(a,l+"()"),p),c.delete(o)),f}};return{proxy:function(t){return p(t)},revoke:function(t){const e=o.get(t);o.delete(t),r.delete(e)}}})({onChange(t,e,o,r,c){let i=n.get(t);i||(i=[],n.set(t,i)),c?i.push(o,r,c):i.push(o,r)}}),n=new Map,o=[],r=[];function c(t){let n=function(t){const e=t.length;for(let n=0;n<o.length;n++){const r=o[n],{layout:c}=r;if(c.length!==e)continue;let i=!0;for(let n=0;n<e;n++)if(-1===c.indexOf(t[n].type)){i=!1;break}if(i)return r}return null}(t);return n||(n=e(t.map(t=>t.type)),o.push(n)),n}function i(t){const e=r[t];if(void 0===e)throw new Error("Failed to locate entity. Entity does not exist.");if(null===e)throw new Error("Failed to locate entity. Entity has been removed.");return o[e]}function p(t,e,n){if(t.remove(e),0===n.length)return;const i=c(n);i.insert(e,n),r[e]=o.indexOf(i)}function s(t,e){a(t,e.map(t=>t.type))}function a(e,o){const r=i(e),c=r.indices[e];let s=[];for(let e=0;e<r.layout.length;e++){const i=r.layout[e],p=r.table[e][c];o.includes(i)?(t.revoke(p),n.delete(p)):s.push(p)}p(r,e,s)}function l(t){const e=i(t),n=e.indices[t],o=[];for(let t=0;t<e.table.length;t++)o.push(e.table[t][n]);return o}function u(e){return t.proxy(e)}return{archetypes:o,clearMutations:function(){n.forEach(m)},create:function(t,e){const n=c(e);return n.insert(t,e),r[t]=o.indexOf(n),t},destroy:function(t){s(t,l(t)),r[t]=null},findComponent:function(t,e){const n=i(t),o=n.layout.indexOf(e.type);if(-1===o)throw new Error("Failed to find component. Component could not exist with entity.");const r=n.indices[t];return n.table[o][r]},getEntityComponents:l,getMutableComponent:u,getComponentMutations:function(t){const e=n.get(t);if(!e)throw new Error("ChangeSet does not exist for component.");return e},insert:function(t,e){const n=i(t),o=n.indices[t];let r=e.slice();for(let t=0;t<n.layout.length;t++){const c=n.layout[t];if(e.find(t=>t.type===c))throw new Error(`Cannot attach component with type ${c} â€” entity already has component of type.`);r.push(n.table[t][o])}p(n,t,r)},isComponentChanged:function(t){const e=n.get(t);return!!e&&e.length>0},remove:s,removeByTypeIds:a,applyComponentPatch:function(t,e,n,o){const r=i(t),c=r.indices[t],p=r.layout.indexOf(e);if(-1===p)return;O(u(r.table[p][c]),n,o)}}}var W;(W=t.WorldOpType||(t.WorldOpType={}))[W.Spawn=0]="Spawn",W[W.Attach=1]="Attach",W[W.Detach=2]="Detach",W[W.Mutate=3]="Mutate",W[W.Destroy=4]="Destroy";t.$detached=p,t.$isDataType=i,t.$worldStorageKey=c,t.array=t=>l({name:"array",create:(t=[])=>t,reset(t,e,n){void 0!==n?t[e]=n.slice():m(t[e])}}),t.arrayOf=g,t.attached=o,t.boolean=C,t.changed=r,t.createArchetype=e,t.createComponentFilter=n,t.createComponentPool=h,t.createComponentType=function(t){return t},t.createDataType=l,t.createStorage=P,t.createTopic=()=>{const t=[],e=[];return{*[Symbol.iterator](){for(let t=0;t<e.length;t++)yield e[t]},push:e=>t.push(e),pushImmediate:t=>e.push(t),flush:()=>{m(e);for(let n=t.length-1;n>=0;n--)e[n]=t.pop()}}},t.createWorld=(e={})=>{const{systems:n=[],componentTypes:o=[],componentPoolSize:r=1e3}=e,i=[],s=[],l=a(()=>[],t=>(m(t),t),1e3),u=new Map,y=P(),d=[],g=new Set,b=new Set;let C=0;for(let t=0;t<o.length;t++)x(o[t]);function w(t){t[p]=!0}function T(e){switch(e[0]){case t.WorldOpType.Spawn:!function(t){const[,e,n]=t;for(let t=0;t<n.length;t++)b.add(n[t]);y.create(e,n)}(e);break;case t.WorldOpType.Attach:!function(t){const[,e,n]=t;for(let t=0;t<n.length;t++)b.add(n[t]);y.insert(e,n)}(e);break;case t.WorldOpType.Detach:!function(t){const[,e,n]=t,o=y.getEntityComponents(e);for(let t=0;t<o.length;t++){const e=o[t];n.includes(e.type)&&S(e)}y.removeByTypeIds(e,n)}(e);break;case t.WorldOpType.Destroy:!function(t){const[,e]=t;g.add(e)}(e)}s.push(e)}function S(t){const e=u.get(t.type);e&&e.release(t)}function v(t){y.getEntityComponents(t).forEach(S),y.destroy(t)}function O(t,e){return y.findComponent(t,e)}function x(t,e=r){if(d.includes(t))throw new Error(`Tried to register componentType with type id ${t.type} more than once.`);d.push(t),u.set(t.type,h(t,e))}const{getMutableComponent:E,isComponentChanged:A,applyComponentPatch:W}=y,M={[c]:y,addSystem:function(t){n.push(t)},applyComponentPatch:W,applyOps:function(e){for(let n=0;n<e.length;n++){const o=e[n];if(o[0]===t.WorldOpType.Detach){const[,t,e]=o,n=y.getEntityComponents(t);for(let t=0;t<n.length;t++){const o=n[t];e.includes(o.type)&&w(o)}}else if(o[0]===t.WorldOpType.Destroy){const[,t]=o;y.getEntityComponents(t).forEach(w)}T(o)}},attach:function(e,...n){const o=l.retain();o[0]=t.WorldOpType.Attach,o[1]=e,o[2]=n,i.push(o)},attached:b,component:function(t,...e){const n=u.get(t.type),o=n?n.retain():f({type:t.type},t.schema);return t.initialize&&t.initialize(o,...e),o},componentTypes:d,destroy:function(e){const n=l.retain();n[0]=t.WorldOpType.Destroy,n[1]=e,y.getEntityComponents(e).forEach(w),i.push(n)},detach:function(e,...n){const o=l.retain();o[0]=t.WorldOpType.Detach,o[1]=e,o[2]=n.map(t=>t.type),n.forEach(w),i.push(o)},getComponent:O,getMutableComponent:E,isComponentChanged:A,ops:s,registerComponentType:x,spawn:function(...e){const n=C++,o=l.retain();return o[0]=t.WorldOpType.Spawn,o[1]=n,o[2]=e,i.push(o),n},tick:function(t){for(y.clearMutations();s.length>0;)l.release(s.pop());for(g.forEach(v),g.clear(),b.clear();i.length>0;)T(i.pop());for(let e=0;e<n.length;e++)n[e](M,t)},tryGetComponent:function(t,e){try{return O(t,e)}catch(t){return null}}};return M},t.detached=s,t.initializeComponentFromSchema=f,t.isComponentOf=function(t,e){return t.type===e.type},t.isDataType=u,t.mutableEmpty=m,t.mutableRemove=function(t,e){const n=t.indexOf(e);return-1!==n&&(t.splice(n,1),!0)},t.mutableRemoveUnordered=function(t,e){const n=t.length,o=t.indexOf(e);if(-1===o)return!1;const r=t.pop();return o<n-1&&(t[o]=r),!0},t.noop=d,t.number=b,t.query=function(...t){const e=t.map(t=>"componentPredicate"in t?t.componentPredicate:null),n=t.length,o=t.map(t=>"componentType"in t?t.componentType.type:t.type),r=g(n),i=[-1,r],s=[];let a,l,u,f=-1,y=-1;const h={value:i,done:!1};function d(){const{table:t,entitiesByIndex:o}=u,[c]=t;t:for(;c[++y];){i[0]=o[y];for(let o=0;o<n;o++){const n=e[o],c=t[s[o]][y];if(n?!1===n(c,a):c[p])continue t;r[o]=c}return}b()}function b(){let t;t:for(;t=l[++f];){const{layout:e}=t;u=t,y=-1;for(let t=0;t<n;t++){const n=e.indexOf(o[t]);if(-1===n)continue t;s[t]=n}return void d()}h.done=!0,i[0]=-1,m(r)}const C={next:()=>(null===u?b():d(),h)},w={[Symbol.iterator]:()=>C};return t=>(a=t,l=t[c].archetypes,u=null,f=-1,y=-1,h.done=!1,w)},t.resetComponentFromSchema=y,t.string=w,Object.defineProperty(t,"__esModule",{value:!0})}));
