!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Javelin={})}(this,(function(e){"use strict";function t(...e){}function n(e,t){const n=e.length,r=e.indexOf(t);if(-1===r)return!1;const o=e.pop();return r<n-1&&(e[r]=o),!0}function r(e){for(;e.length>0;)e.pop()}function o(e){return e.reduce((e,t,n)=>(e[n]=t,e),{})}function i(e){const t=[];for(const n in e){const r=parseInt(n,10);isNaN(r)||(t[r]=e[n])}return t}const s=()=>{const e=[];return{subscribe:t=>(e.push(t),()=>n(e,t)),dispatch:(t,n,r)=>{for(let o=0;o<e.length;o++)e[o](t,n,r)}}};function c(e){const{signature:t,signatureInverse:n,entities:r,indices:o,table:c}=function(e){const t="snapshot"in e?e.snapshot:null,n=t?Object.keys(t.indices).map(Number):[],r=t?i(t.indices):[],o=("signature"in e?e.signature:e.snapshot.signature).slice().sort((e,t)=>e-t),s=t?t.table.map(e=>e.slice()):o.map(()=>[]),c=o.reduce((e,t,n)=>(e[t]=n,e),[]);return{entities:n,indices:r,signature:o,signatureInverse:c,table:s}}(e),l=s(),a=s();return{entities:r,indices:o,insert:function(e,t){for(let e=0;e<t.length;e++){const r=t[e],o=n[r._tid];c[o].push(r)}o[e]=r.push(e)-1,l.dispatch(e)},inserted:l,remove:function(e){const t=r.length,n=o[e],i=r.pop();if(delete o[e],n===t-1)for(const e of c)e.pop();else{for(const e of c)e[n]=e.pop();r[n]=i,o[i]=n}a.dispatch(e)},removed:a,signature:t,signatureInverse:n,table:c}}function l(e,t="",n){if(!e)throw new Error(void 0!==n?`${u[n]}: ${t}`:t)}var a;(a=e.ErrorType||(e.ErrorType={}))[a.Internal=0]="Internal";const u={[e.ErrorType.Internal]:"Internal Error"},p={__WORLDS__:[],__CURRENT_WORLD__:-1};function f(e,t={throw:!1,global:!1}){const{global:n}=t,r=[];let o,i,s,c,l,a=-1;return function(...t){c=p.__CURRENT_WORLD__;const u=p.__WORLDS__[c],f=u.state.currentTick;l=n?0:u.state.currentSystem;let _=r[c];void 0===r[c]&&(_=r[c]=[]);let d=_[l];if(void 0===d&&(d=_[l]={cells:[],cellCount:-1}),!0===n||i!==c&&void 0!==i)a=0;else if(void 0===s||o===f&&s===l)a++;else{let e=_[s];if(-1!==e.cellCount&&e.cellCount!==a)throw new Error(`Failed to execute effect: encountered too ${e.cellCount>a?"few":"many"} effects this tick`);e.cellCount=a,a=0}let h=d.cells[a];if(h||(h=d.cells[a]={executor:e(u),lockGlobal:!1,lockAsync:!1,lockGlobalTick:-1,state:null}),n&&(h.lockGlobalTick!==u.state.currentTick?(h.lockGlobal=!1,h.lockGlobalTick=u.state.currentTick):h.lockGlobal=!0),h.lockGlobal||h.lockAsync)return h.state;const y=h.executor(...t);var g;return"object"==typeof(g=y)&&null!==g&&"then"in g?(h.lockAsync=!0,y.then(e=>h.state=e).catch(e=>console.error("Uncaught error in effect: "+e.message,e)).then(()=>h.lockAsync=!1)):h.state=y,o=f,i=c,s=l,h.state}}const _=f(()=>{let e=!0;const t={value:null};return function(n){return e&&(t.value=n,e=!1),t}}),d=f(()=>{let e,t=0;return function(n,r=!1){return r&&(t=0,clearTimeout(e)),0===t&&(t=1,e=setTimeout(()=>{t=2},n)),2===t}}),h=f(()=>function(e){const t=_(!1),n=d(e,t.value);return t.value=n,n});function y(e,t,n){const r=[],o=()=>{for(let t=0;t<n;t++)r.push(e(i))},i={allocate:o,retain:()=>(r.length||o(),r.pop()),release:e=>{r.push(t(e))}};return i}const g=(e,t)=>((e,t)=>{let n=0,r=0;if(e.length<t.length)return!1;for(;n<e.length&&r<t.length;)if(e[n]<t[r])n++;else{if(e[n]!==t[r])return!1;n++,r++}return r===t.length})(t.signature,e.signature)&&t.signature.every(t=>!e.filters.not.has(t));const m=(e,t=!1)=>f(n=>{const{storage:{entityRelocated:o}}=n;let i=null,s=[],c=[];const l={forEach:e=>{for(let t=0;t<c.length;t++)e(c[t])},[Symbol.iterator]:()=>c[Symbol.iterator]()};return o.subscribe((t,n,r)=>{null!==i&&!1!==e(i,n,r)&&s.push(t)}),function(e){let n;for(i!==e&&(e=>{if(r(s),r(c),null===i&&t)for(const[t]of e)for(let e=0;e<t.length;e++)s.push(t[e]);i=e})(e),r(c);void 0!==(n=s.pop());)c.push(n);return l}}),v=m((e,t,n)=>{const r=g(e,t),o=g(e,n);return!r&&o},!0),b=m((e,t,n)=>{const r=g(e,t),o=g(e,n);return r&&!o}),k=y(()=>[-1,null],e=>(e[0]=-1,e[1]=null,e),1e3),T=(e,t=!1)=>f(n=>{const{storage:{archetypes:r}}=n,o=new Set,i=[],s=[],c={forEach:e=>{for(let t=0;t<i.length;t++)e(i[t][0],i[t][1])},[Symbol.iterator]:()=>i[Symbol.iterator]()},l=e(n),a=(e,t)=>{const n=k.retain();n[0]=e,n[1]=t,s.push(n),o.add(e)};let u=null;return l.subscribe((e,t)=>{if(null!==u)for(let n=0;n<t.length;n++){const r=t[n];r._tid===u&&a(e,r)}}),n.destroyed.subscribe(e=>{if(o.has(e)){let t=0;for(;t<s.length;)if(s[t][0]===e){const e=s.pop();void 0!==e&&(s[t]=e)}else t++}}),function(e){let n,l;for(null===u&&(e=>{if(t)for(let t=0;t<r.length;t++){const{table:n,entities:o,signatureInverse:i}=r[t],s=i[e.type];if(void 0!==s){const e=n[s];for(let t=0;t<o.length;t++)a(o[t],e[t])}}})(e),u=e.type;n=i.pop();)k.release(n);for(;l=s.pop();)i.push(l);return o.clear(),c}}),w=T(e=>e.attached,!0),A=T(e=>e.detached);var S,O;!function(e){e[e.Array=0]="Array",e[e.Map=1]="Map",e[e.Primitive=2]="Primitive"}(S||(S={})),function(e){e.Number="number",e.Boolean="boolean",e.String="string"}(O||(O={}));S.Primitive,O.Number,S.Primitive,O.String,S.Primitive,O.Boolean;const E=e=>"__kind__"in e&&e.__kind__===S.Primitive,C=e=>"__kind__"in e&&e.__kind__===S.Array;var R;!function(e){e[e.Primitive=0]="Primitive",e[e.Struct=1]="Struct",e[e.Array=2]="Array",e[e.Map=3]="Map"}(R||(R={}));const D=(e,t)=>e.localeCompare(t),W=(t,n,r,o)=>{const i=++r;let s;switch(n.__kind__){case S.Array:s=R.Array;break;case S.Map:s=R.Map;break;case S.Primitive:s=R.Primitive;break;default:s=R.Struct}const c={id:i,lo:i,hi:-1,inCollection:t.inCollection||t.kind===R.Array||t.kind===R.Map,kind:s};let a;var u;return E(n)?a={...c,kind:R.Primitive,type:n}:C(n)?(a={...c,kind:R.Array},r=W(a,n.__type__,r)):"__kind__"in(u=n)&&u.__kind__===S.Map?(a={...c,kind:R.Map},r=W(a,n.__type__,r)):(a={...c,kind:R.Struct,edges:[],keys:{},idsByKey:{}},r=M(n,a,r)),a.hi=r,o?(a.key=o,l(t.kind===R.Struct,"expected target node to be struct",e.ErrorType.Internal),function(t){l("key"in t,"",e.ErrorType.Internal)}(a),t.edges.push(a),t.keys[a.key]=a,t.idsByKey[a.key]=i):(l(t.kind===R.Array||t.kind===R.Map,"expected target node to be collection",e.ErrorType.Internal),t.edge=a),r},M=(e,t,n=-1)=>{const r=Object.keys(e).sort(D);for(let o=0;o<r.length;o++){const i=r[o],s=e[i];n=W(t,s,n,i)}return t.hi=n,n},x=e=>{const t={};return e.forEach((e,n)=>{const r={edges:[],hi:1/0,lo:-1,id:-1,idsByKey:{},inCollection:!1,keys:{},kind:R.Struct};M(e,r),t[n]=r}),t};function I(e){for(;e.length>0;)e.pop()}const P=Symbol("NO_OP"),N=new Set([Array.prototype.push,Array.prototype.pop,Array.prototype.shift,Array.prototype.unshift,Array.prototype.splice,Array.prototype.sort]),L=(e,t,n,r)=>{void 0===r?e.fields[t]={value:n,field:t}:e.fields[`${t},${r.join(",")}`]={value:n,field:t,traverse:r.slice()}},j=(e,t,n,r,o,i)=>e.arrays.push({field:t,index:n,insert:r,remove:o,traverse:i}),B=e=>e.kind===R.Array||e.kind===R.Map,U=e=>!0===e.inCollection,G=[],$=(e,t)=>{I(G),void 0!==t&&G.push(t);let n=e;for(;void 0!==n;){const{__parent__:e,__index__:t}=n;void 0!==t&&G.unshift(t),n=e}return G};const F=f(e=>{const t=function(){const e=new WeakMap,t=new WeakMap,n={get(e,t){if("__self__"===t)return e;if("length"===t||e.__type__.edge.kind===R.Primitive)return e[t];const n=e[t];return n.__index__=t,n.__parent__=e,l(n,e,t)},set:(e,n,r)=>(e.__lock__||(L(t.get(e),e.__type__.edge.kind,r,$(e,n)),e[n]=r),!0)},r={get(e,t){if("__self__"===t)return e;const n=e.__type__.keys[t];if(void 0===n||n.kind===R.Primitive)return e[t];const r=e[t];return r.__parent__=e,l(r,e,t)},set:(e,n,r)=>(L(t.get(e),e.__type__.idsByKey[n],r,$(e)),e[n]=r,!0)},o={get(e,t){if("__self__"===t)return e;if("length"===t||e.__type__.edge.kind===R.Primitive)return e[t];const n=e[t];return n.__index__=t,l(n,e,t)},set:(e,n,r)=>(e.__lock__||(e[n]=r,L(t.get(e),e.__type__.edge.id,r,$(e,n))),!0)},i={get(e,t){if("__self__"===t)return e;const n=e.__type__.keys[t];return void 0===n||n.kind===R.Primitive?e[t]:l(e[t],e,t)},set:(e,n,r)=>(e[n]=r,L(t.get(e),e.__type__.idsByKey[n],r),!0)},s={apply(e,n,r){const o=n.__self__;if(N.has(e)){const n=t.get(o),i=o.__type__.id,s=$(e);switch(o.__lock__=!0,e.apply(o,r),e){case Array.prototype.push:{const e=o.length-1;j(n,i,e,r,0,s);break}case Array.prototype.pop:{const e=o.length-1;j(n,i,e,null,1,s);break}case Array.prototype.shift:j(n,i,0,null,1,s);break;case Array.prototype.unshift:j(n,i,0,r,0,s);break;case Array.prototype.splice:switch(r.length){case 0:break;case 1:j(n,i,r[0],null,0,s);break;case 2:j(n,i,r[0],null,r[1],s);break;default:j(n,i,r[0],r.slice(2),r[1],s)}break;case Array.prototype.sort:j(n,i,0,o,o.length,s)}o.__lock__=!1}else e.apply(o,r)}},c=(e,c,l={fields:{},arrays:[]})=>{let a;return a=N.has(e)?s:B(c)&&U(c)?n:B(c)?o:U(c)?r:i,e.__type__=c,e.__lock__=!1,t.set(e,l),new Proxy(e,a)},l=(n,r,o)=>{let i=e.get(n);if(void 0===i){const s="keys"in r.__type__?r.__type__.keys[o]:r.__type__.edge;i=c(n,s,t.get(r)),e.set(n,i)}return i};return{changes:t,observe:(t,n)=>{let r=e.get(t);return void 0===r&&(r=c(t,n),e.set(t,r)),r},reset:e=>{const n=t.get(e);if(void 0!==n){for(const e in n.fields)n.fields[e]=P;I(n.arrays)}}}}();let n;const r=Object.assign((function(e){return l(void 0!==n[e._tid],"Failed to observe component: component type not registered"),t.observe(e,n[e._tid])}),t);return function(){return n=e.getModel(),r}}),K=f(()=>{let e,t={response:null,error:null,done:!1},n=!1,r=new window.AbortController;return function(o,i,s=void 0!==e&&o!==e){return(null===o||s)&&(r.abort(),r=new AbortController),null===o?t:(s&&(t={response:t.response,error:null,done:!1}),t.done||n||(n=!0,e=o,fetch(o,{...i,signal:r.signal}).then(e=>{t={response:e,error:null,done:!0}}).catch(e=>{t={response:t.response,error:e,done:!0}}).then(()=>{n=!1})),t)}}),q=f(()=>{let e;return function(...t){const n=_(null),r=K(...t);return r.response&&r.response!==n.value&&(r.response.json().then(t=>{e=t}),n.value=r.response),{...r,response:e||null}}});function z(e){return Object.defineProperties({},{_tid:{value:e.type,writable:!1,enumerable:!0}})}function J(e,t){return y(()=>function e(t,n){for(const r in n){const o=n[r];E(o)?t[r]=o.create():o.__kind__===S.Array?t[r]=[]:t[r]=e({},o)}return t}(z(e),e.schema),t=>function e(t,n){for(const o in n){const i=n[o];E(i)?i.reset(t,o,void 0):C(i)?r(i):e(t[o],i)}return t}(t,e.schema),t)}function V(e={}){const t=s(),n=s(),i=e.snapshot?e.snapshot.archetypes.map(e=>c({snapshot:e})):[],l=[];function a(e){let n=function(e){const t=e.length;for(let n=0;n<i.length;n++){const r=i[n],{signature:o}=r;if(o.length!==t)continue;let s=!0;for(let n=0;n<t;n++)if(-1===o.indexOf(e[n]._tid)){s=!1;break}if(s)return r}return null}(e);return n||(n=c({signature:e.map(e=>e._tid)}),i.push(n),t.dispatch(n)),n}function u(e){const t=l[e];if(void 0===t)throw new Error("Failed to locate entity. Entity does not exist.");if(null===t)throw new Error("Failed to locate entity. Entity has been removed.");return i[t]}function p(e,t,r){e.remove(t);const o=a(r);o.insert(t,r),l[t]=i.indexOf(o),n.dispatch(t,e,o)}function f(e,t){const n=u(e),r=n.indices[e];let o=t.slice();for(let e=0;e<n.signature.length;e++){const i=n.signature[e];if(t.find(e=>e._tid===i))throw new Error(`Cannot attach component with type ${i} — entity already has component of type.`);o.push(n.table[e][r])}p(n,e,o)}function _(e,t){d(e,t.map(e=>e._tid))}function d(e,t){const n=u(e),r=n.indices[e];let o=[];for(let e=0;e<n.signature.length;e++){const i=n.signature[e],s=n.table[e][r];t.includes(i)||o.push(s)}p(n,e,o)}const h=[];function y(e,t){const n=u(e),r=n.signatureInverse[t];if(void 0===r)return null;const o=n.indices[e];return n.table[r][o]}function g(e){const t=u(e),n=t.indices[e],r=[];for(let e=0;e<t.table.length;e++)r.push(t.table[e][n]);return r}return{archetypeCreated:t,archetypes:i,clear:function(){r(i),r(l)},create:function(e,t){const n=a(t);return n.insert(e,t),l[e]=i.indexOf(n),e},destroy:function(e){_(e,g(e)),l[e]=null},entityRelocated:n,findComponent:function(e,t){return y(e,t.type)},findComponentByComponentTypeId:y,getEntityComponents:g,hasComponent:function(e,t){return u(e).signature.includes(t.type)},insert:f,remove:_,removeByTypeIds:d,snapshot:function(){return{archetypes:i.map(e=>({signature:e.signature.slice(),table:e.table.map(e=>e.map(e=>({...e}))),indices:o(e.indices)}))}},upsert:function(e,t){const n=u(e),o=n.indices[e];r(h);for(let e=0;e<t.length;e++){const r=t[e],i=n.signatureInverse[r._tid];void 0===i?h.push(r):Object.assign(n.table[i][o],r)}h.length>0&&f(e,h)}}}const Y=Symbol("is_data_type");var H;(H=e.WorldOpType||(e.WorldOpType={}))[H.Spawn=0]="Spawn",H[H.Attach=1]="Attach",H[H.Detach=2]="Detach",H[H.Mutate=3]="Mutate",H[H.Destroy=4]="Destroy",e.$isDataType=Y,e.arrayOf=function(e=0,n=t){return Array(e).fill(void 0).map((e,t)=>n(t))},e.assert=l,e.createArchetype=c,e.createComponentBase=z,e.createComponentPool=J,e.createComponentType=function(e){return{...e,schema:e.schema||{}}},e.createEffect=f,e.createStorage=V,e.createTopic=()=>{const e=[],t=[];return{*[Symbol.iterator](){for(let e=0;e<t.length;e++)yield t[e]},push:t=>e.push(t),pushImmediate:e=>t.push(e),flush:()=>{r(t);for(let n=e.length-1;n>=0;n--)t[n]=e.pop()},clear:()=>{r(e),r(t)}}},e.createWorld=function(t={}){var n,o;const{componentPoolSize:i=1e3,topics:c=[]}=t,l=[],a=[],u=[],f=y(()=>[],e=>(r(e),e),1e3),_=[],d=new Map,h=s(),g=s(),m=s(),v=s(),b=s(),k=new Set,T=V({snapshot:null===(n=t.snapshot)||void 0===n?void 0:n.storage});let w=x(new Map),A={currentTickData:null,currentTick:0,currentSystem:0},S=0;function O(...e){const t=f.retain();for(let n=0;n<e.length;n++)t[n]=e[n];return t}function E(e){T.create(e,[]),v.dispatch(e)}function C(e,t){T.insert(e,t),g.dispatch(e,t)}function R(e,t){T.remove(e,t),m.dispatch(e,t)}function D(e){T.destroy(e),b.dispatch(e)}function W(t,n=!0){switch(!0===n&&u.push(t),t[0]){case e.WorldOpType.Spawn:return function(e){const[,t]=e;E(t)}(t);case e.WorldOpType.Attach:return function(e){const[,t,n]=e;C(t,n)}(t);case e.WorldOpType.Detach:return function(e){const[,t,n]=e;R(t,n)}(t);case e.WorldOpType.Destroy:return function(e){const[,t]=e;D(t)}(t)}}function M(e){const t=d.get(e._tid);t&&t.release(e)}function I(e){l.push(e),e.__JAVELIN_SYSTEM_ID__=0}function P(e,t){const n=T.findComponent(e,t);if(null===n)throw new Error("Component not found");return n}null===(o=t.systems)||void 0===o||o.forEach(I),m.subscribe((e,t)=>t.forEach(M));const N={addSystem:I,addTopic:function(e){c.push(e)},applyOps:function(e){for(let t=0;t<e.length;t++)W(e[t],!1)},attach:function(t,...n){a.push(O(e.WorldOpType.Attach,t,n))},component:function(e,...t){_.includes(e)||function(e,t=i){if(_.find(({type:t})=>e.type===t))throw new Error("Failed to register component type: a componentType with same id is already registered");_.push(e),d.set(e.type,J(e,t));const n=new Map(_.map(e=>[e.type,e.schema]));w=x(n),h.dispatch(w)}(e);const n=d.get(e.type).retain();return e.initialize&&e.initialize(n,...t),n},componentTypes:_,destroy:function(t){if(k.has(t))return;const n=T.getEntityComponents(t);a.push(O(e.WorldOpType.Detach,t,n),O(e.WorldOpType.Destroy,t)),k.add(t)},detach:function(t,...n){0!==n.length&&("type"in n[0]&&(n=n.map(e=>P(t,e))),a.push(O(e.WorldOpType.Detach,t,n)))},get:P,has:function(e,t){return T.hasComponent(e,t)},id:-1,getModel:function(){return w},ops:u,removeSystem:function(e){const t=l.indexOf(e);t>-1&&l.splice(t,1)},removeTopic:function(e){const t=c.indexOf(e);t>-1&&c.splice(t,1)},reserve:function(){return++S},reset:function(){for(r(a),r(u),r(_),r(l),d.clear(),k.clear(),A={currentTickData:null,currentTick:0,currentSystem:0},S=0;a.length>0;)f.release(a.pop());for(;u.length>0;)f.release(u.pop());for(let e=0;e<T.archetypes.length;e++){const t=T.archetypes[e];for(let e=0;e<t.signature.length;e++){const n=t.table[e],r=d.get(t.signature[e]);for(let e=0;e<n.length;e++){const t=n[e];null==r||r.release(t)}}}T.clear()},snapshot:function(){return{storage:T.snapshot()}},spawn:function(...t){const n=S++;return a.push(O(e.WorldOpType.Spawn,n),O(e.WorldOpType.Attach,n,t)),n},state:A,storage:T,tick:function(e){for(p.__CURRENT_WORLD__=L,A.currentTickData=e;u.length>0;)f.release(u.pop());for(let e=0;e<a.length;e++)W(a[e]);r(a);for(let e=0;e<c.length;e++)c[e].flush();for(let e=0;e<l.length;e++){const t=l[e];N.state.currentSystem=t.__JAVELIN_SYSTEM_ID__,t(N)}k.clear(),A.currentTick++},tryGet:function(e,t){return T.findComponent(e,t)},modelChanged:h,attached:g,detached:m,spawned:v,destroyed:b,internalSpawn:E,internalAttach:C,internalDetach:R,internalDestroy:D};let L=N.id=p.__WORLDS__.push(N)-1;return N},e.interval=h,e.isComponentOf=function(e,t){return e._tid===t.type},e.json=q,e.mutableEmpty=r,e.mutableRemove=function(e,t){const n=e.indexOf(t);return-1!==n&&(e.splice(n,1),!0)},e.mutableRemoveUnordered=n,e.noop=t,e.observe=F,e.onAttach=w,e.onDetach=A,e.onInsert=v,e.onRemove=b,e.packSparseArray=o,e.query=function(...e){const t=e.length,n=e.map(e=>e.type),o={not:new Set},i=n.slice().sort((e,t)=>e-t),s=[],c=(e,t)=>{if(g(u,e)){const r=n.map(t=>e.table[e.signature.indexOf(t)]);t.push([e.entities,r])}},l=e=>{const t=p.__WORLDS__[e],n=[];return s[e]=n,t.storage.archetypes.forEach(e=>c(e,n)),t.storage.archetypeCreated.subscribe(e=>c(e,n)),n},a=y(()=>[],e=>(r(e),e),1e3),u={layout:n,length:t,signature:i,filters:o,not(...e){for(let t=0;t<e.length;t++)o.not.add(e[t].type);return u},forEach(e){const n=s[p.__CURRENT_WORLD__]||l(p.__CURRENT_WORLD__),r=a.retain();for(let o=0;o<n.length;o++){const[i,s]=n[o];for(let n=0;n<i.length;n++){for(let e=0;e<t;e++)r[e]=s[e][n];e(i[n],r)}}a.release(r)},[Symbol.iterator]:()=>(s[p.__CURRENT_WORLD__]||l(p.__CURRENT_WORLD__))[Symbol.iterator]()};return u},e.queryMatchesArchetype=g,e.ref=_,e.request=K,e.timer=d,e.unpackSparseArray=i,Object.defineProperty(e,"__esModule",{value:!0})}));
