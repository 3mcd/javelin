!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Javelin={})}(this,(function(e){"use strict";function t(e,t="",n){if(!e)throw new Error(void 0!==n?`${r[n]}: ${t}`:t)}var n;!function(e){e[e.Internal=0]="Internal"}(n||(n={}));const r={[n.Internal]:"Internal Error"};function o(e){for(;e.length>0;)e.pop()}var i,s;!function(e){e[e.Array=0]="Array",e[e.Map=1]="Map",e[e.Primitive=2]="Primitive"}(i||(i={})),function(e){e.Number="number",e.Boolean="boolean",e.String="string"}(s||(s={}));const c={__kind__:i.Primitive,__type__:s.Number,create:()=>0,reset:(e,t)=>e[t]=0},l={__kind__:i.Primitive,__type__:s.String,create:()=>"",reset:(e,t)=>e[t]=0},a={__kind__:i.Primitive,__type__:s.Boolean,create:()=>!1,reset:(e,t)=>e[t]=0},u=e=>"__kind__"in e&&e.__kind__===i.Primitive,p=e=>"__kind__"in e&&e.__kind__===i.Array;var _;!function(e){e[e.Primitive=0]="Primitive",e[e.Struct=1]="Struct",e[e.Array=2]="Array",e[e.Map=3]="Map"}(_||(_={}));const f=(e,t)=>e.localeCompare(t),d=(e,r,o,s)=>{const c=++o;let l;switch(r.__kind__){case i.Array:l=_.Array;break;case i.Map:l=_.Map;break;case i.Primitive:l=_.Primitive;break;default:l=_.Struct}const a={id:c,lo:c,hi:-1,inCollection:e.inCollection||e.kind===_.Array||e.kind===_.Map,kind:l};let f;var y;return u(r)?f={...a,kind:_.Primitive,type:r}:p(r)?(f={...a,kind:_.Array},o=d(f,r.__type__,o)):"__kind__"in(y=r)&&y.__kind__===i.Map?(f={...a,kind:_.Map},o=d(f,r.__type__,o)):(f={...a,kind:_.Struct,edges:[],keys:{},idsByKey:{}},o=h(r,f,o)),f.hi=o,s?(f.key=s,t(e.kind===_.Struct,"expected target node to be struct",n.Internal),function(e){t("key"in e,"",n.Internal)}(f),e.edges.push(f),e.keys[f.key]=f,e.idsByKey[f.key]=c):(t(e.kind===_.Array||e.kind===_.Map,"expected target node to be collection",n.Internal),e.edge=f),o},h=(e,t,n=-1)=>{const r=Object.keys(e).sort(f);for(let o=0;o<r.length;o++){const i=r[o],s=e[i];n=d(t,s,n,i)}return t.hi=n,n},y=e=>{const t={};return e.forEach((e,n)=>{const r={edges:[],hi:1/0,lo:-1,id:-1,idsByKey:{},inCollection:!1,keys:{},kind:_.Struct};h(e,r),t[n]=r}),t};const g=Symbol("NO_OP"),m=new Set([Array.prototype.push,Array.prototype.pop,Array.prototype.shift,Array.prototype.unshift,Array.prototype.splice,Array.prototype.sort]),b=(e,t,n,r)=>{void 0===r?e.fields[t]={value:n,field:t}:e.fields[`${t},${r.join(",")}`]={value:n,field:t,traverse:r.slice()}},k=(e,t,n,r,o,i)=>e.arrays.push({field:t,index:n,insert:r,remove:o,traverse:i}),v=e=>e.kind===_.Array||e.kind===_.Map,T=e=>!0===e.inCollection,w=[],A=(e,t)=>{o(w),void 0!==t&&w.push(t);let n=e;for(;void 0!==n;){const{__parent__:e,__index__:t}=n;void 0!==t&&w.unshift(t),n=e}return w};const O=()=>{const e=[];return{subscribe:t=>(e.push(t),()=>function(e,t){const n=e.length,r=e.indexOf(t);if(-1===r)return!1;const o=e.pop();return r<n-1&&(e[r]=o),!0}(e,t)),dispatch:(t,n,r)=>{for(let o=0;o<e.length;o++)e[o](t,n,r)}}};function S(e){const t="snapshot"in e?e.snapshot:null,n=t?Object.keys(t.indices).map(Number):[],r=t?function(e){const t=[];for(const n in e){const r=parseInt(n,10);isNaN(r)||(t[r]=e[n])}return t}(t.indices):[],o=("signature"in e?e.signature:e.snapshot.signature).slice().sort((e,t)=>e-t),i=t?t.table.map(e=>e.slice()):o.map(()=>[]),s=o.reduce((e,t,n)=>(e[t]=n,e),[]);return{entities:n,indices:r,signature:o,signatureInverse:s,table:i}}function C(e){const{signature:t,signatureInverse:n,entities:r,indices:o,table:i}=S(e),s=O(),c=O();return{entities:r,indices:o,insert:function(e,t){for(let e=0;e<t.length;e++){const r=t[e],o=n[r._tid];i[o].push(r)}o[e]=r.push(e)-1,s.dispatch(e)},inserted:s,remove:function(e){const t=r.length,n=o[e],s=r.pop();if(delete o[e],n===t-1)for(const e of i)e.pop();else{for(const e of i)e[n]=e.pop();r[n]=s,o[s]=n}c.dispatch(e)},removed:c,signature:t,signatureInverse:n,table:i}}const E={__WORLDS__:[],__CURRENT_WORLD__:-1};function D(e,t={throw:!1,global:!1}){const{global:n}=t,r=[];let o,i,s,c,l,a=-1;return function(...t){c=E.__CURRENT_WORLD__;const u=E.__WORLDS__[c],p=u.state.currentTick;l=n?0:u.state.currentSystem;let _=r[c];void 0===r[c]&&(_=r[c]=[]);let f=_[l];if(void 0===f&&(f=_[l]={cells:[],cellCount:-1}),!0===n||i!==c&&void 0!==i)a=0;else if(void 0===s||o===p&&s===l)a++;else{let e=_[s];if(-1!==e.cellCount&&e.cellCount!==a)throw new Error(`Failed to execute effect: encountered too ${e.cellCount>a?"few":"many"} effects this tick`);e.cellCount=a,a=0}let d=f.cells[a];if(d||(d=f.cells[a]={executor:e(u),lockGlobal:!1,lockAsync:!1,lockGlobalTick:-1,state:null}),n&&(d.lockGlobalTick!==u.state.currentTick?(d.lockGlobal=!1,d.lockGlobalTick=u.state.currentTick):d.lockGlobal=!0),d.lockGlobal||d.lockAsync)return d.state;const h=d.executor(...t);var y;return"object"==typeof(y=h)&&null!==y&&"then"in y?(d.lockAsync=!0,h.then(e=>d.state=e).catch(e=>console.error("Uncaught error in effect: "+e.message,e)).then(()=>d.lockAsync=!1)):d.state=h,o=p,i=c,s=l,d.state}}const R=D(()=>{let e=!0;const t={value:null};return function(n){return e&&(t.value=n,e=!1),t}}),W=D(()=>{let e,t=0;return function(n,r=!1){return r&&(t=0,clearTimeout(e)),0===t&&(t=1,e=setTimeout(()=>{t=2},n)),2===t}}),M=D(()=>function(e){const t=R(!1),n=W(e,t.value);return t.value=n,n});function I(e,t,n){const r=[],o=()=>{for(let t=0;t<n;t++)r.push(e(i))},i={allocate:o,retain:()=>(r.length||o(),r.pop()),release:e=>{r.push(t(e))}};return i}const x=(e,t)=>((e,t)=>{let n=0,r=0;if(e.length<t.length)return!1;for(;n<e.length&&r<t.length;)if(e[n]<t[r])n++;else{if(e[n]!==t[r])return!1;n++,r++}return r===t.length})(t.signature,e.signature)&&t.signature.every(t=>!e.filters.not.has(t));const P=(e,t=!1)=>D(n=>{const{storage:{entityRelocated:r}}=n;let i=null,s=[],c=[];const l={forEach:e=>{for(let t=0;t<c.length;t++)e(c[t])},[Symbol.iterator]:()=>c[Symbol.iterator]()};return r.subscribe((t,n,r)=>{null!==i&&!1!==e(i,n,r)&&s.push(t)}),function(e){let n;for(i!==e&&(e=>{if(o(s),o(c),null===i&&t)for(const[t]of e)for(let e=0;e<t.length;e++)s.push(t[e]);i=e})(e),o(c);void 0!==(n=s.pop());)c.push(n);return l}}),N=P((e,t,n)=>{const r=x(e,t),o=x(e,n);return!r&&o},!0),L=P((e,t,n)=>{const r=x(e,t),o=x(e,n);return r&&!o}),j=I(()=>[-1,null],e=>(e[0]=-1,e[1]=null,e),1e3),B=(e,t=!1,n=!1)=>D(r=>{const{storage:{archetypes:o}}=r,i=new Set,s=[],c=[],l={forEach:e=>{for(let t=0;t<s.length;t++)e(s[t][0],s[t][1])},[Symbol.iterator]:()=>s[Symbol.iterator]()},a=e(r),u=(e,t)=>{const n=j.retain();n[0]=e,n[1]=t,c.push(n),i.add(e)};let p=null;return a.subscribe((e,t)=>{if(null!==p)for(let n=0;n<t.length;n++){const r=t[n];r._tid===p&&u(e,r)}}),n&&r.destroyed.subscribe(e=>{if(i.has(e)){let t=0;for(;t<c.length;)if(c[t][0]===e){const e=c.pop();if(0===c.length)continue;c[t]=e}else t++}}),function(e){let n,r;for(null===p&&(e=>{if(t)for(let t=0;t<o.length;t++){const{table:n,entities:r,signatureInverse:i}=o[t],s=i[e.type];if(void 0!==s){const e=n[s];for(let t=0;t<r.length;t++)u(r[t],e[t])}}})(e),p=e.type;n=s.pop();)j.release(n);for(;r=c.pop();)s.push(r);return i.clear(),l}}),G=B(e=>e.attached,!0,!0),U=B(e=>e.detached),$=D(e=>{const n=function(){const e=new WeakMap,t=new WeakMap,n={get(e,t){if("__self__"===t)return e;if("length"===t||e.__type__.edge.kind===_.Primitive)return e[t];const n=e[t];return n.__index__=t,n.__parent__=e,a(n,e,t)},set:(e,n,r)=>(e.__lock__||(b(t.get(e),e.__type__.edge.kind,r,A(e,n)),e[n]=r),!0)},r={get(e,t){if("__self__"===t)return e;const n=e.__type__.keys[t];if(void 0===n||n.kind===_.Primitive)return e[t];const r=e[t];return r.__parent__=e,a(r,e,t)},set:(e,n,r)=>(b(t.get(e),e.__type__.idsByKey[n],r,A(e)),e[n]=r,!0)},i={get(e,t){if("__self__"===t)return e;if("length"===t||e.__type__.edge.kind===_.Primitive)return e[t];const n=e[t];return n.__index__=t,a(n,e,t)},set:(e,n,r)=>(e.__lock__||(e[n]=r,b(t.get(e),e.__type__.edge.id,r,A(e,n))),!0)},s={get(e,t){if("__self__"===t)return e;const n=e.__type__.keys[t];return void 0===n||n.kind===_.Primitive?e[t]:a(e[t],e,t)},set:(e,n,r)=>(e[n]=r,b(t.get(e),e.__type__.idsByKey[n],r),!0)},c={apply(e,n,r){const o=n.__self__;if(m.has(e)){const n=t.get(o),i=o.__type__.id,s=A(e);switch(o.__lock__=!0,e.apply(o,r),e){case Array.prototype.push:{const e=o.length-1;k(n,i,e,r,0,s);break}case Array.prototype.pop:{const e=o.length-1;k(n,i,e,null,1,s);break}case Array.prototype.shift:k(n,i,0,null,1,s);break;case Array.prototype.unshift:k(n,i,0,r,0,s);break;case Array.prototype.splice:switch(r.length){case 0:break;case 1:k(n,i,r[0],null,0,s);break;case 2:k(n,i,r[0],null,r[1],s);break;default:k(n,i,r[0],r.slice(2),r[1],s)}break;case Array.prototype.sort:k(n,i,0,o,o.length,s)}o.__lock__=!1}else e.apply(o,r)}},l=(e,o,l={fields:{},arrays:[]})=>{let a;return a=m.has(e)?c:v(o)&&T(o)?n:v(o)?i:T(o)?r:s,e.__type__=o,e.__lock__=!1,t.set(e,l),new Proxy(e,a)},a=(n,r,o)=>{let i=e.get(n);if(void 0===i){const s="keys"in r.__type__?r.__type__.keys[o]:r.__type__.edge;i=l(n,s,t.get(r)),e.set(n,i)}return i};return{changes:t,observe:(t,n)=>{let r=e.get(t);return void 0===r&&(r=l(t,n),e.set(t,r)),r},reset:e=>{const n=t.get(e);if(void 0!==n){for(const e in n.fields)n.fields[e]=g;o(n.arrays)}}}}();let r=e.getModel();e.modelChanged.subscribe(e=>r=e);const i=Object.assign((function(e){const o=r[e._tid];return t(void 0!==o,"Failed to observe component: component type not registered"),n.observe(e,o)}),n);return function(){return i}}),F=D(()=>{let e,t={response:null,error:null,done:!1},n=!1,r=new window.AbortController;return function(o,i,s=void 0!==e&&o!==e){return(null===o||s)&&(r.abort(),r=new AbortController),null===o?t:(s&&(t={response:t.response,error:null,done:!1}),t.done||n||(n=!0,e=o,fetch(o,{...i,signal:r.signal}).then(e=>{t={response:e,error:null,done:!0}}).catch(e=>{t={response:t.response,error:e,done:!0}}).then(()=>{n=!1})),t)}}),K=D(()=>{let e;return function(...t){const n=R(null),r=F(...t);return r.response&&r.response!==n.value&&(r.response.json().then(t=>{e=t}),n.value=r.response),{...r,response:e||null}}});function q(e){return Object.defineProperties({},{_tid:{value:e.type,writable:!1,enumerable:!0}})}function z(e,t){return I(()=>function e(t,n){for(const r in n){const o=n[r];u(o)?t[r]=o.create():o.__kind__===i.Array?t[r]=[]:t[r]=e({},o)}return t}(q(e),e.schema),t=>function e(t,n){for(const r in n){const i=n[r];u(i)?i.reset(t,r,void 0):p(i)?o(i):e(t[r],i)}return t}(t,e.schema),t)}function J(e={}){const t=O(),n=O(),r=e.snapshot?e.snapshot.archetypes.map(e=>C({snapshot:e})):[],i=[];function s(e){let n=function(e){const t=e.length;for(let n=0;n<r.length;n++){const o=r[n],{signature:i}=o;if(i.length!==t)continue;let s=!0;for(let n=0;n<t;n++)if(-1===i.indexOf(e[n]._tid)){s=!1;break}if(s)return o}return null}(e);return n||(n=C({signature:e.map(e=>e._tid)}),r.push(n),t.dispatch(n)),n}function c(e){const t=i[e];if(void 0===t)throw new Error("Failed to locate entity. Entity does not exist.");if(null===t)throw new Error("Failed to locate entity. Entity has been removed.");return r[t]}function l(e,t,o){e.remove(t);const c=s(o);c.insert(t,o),i[t]=r.indexOf(c),n.dispatch(t,e,c)}function a(e,t){const n=c(e),r=n.indices[e];let o=t.slice();for(let e=0;e<n.signature.length;e++){const i=n.signature[e];if(t.find(e=>e._tid===i))throw new Error(`Cannot attach component with type ${i} â€” entity already has component of type.`);o.push(n.table[e][r])}l(n,e,o)}function u(e,t){p(e,t.map(e=>e._tid))}function p(e,t){const n=c(e),r=n.indices[e];let o=[];for(let e=0;e<n.signature.length;e++){const i=n.signature[e],s=n.table[e][r];t.includes(i)||o.push(s)}l(n,e,o)}const _=[];function f(e,t){const n=c(e),r=n.signatureInverse[t];if(void 0===r)return null;const o=n.indices[e];return n.table[r][o]}function d(e){const t=c(e),n=t.indices[e],r=[];for(let e=0;e<t.table.length;e++)r.push(t.table[e][n]);return r}return{archetypeCreated:t,archetypes:r,clear:function(){o(r),o(i)},create:function(e,t){const n=s(t);return n.insert(e,t),i[e]=r.indexOf(n),e},destroy:function(e){u(e,d(e)),i[e]=null},entityRelocated:n,findComponent:function(e,t){return f(e,t.type)},findComponentByComponentTypeId:f,getEntityComponents:d,hasComponent:function(e,t){return c(e).signature.includes(t.type)},insert:a,remove:u,removeByTypeIds:p,snapshot:function(){return{archetypes:r.map(e=>{return{signature:e.signature.slice(),table:e.table.map(e=>e.map(e=>({...e}))),indices:(t=e.indices,t.reduce((e,t,n)=>(e[n]=t,e),{}))};var t})}},upsert:function(e,t){const n=c(e),r=n.indices[e];o(_);for(let e=0;e<t.length;e++){const o=t[e],i=n.signatureInverse[o._tid];void 0===i?_.push(o):Object.assign(n.table[i][r],o)}_.length>0&&a(e,_)}}}const V=Symbol("is_data_type");var Y;(Y=e.WorldOpType||(e.WorldOpType={}))[Y.Spawn=0]="Spawn",Y[Y.Attach=1]="Attach",Y[Y.Detach=2]="Detach",Y[Y.Mutate=3]="Mutate",Y[Y.Destroy=4]="Destroy",e.$isDataType=V,e.arrayOf=e=>({__kind__:i.Array,__type__:e}),e.boolean=a,e.createArchetype=C,e.createComponentBase=q,e.createComponentPool=z,e.createComponentType=function(e){return{...e,schema:e.schema||{}}},e.createEffect=D,e.createStorage=J,e.createTopic=()=>{const e=[],t=[];return{*[Symbol.iterator](){for(let e=0;e<t.length;e++)yield t[e]},push:t=>e.push(t),pushImmediate:e=>t.push(e),flush:()=>{o(t);for(let n=e.length-1;n>=0;n--)t[n]=e.pop()},clear:()=>{o(e),o(t)}}},e.createWorld=function(t={}){var n,r;const{componentPoolSize:i=1e3,topics:s=[]}=t,c=[],l=[],a=[],u=I(()=>[],e=>(o(e),e),1e3),p=[],_=new Map,f=O(),d=O(),h=O(),g=O(),m=O(),b=new Set,k=J({snapshot:null===(n=t.snapshot)||void 0===n?void 0:n.storage});let v=y(new Map),T={currentTickData:null,currentTick:0,currentSystem:0},w=0;function A(...e){const t=u.retain();for(let n=0;n<e.length;n++)t[n]=e[n];return t}function S(e){k.create(e,[]),g.dispatch(e)}function C(e,t){k.insert(e,t),d.dispatch(e,t)}function D(e,t){k.remove(e,t),h.dispatch(e,t)}function R(e){k.destroy(e),m.dispatch(e)}function W(t,n=!0){switch(!0===n&&a.push(t),t[0]){case e.WorldOpType.Spawn:return function(e){const[,t]=e;S(t)}(t);case e.WorldOpType.Attach:return function(e){const[,t,n]=e;C(t,n)}(t);case e.WorldOpType.Detach:return function(e){const[,t,n]=e;D(t,n)}(t);case e.WorldOpType.Destroy:return function(e){const[,t]=e;R(t)}(t)}}function M(e){const t=_.get(e._tid);t&&t.release(e)}function x(e){c.push(e),e.__JAVELIN_SYSTEM_ID__=0}function P(e,t){const n=k.findComponent(e,t);if(null===n)throw new Error("Component not found");return n}null===(r=t.systems)||void 0===r||r.forEach(x),h.subscribe((e,t)=>t.forEach(M));const N={addSystem:x,addTopic:function(e){s.push(e)},applyOps:function(e){for(let t=0;t<e.length;t++)W(e[t],!1)},attach:function(t,...n){l.push(A(e.WorldOpType.Attach,t,n))},component:function(e,...t){p.includes(e)||function(e,t=i){if(p.find(({type:t})=>e.type===t))throw new Error("Failed to register component type: a componentType with same id is already registered");p.push(e),_.set(e.type,z(e,t));const n=new Map(p.map(e=>[e.type,e.schema]));v=y(n),f.dispatch(v)}(e);const n=_.get(e.type).retain();return e.initialize&&e.initialize(n,...t),n},componentTypes:p,destroy:function(t){if(b.has(t))return;const n=k.getEntityComponents(t);l.push(A(e.WorldOpType.Detach,t,n),A(e.WorldOpType.Destroy,t)),b.add(t)},detach:function(t,...n){0!==n.length&&("type"in n[0]&&(n=n.map(e=>P(t,e))),l.push(A(e.WorldOpType.Detach,t,n)))},get:P,has:function(e,t){return k.hasComponent(e,t)},id:-1,getModel:function(){return v},ops:a,removeSystem:function(e){const t=c.indexOf(e);t>-1&&c.splice(t,1)},removeTopic:function(e){const t=s.indexOf(e);t>-1&&s.splice(t,1)},reserve:function(){return++w},reset:function(){for(o(l),o(a),o(p),o(c),_.clear(),b.clear(),T={currentTickData:null,currentTick:0,currentSystem:0},w=0;l.length>0;)u.release(l.pop());for(;a.length>0;)u.release(a.pop());for(let e=0;e<k.archetypes.length;e++){const t=k.archetypes[e];for(let e=0;e<t.signature.length;e++){const n=t.table[e],r=_.get(t.signature[e]);for(let e=0;e<n.length;e++){const t=n[e];null==r||r.release(t)}}}k.clear()},snapshot:function(){return{storage:k.snapshot()}},spawn:function(...t){const n=w++;return l.push(A(e.WorldOpType.Spawn,n),A(e.WorldOpType.Attach,n,t)),n},state:T,storage:k,tick:function(e){for(E.__CURRENT_WORLD__=L,T.currentTickData=e;a.length>0;)u.release(a.pop());for(let e=0;e<l.length;e++)W(l[e]);o(l);for(let e=0;e<s.length;e++)s[e].flush();for(let e=0;e<c.length;e++){const t=c[e];N.state.currentSystem=t.__JAVELIN_SYSTEM_ID__,t(N)}b.clear(),T.currentTick++},tryGet:function(e,t){return k.findComponent(e,t)},modelChanged:f,attached:d,detached:h,spawned:g,destroyed:m,internalSpawn:S,internalAttach:C,internalDetach:D,internalDestroy:R};let L=N.id=E.__WORLDS__.push(N)-1;return N},e.interval=M,e.isComponentOf=function(e,t){return e._tid===t.type},e.json=K,e.mapOf=e=>({__kind__:i.Map,__type__:e}),e.number=c,e.observe=$,e.onAttach=G,e.onDetach=U,e.onInsert=N,e.onRemove=L,e.query=function(...e){const t=e.length,n=e.map(e=>e.type),r={not:new Set},i=n.slice().sort((e,t)=>e-t),s=[],c=(e,t)=>{if(x(u,e)){const r=n.map(t=>e.table[e.signature.indexOf(t)]);t.push([e.entities,r])}},l=e=>{const t=E.__WORLDS__[e],n=[];return s[e]=n,t.storage.archetypes.forEach(e=>c(e,n)),t.storage.archetypeCreated.subscribe(e=>c(e,n)),n},a=I(()=>[],e=>(o(e),e),1e3),u={layout:n,length:t,signature:i,filters:r,not(...e){for(let t=0;t<e.length;t++)r.not.add(e[t].type);return u},forEach(e){const n=s[E.__CURRENT_WORLD__]||l(E.__CURRENT_WORLD__),r=a.retain();for(let o=0;o<n.length;o++){const[i,s]=n[o];for(let n=0;n<i.length;n++){for(let e=0;e<t;e++)r[e]=s[e][n];e(i[n],r)}}a.release(r)},[Symbol.iterator]:()=>(s[E.__CURRENT_WORLD__]||l(E.__CURRENT_WORLD__))[Symbol.iterator]()};return u},e.queryMatchesArchetype=x,e.ref=R,e.request=F,e.string=l,e.timer=W,Object.defineProperty(e,"__esModule",{value:!0})}));
