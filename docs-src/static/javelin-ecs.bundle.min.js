!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Javelin={})}(this,(function(e){"use strict";function t(e,t="",n){if(!e)throw new Error(void 0!==n?`${o[n]}: ${t}`:t)}var n;!function(e){e[e.Internal=0]="Internal",e[e.Query=1]="Query"}(n||(n={}));const o={[n.Internal]:"Internal Error",[n.Query]:"Query Error"},r=Symbol("javelin_model_flat"),s=Symbol("javelin_model_struct");var c,i;!function(e){e[e.Primitive=0]="Primitive",e[e.Array=1]="Array",e[e.Object=2]="Object",e[e.Set=3]="Set",e[e.Map=4]="Map"}(c||(c={})),function(e){e.Number="number",e.Boolean="boolean",e.String="string",e.Dynamic="dynamic"}(i||(i={}));const l={__kind__:c.Primitive,__type__:i.Number,create:()=>0,reset:(e,t)=>e[t]=0},a={__kind__:c.Primitive,__type__:i.String,create:()=>"",reset:(e,t)=>e[t]=0},u={__kind__:c.Primitive,__type__:i.Boolean,create:()=>!1,reset:(e,t)=>e[t]=0},d=(c.Primitive,i.Dynamic,e=>"__kind__"in e&&e.__kind__===c.Primitive),f=e=>"__kind__"in e&&e.__kind__===c.Array,p=e=>"__kind__"in e&&e.__kind__===c.Object;const h=(e,t)=>e.localeCompare(t),_=(e,o,r,i)=>{const l=++r,a="__kind__"in o?o.__kind__:s,u={id:l,lo:l,hi:-1,inCollection:e.inCollection||e.kind===c.Array||e.kind===c.Object||e.kind===c.Set||e.kind===c.Map,kind:a};let f;return a===s?(f={...u,edges:[],keys:{},idsByKey:{}},r=g(o,f,r)):d(o)?f={...u,type:o}:(f={...u},r=_(f,o.__type__,r)),f.hi=r,i?(f.key=i,t(e.kind===s,"expected target node to be struct",n.Internal),function(e){t("key"in e,"",n.Internal)}(f),e.edges.push(f),e.keys[f.key]=f,e.idsByKey[f.key]=l):(t(e.kind===c.Array||e.kind===c.Object||e.kind===c.Set||e.kind===c.Map,"expected target node to be collection but got "+String(e.kind),n.Internal),e.edge=f),r},g=(e,t,n=-1)=>{const o=Object.keys(e).sort(h);for(let r=0;r<o.length;r++){const s=o[r],c=e[s];n=_(t,c,n,s)}return t.hi=n,n},y=e=>{const t={[r]:{}};return e.forEach((e,n)=>{const o={edges:[],hi:1/0,lo:-1,id:-1,idsByKey:{},inCollection:!1,keys:{},kind:s};g(e,o),t[n]=o}),Object.defineProperty(t,r,{enumerable:!1,writable:!1,value:b(t)}),t},m=(e,t)=>{switch(t[e.id]=e,e.kind){case c.Array:case c.Object:case c.Set:case c.Map:m(e.edge,t);break;case s:for(let n=0;n<e.edges.length;n++)m(e.edges[n],t)}},b=e=>{const t={};for(const n in e){const o={};m(e[n],o),t[n]=o}return t};function v(e){for(;e.length>0;)e.pop()}function k(e,t,n){const o=[],r=()=>{for(let t=0;t<n;t++)o.push(e(s))},s={allocate:r,retain:()=>(o.length||r(),o.pop()),release:e=>{o.push(t(e))}};return s}const S=()=>{const e=[];return{subscribe:t=>(e.push(t),()=>function(e,t){const n=e.length,o=e.indexOf(t);if(-1===o)return!1;const r=e.pop();return o<n-1&&(e[o]=r),!0}(e,t)),dispatch:(t,n,o,r)=>{for(let s=0;s<e.length;s++)e[s](t,n,o,r)}}};function I(e){const t="snapshot"in e?e.snapshot:null,n=t?Object.keys(t.indices).map(Number):[],o=t?function(e){const t=[];for(const n in e){const o=parseInt(n,10);isNaN(o)||(t[o]=e[n])}return t}(t.indices):[],r=("signature"in e?e.signature:e.snapshot.signature).slice().sort((e,t)=>e-t),s=t?t.table.map(e=>e.slice()):r.map(()=>[]),c=r.reduce((e,t,n)=>(e[t]=n,e),[]);return{entities:n,indices:o,signature:r,signatureInverse:c,table:s}}function w(e){const{signature:t,signatureInverse:n,entities:o,indices:r,table:s}=I(e),c=S(),i=S();return{entities:o,indices:r,insert:function(e,t){for(let e=0;e<t.length;e++){const o=t[e],r=n[o.__type__];s[r].push(o)}r[e]=o.push(e)-1,c.dispatch(e)},inserted:c,remove:function(e){const t=o.length,n=r[e],c=o.pop();if(delete r[e],n===t-1)for(const e of s)e.pop();else{for(const e of s)e[n]=e.pop();o[n]=c,r[c]=n}i.dispatch(e)},removed:i,signature:t,signatureInverse:n,table:s}}const O={schemaIndex:new WeakMap,model:{[r]:{}},worlds:[],worldIds:0,currentWorldId:-1};let C=0;function A(e){return Object.defineProperties({},{__type__:{value:O.schemaIndex.get(e),writable:!1,enumerable:!0}})}const x=new Map;function j(e,t){return k(()=>function e(t,n){for(const o in n){const r=n[o];d(r)?t[o]=r.create():r.__kind__===c.Array?t[o]=[]:r.__kind__===c.Object?t[o]={}:t[o]=e({},r)}return t}(A(e),e),t=>function e(t,n){for(const o in n){const r=n[o];if(d(r))r.reset(t,o,void 0);else if(f(r))v(t[o]);else if(p(r)){const e=t[o];for(const n in e)delete t[n]}else e(t[o],r)}return t}(t,e),t)}const D=new Map;function T(e,t,n=1e3){let o=O.schemaIndex.get(e);if(void 0!==o)return o;if(o=t,void 0===o){for(;D.has(C);)C++;o=C}else if(D.has(o))throw new Error("Failed to register component type: a component with same id is already registered");return x.set(o,j(e,n)),D.set(o,e),O.schemaIndex.set(e,o),O.model=y(D),o}function E(e,t={throw:!1,global:!1}){const{global:n}=t,o=[];let r,s,c,i,l,a=-1;return function(...t){i=O.currentWorldId;const u=O.worlds[i],d=u.latestStep;l=n?0:u.latestSystem;let f=o[i];void 0===o[i]&&(f=o[i]=[]);let p=f[l];if(void 0===p&&(p=f[l]={cells:[],cellCount:-1}),!0===n||s!==i&&void 0!==s)a=0;else if(void 0===c||r===d&&c===l)a++;else{let e=f[c];if(-1!==e.cellCount&&e.cellCount!==a)throw new Error(`Failed to execute effect: encountered too ${e.cellCount>a?"few":"many"} effects this step`);e.cellCount=a,a=0}let h=p.cells[a];if(h||(h=p.cells[a]={executor:e(u),lockGlobal:!1,lockAsync:!1,lockGlobalTick:null,state:null}),n&&(h.lockGlobalTick!==u.latestStep?(h.lockGlobal=!1,h.lockGlobalTick=u.latestStep):h.lockGlobal=!0),h.lockGlobal||h.lockAsync)return h.state;const _=h.executor(...t);var g;return"object"==typeof(g=_)&&null!==g&&"then"in g?(h.lockAsync=!0,_.then(e=>h.state=e).catch(e=>console.error("Uncaught error in effect: "+e.message,e)).then(()=>h.lockAsync=!1)):h.state=_,r=d,s=i,c=l,h.state}}const B=E(()=>{let e=!0;const t={value:null};return function(n){return e&&(t.value=n,e=!1),t}}),M=E(()=>{let e,t=0;return function(n,o=!1){return o&&(t=0,clearTimeout(e)),0===t&&(t=1,e=setTimeout(()=>{t=2},n)),2===t}}),P=E(()=>function(e){const t=B(!1),n=M(e,t.value);return t.value=n,n}),W=k(()=>[-1,[],[]],e=>(e[0]=-1,v(e[1]),v(e[2]),e),1e3),F=E(e=>{const{storage:{entityRelocating:t,entityRelocated:n,archetypes:[o]}}=e;let r=[],s=[],c=[],i=[],l=null;return t.subscribe((function(e,t,n,c){if(null===l)return;const i=l.matchesArchetype(t);if(i&&n===o){const t=r.findIndex(([t])=>t===e);-1!==t&&r.splice(t,1)}if(i&&!l.matchesArchetype(n)){const t=W.retain();t[0]=e,l.get(e,t[1]),l.match(c,t[2]),s.push(t)}})),n.subscribe((function(e,t,n,o){if(null!==l&&!l.matchesArchetype(t)&&l.matchesArchetype(n)){const t=W.retain();t[0]=e,l.get(e,t[1]),l.match(o,t[2]),r.push(t)}})),function(e,t,n){let o;for(l===e||(null==l?void 0:l.equals(e))||(e=>{l=e,v(r),v(s),v(c),v(i);for(const[t]of e)for(let n=0;n<t.length;n++){const o=t[n],s=W.retain();s[0]=o,e.get(o,s[1]),e.get(o,s[2]),r.push(s)}})(e),v(c),v(i);void 0!==(o=r.pop());)c.push(o);for(;void 0!==(o=s.pop());)i.push(o);if(void 0!==t)for(let e=0;e<c.length;e++){const n=c[e];t(n[0],n[1],n[2]),W.release(n)}if(void 0!==n)for(let e=0;e<i.length;e++){const t=i[e];n(t[0],t[1],t[2]),W.release(t)}}}),G=E(()=>{let e,t={response:null,error:null,done:!1},n=!1,o=new window.AbortController;return function(r,s,c=void 0!==e&&r!==e){return(null===r||c)&&(o.abort(),o=new AbortController),null===r?t:(c&&(t={response:t.response,error:null,done:!1}),t.done||n||(n=!0,e=r,fetch(r,{...s,signal:o.signal}).then(e=>{t={response:e,error:null,done:!0}}).catch(e=>{t={response:t.response,error:e,done:!0}}).then(()=>{n=!1})),t)}}),Q=E(()=>{let e;return function(...t){const n=B(null),o=G(...t);return o.response&&o.response!==n.value&&(o.response.json().then(t=>{e=t}),n.value=o.response),{...o,response:e||null}}}),R="a query must be executed within a system or bound to a world using Query.bind()",q=(e,t,n)=>((e,t)=>{let n=0,o=0;if(e.length<t.length)return!1;for(;n<e.length&&o<t.length;)if(e[n]<t[o])n++;else{if(e[n]!==t[o])return!1;n++,o++}return o===t.length})(n.signature,e)&&n.signature.every(e=>!t.not.has(e));const N="Failed to locate component: schema not registered";function K(e={}){const n=e.snapshot?e.snapshot.archetypes.map(e=>w({snapshot:e})):[w({signature:[]})],o=[],r=S(),s=S(),c=S();function i(e){let t=function(e){const t=e.length;e:for(let o=0;o<n.length;o++){const r=n[o],{signature:s,signatureInverse:c}=r;if(s.length===t){for(let n=0;n<t;n++)if(void 0===c[e[n].__type__])continue e;return r}}return null}(e);return null===t&&(t=w({signature:e.map(e=>e.__type__)}),n.push(t),c.dispatch(t)),t}function l(e){const n=o[e];return t(void 0!==n,"Failed to locate entity: entity has not been created"),t(null!==n,"Failed to locate entity: entity has been destroyed"),n}function a(e,t,n,c){const l=i(n);r.dispatch(t,e,l,c),e.remove(t),l.insert(t,n),o[t]=l,s.dispatch(t,e,l,c)}function u(e,t){const c=o[e];if(null==c){const c=i(t);r.dispatch(e,n[0],c,t),c.insert(e,t),o[e]=c,s.dispatch(e,n[0],c,t)}else{const n=c.indices[e],o=t.slice();for(let e=0;e<c.signature.length;e++){const r=c.signature[e];t.find(e=>e.__type__===r)||o.push(c.table[e][n])}a(c,e,o,t)}}function d(e,t){const n=l(e),o=[],r=[],s=n.indices[e];for(let e=0;e<n.signature.length;e++){const c=n.signature[e],i=n.table[e][s];(t.includes(c)?o:r).push(i)}a(n,e,r,o)}const f=[];function p(e,t){const n=l(e),o=n.signatureInverse[t];if(void 0===o)return null;const r=n.indices[e];return n.table[o][r]}return{archetypeCreated:c,archetypes:n,attachComponents:u,attachOrUpdateComponents:function(e,t){const n=l(e),o=n.indices[e];v(f);for(let e=0;e<t.length;e++){const r=t[e],s=n.signatureInverse[r.__type__];void 0===s?f.push(r):Object.assign(n.table[s][o],r)}f.length>0&&u(e,f)},reset:function(){v(n),v(o)},clearComponents:function(e){d(e,l(e).signature),o[e]=null},detachBySchemaId:d,entityRelocated:s,entityRelocating:r,getComponentsBySchemaId:p,getComponentsBySchema:function(e,n){const o=O.schemaIndex.get(n);return t(void 0!==o,N),p(e,o)},getAllComponents:function(e){const t=l(e),n=t.indices[e],o=[];for(let e=0;e<t.table.length;e++)o.push(t.table[e][n]);return o},getSnapshot:function(){return{archetypes:n.map(e=>{return{signature:e.signature.slice(),table:e.table.map(e=>e.map(e=>({...e}))),indices:(t=e.indices,t.reduce((e,t,n)=>(e[n]=t,e),{}))};var t})}},hasComponentOfSchema:function(e,n){const o=l(e),r=O.schemaIndex.get(n);return t(void 0!==r,N),o.signature.includes(r)}}}const U=Symbol("javelin_system_id");var $;($=e.DeferredOpType||(e.DeferredOpType={}))[$.Spawn=0]="Spawn",$[$.Attach=1]="Attach",$[$.Detach=2]="Detach",$[$.Mutate=3]="Mutate",$[$.Destroy=4]="Destroy",e.UNSAFE_internals=O,e.arrayOf=e=>({__kind__:c.Array,__type__:e}),e.boolean=u,e.component=(e,t)=>{const n=T(e),o=x.get(n).retain();return void 0!==t&&Object.assign(o,t),o},e.componentTypePools=x,e.createArchetype=w,e.createComponentBase=A,e.createComponentPool=j,e.createEffect=E,e.createQuery=(...e)=>function e(o){var r,s;const c=o.select.length,i=null!==(r=o.filters)&&void 0!==r?r:{not:new Set},l=o.select.map(e=>T(e)).sort((e,t)=>e-t),a=(null!==(s=o.include)&&void 0!==s?s:o.select).map(e=>T(e)),u=[];let d=o.context;const f=(e,t)=>{if(q(l,i,e)){const n=a.map(t=>e.table[e.signature.indexOf(t)]);t.push([e.entities,n,e.indices])}},p=e=>{const t=O.worlds[e],n=[];return u[e]=n,t.storage.archetypes.forEach(e=>f(e,n)),t.storage.archetypeCreated.subscribe(e=>f(e,n)),n},h=k(()=>[],e=>(v(e),e),1e3),_=e=>{const o=null!=d?d:O.currentWorldId;t(null!==o&&-1!==o,R,n.Query);const r=u[o]||p(o),s=h.retain();for(let t=0;t<r.length;t++){const[n,o]=r[t];for(let t=0;t<n.length;t++){for(let e=0;e<c;e++)s[e]=o[e][t];e(n[t],s)}}h.release(s)};return _.signature=l,_.filters=i,_.not=(...t)=>e({...o,filters:{not:new Set(t.map(e=>O.schemaIndex.get(e)).filter(e=>"number"==typeof e))}}),_.select=(...t)=>e({...o,include:t}),_.get=(e,t=[])=>{const n=null!=d?d:O.currentWorldId,o=u[n];for(let n=0;n<o.length;n++){const[,r,s]=o[n],c=s[e];if(void 0!==c){for(let e=0;e<r.length;e++)t[e]=r[e][c];return t}}throw new Error("Failed to get components of query: entity does not match query")},_.bind=t=>e({...o,context:t.id}),_.test=e=>{const t=null!=d?d:O.currentWorldId,n=u[t];for(let t=0;t<n.length;t++){if(void 0!==n[t][2][e])return!0}return!1},_.matchesArchetype=e=>q(l,i,e),_[Symbol.iterator]=()=>{const e=null!=d?d:O.currentWorldId;t(null!==e&&-1!==e,R,n.Query);return(u[e]||p(e))[Symbol.iterator]()},_.equals=e=>{if(e.signature.length!==l.length)return!1;for(let t=0;t<e.signature.length;t++)if(e.signature[t]!==l[t])return!1;if(e.filters.not.size!==i.not.size)return!1;let t=!0;return e.filters.not.forEach(e=>t=t&&i.not.has(e)),t},_.match=(e,t=[])=>{for(let e=0;e<a.length;e++)t[e]=null;for(let n=0;n<e.length;n++){const o=e[n],r=a.indexOf(o.__type__);-1!==r&&(t[r]=o)}return t},_}({select:e}),e.createRef=(e,t={})=>E(t=>{const n=e(t);return()=>B(n)},t),e.createStorage=K,e.createTopic=()=>{const e=[],t=[];return{*[Symbol.iterator](){for(let e=0;e<t.length;e++)yield t[e]},push:t=>e.push(t),pushImmediate:e=>t.push(e),flush:()=>{v(t);for(let n=e.length-1;n>=0;n--)t[n]=e.pop()},clear:()=>{v(e),v(t)}}},e.createWorld=function(n={}){var o,r;const{topics:s=[]}=n,c=[],i=[],l=k(()=>[],e=>(v(e),e),1e3),a=new Set,u=K({snapshot:null===(o=n.snapshot)||void 0===o?void 0:o.storage});let d=0,f=0;function p(...e){const t=l.retain();for(let n=0;n<e.length;n++)t[n]=e[n];return t}function h(e){const t=x.get(e.__type__);t&&t.release(e)}function _(e){c.push(e),e[U]=f++}function g(e,t){u.attachComponents(e,t)}function y(e,n){const o=[];for(let r=0;r<n.length;r++){const s=n[r],c=u.getComponentsBySchemaId(e,s);t(null!==c,"Failed to detach component: entity does not have component of type "+s),o.push(c)}u.detachBySchemaId(e,n),o.forEach(h)}function m(e){u.clearComponents(e)}function b(t){switch(t[0]){case e.DeferredOpType.Attach:!function(e){const[,t,n]=e;g(t,n)}(t);break;case e.DeferredOpType.Detach:!function(e){const[,t,n]=e;y(t,n)}(t);break;case e.DeferredOpType.Destroy:!function(e){const[,t]=e;m(t)}(t)}l.release(t)}null===(r=n.systems)||void 0===r||r.forEach(_);const S=O.worldIds++,I={id:S,storage:u,latestStep:-1,latestStepData:null,latestSystem:-1,attach:function(t,...n){i.push(p(e.DeferredOpType.Attach,t,n))},attachImmediate:g,addSystem:_,addTopic:function(e){s.push(e)},create:function(...t){const n=d++;return t.length>0&&i.push(p(e.DeferredOpType.Attach,n,t)),n},destroy:function(t){a.has(t)||(i.push(p(e.DeferredOpType.Destroy,t)),a.add(t))},destroyImmediate:m,get:function(e,t){T(t);const n=u.getComponentsBySchema(e,t);if(null===n)throw new Error("Failed to get component: entity does not have component");return n},getSnapshot:function(){return{storage:u.getSnapshot()}},has:function(e,t){return T(t),u.hasComponentOfSchema(e,t)},detach:function(t,...n){if(0===n.length)return;const o=n.map(e=>{var t;return"number"==typeof e?e:null!==(t=O.schemaIndex.get(e))&&void 0!==t?t:e.__type__});i.push(p(e.DeferredOpType.Detach,t,o))},detachImmediate:y,removeSystem:function(e){const t=c.indexOf(e);t>-1&&c.splice(t,1)},removeTopic:function(e){const t=s.indexOf(e);t>-1&&s.splice(t,1)},reset:function(){for(a.clear();i.length>0;)l.release(i.pop());v(i),v(c),s.forEach(e=>e.clear()),v(s),d=0,I.latestStep=-1,I.latestStepData=null,I.latestSystem=-1;for(let e=0;e<u.archetypes.length;e++){const t=u.archetypes[e];for(let e=0;e<t.signature.length;e++){const n=t.table[e],o=x.get(t.signature[e]);for(let e=0;e<n.length;e++){const t=n[e];null==o||o.release(t)}}}u.reset()},step:function(e){let t=O.currentWorldId;O.currentWorldId=S,I.latestStepData=e;for(let e=0;e<i.length;e++)b(i[e]);v(i);for(let e=0;e<s.length;e++)s[e].flush();for(let e=0;e<c.length;e++){const t=c[e];I.latestSystem=t[U],t(I)}a.clear(),I.latestStep++,O.currentWorldId=t},tryGet:function(e,t){return T(t),u.getComponentsBySchema(e,t)}};return O.worlds.push(I),I},e.isComponentOf=function(e,t){return e.__type__===O.schemaIndex.get(t)},e.mapOf=(e,t)=>({__kind__:c.Map,__type__:e,__key__:t}),e.number=l,e.objectOf=e=>({__kind__:c.Object,__type__:e}),e.registerSchema=T,e.setOf=e=>({__kind__:c.Set,__type__:e}),e.string=a,e.useInterval=P,e.useJson=Q,e.useMonitor=F,e.useRef=B,e.useRequest=G,e.useTimer=M,Object.defineProperty(e,"__esModule",{value:!0})}));
