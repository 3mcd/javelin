!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Javelin={})}(this,(function(e){"use strict";function t(e){const t=e.length,n=[],o=[],r=[],c=[];for(let e=0;e<t;e++)n[e]=[];let i=-1;return{layout:e,table:n,indices:r,entities:o,insert:function(t,s){i++;for(let t=0;t<s.length;t++){const o=s[t],r=e.indexOf(o.type);n[r][i]=o}o[i]=t,r[t]=i,c[i]=t},remove:function(e){const t=r[e];if(t===i)for(const e of n)e[i]=null;else for(const e of n)e[t]=e[i],e[i]=null;o[t]=o[i],c[t]=c[i],r[o[i]]=t,r[e]=-1,o.pop(),i--},entitiesByIndex:c}}function n(e){return t=>({componentType:t,componentPredicate:e()})}const o=n(()=>(e,{attached:t})=>t.has(e)),r=n(()=>(e,{isChanged:t})=>t(e)),c=n(()=>(e,{detached:t})=>t.has(e));function i(e,t,n){const o=[],r=()=>{for(let t=0;t<n;t++)o.push(e())};return{allocate:r,retain:()=>(o.length||r(),o.pop()),release:e=>{o.push(t(e))}}}const s=Symbol("world_storage"),l=Symbol("is_data_type");function a(e){return{...e,[l]:!0}}function u(e){return"object"==typeof e&&null!==e&&e[l]}function p(e,t){for(const n in t){const o=t[n];if(u(o))e[n]=o.create(void 0);else if("type"in o&&u(o.type)){const{type:t,defaultValue:r}=o;e[n]=t.create(r)}else p(e,o)}return e}function f(e,t){for(const n in t){const o=t[n];if(u(o))o.reset(e,n,void 0);else if("type"in o&&u(o.type)){const{type:t,defaultValue:r}=o;t.reset(e,n,r)}else f(e,o)}return e}function y(e,t){return i(()=>p({type:e.type,_v:0},e.schema),t=>f(t,e.schema),t)}function d(...e){}function h(e){for(;e.length>0;)e.pop()}function m(e=0,t=d){return Array(e).fill(void 0).map((e,n)=>t(n))}const g=a({name:"number",create:(e=0)=>e,reset(e,t,n=0){e[t]=n}}),b=a({name:"boolean",create:(e=!1)=>e,reset(e,t,n=!1){e[t]=n}}),O=a({name:"string",create:(e="")=>e,reset(e,t,n=""){e[t]=n}}),w=({poolSize:e=1e3}={})=>{const t=new Map,n=new Map,o=i(()=>[],e=>(h(e),e),e),r=i(()=>new Map,e=>(e.clear(),e),e);return{peek:function(e){return t.get(e)||null},proxy:function(e){let c=n.get(e),i=t.get(e);return i||(i=o.retain(),t.set(e,i)),c||(c=r.retain(),c.set("",new Proxy(e,function e(t,n,o,r=""){return{get(c,i){const s=c[i];if("object"==typeof(l=c[i])&&null!==l){const c=`${r}.${i}`;let l=o.get(c);return l||(l=new Proxy(s,e(t,n,o,c)),o.set(c,l)),l}var l;return s},set(e,t,c){const i=e[t],s=`${r}.${t}`;if(Array.isArray(e)&&"length"===t&&c<i){let e=i-1;for(;e-- >=c;)o.delete(`${r}.${e}`)}return n.push(s,c),e[t]=c,!0},deleteProperty(e,t){const n=`${r}.${t}`;return o.delete(n),delete e[t],!0}}}(e,i,c))),n.set(e,c)),c.get("")},reset:function(){t.forEach(e=>h(e))},revoke:function(e){const c=t.get(e),i=n.get(e);c&&i&&(r.release(i),o.release(c),n.delete(e),t.delete(e))}}};function T(e,t){if(e.find(e=>e.type===t))throw new Error(`Cannot attach component with type ${t} â€” entity already has component of type.`)}function C(){const e=w(),n=[],o=[];function r(e){let o=function(e){const t=e.length;for(let o=0;o<n.length;o++){const r=n[o],{layout:c}=r;if(c.length!==t)continue;let i=!0;for(let n=0;n<t;n++)if(-1===c.indexOf(e[n].type)){i=!1;break}if(i)return r}return null}(e);return o||(o=t(e.map(e=>e.type)),n.push(o)),o}function c(e){const t=o[e];return function(e){if(void 0===e)throw new Error("Failed to locate entity. Entity does not exist.");if(null===e)throw new Error("Failed to locate entity. Entity has been removed.")}(t),n[t]}function i(e,t,c){e.remove(t);const i=r(c);i.insert(t,c),o[t]=n.indexOf(i)}function s(e,t){const n=c(e),o=n.indices[e];let r=t.slice();for(let e=0;e<n.layout.length;e++)T(t,n.layout[e]),r.push(n.table[e][o]);i(n,e,r)}function l(t,n){const o=c(t),r=o.indices[t];let s=[];for(let t=0;t<o.layout.length;t++){const c=o.layout[t],i=o.table[t][r];n.includes(c)?e.revoke(i):s.push(i)}0!==s.length?i(o,t,s):a(t)}function a(t){const n=c(t),r=f(t);for(let t=0;t<r.length;t++)e.revoke(r[t]);n.remove(t),o[t]=null}const u=[];function p(t){return e.proxy(t)}function f(e){const t=c(e),n=t.indices[e],o=[];for(let e=0;e<t.table.length;e++)o.push(t.table[e][n]);return o}return{archetypes:n,create:function(e,t){const c=r(t);return c.insert(e,t),o[e]=n.indexOf(c),e},destroy:a,findComponent:function(e,t){const n=c(e),o=n.layout.indexOf(t.type);!function(e){if(-1===e)throw new Error("Failed to find component. Component could not exist with entity.")}(o);const r=n.indices[e];return n.table[o][r]},getComponentsOfEntity:f,getMutableComponent:p,resetMutationCache:function(){e.reset()},insert:s,isChanged:function(t){const n=e.peek(t);return!!n&&n.length>0},remove:function(e,t){l(e,t.map(e=>e.type))},removeByTypeIds:l,upsert:function(e,t){const n=c(e),o=n.indices[e];for(let e=0;e<t.length;e++){const r=t[e],{type:c}=r,i=n.layout.indexOf(c);if(-1===i)u.push(r);else{const e=p(n.table[i][o]);Object.assign(e,r)}}u.length>0&&s(e,u),h(u)}}}var v;(v=e.WorldOpType||(e.WorldOpType={}))[v.Spawn=0]="Spawn",v[v.Attach=1]="Attach",v[v.Detach=2]="Detach",v[v.Mutate=3]="Mutate",v[v.Destroy=4]="Destroy";e.$isDataType=l,e.$worldStorageKey=s,e.array=e=>a({name:"array",create:(e=[])=>e,reset(e,t,n){void 0!==n?e[t]=n.slice():h(e[t])}}),e.arrayOf=m,e.attached=o,e.boolean=b,e.changed=r,e.createArchetype=t,e.createComponentFilter=n,e.createComponentPool=y,e.createComponentType=function(e){return e},e.createDataType=a,e.createStorage=C,e.createTopic=()=>{const e=[],t=[];return{*[Symbol.iterator](){for(let e=0;e<t.length;e++)yield t[e]},push:t=>e.push(t),pushImmediate:e=>t.push(e),flush:()=>{h(t);for(let n=e.length-1;n>=0;n--)t[n]=e.pop()}}},e.createWorld=(t={})=>{const{systems:n=[],componentTypes:o=[],componentPoolSize:r=1e3}=t,c=[],l=[],a=i(()=>[],e=>(h(e),e),1e3),u=new Map,f=C(),d=new Set,m=new Set,g=new Set,b=[];let O=0;for(let e=0;e<o.length;e++)S(o[e]);function w(t){switch(t[0]){case e.WorldOpType.Spawn:!function(e){const[,t,n]=e;for(let e=0;e<n.length;e++)g.add(n[e]);f.create(t,n)}(t);break;case e.WorldOpType.Attach:!function(e){const[,t,n]=e;for(let e=0;e<n.length;e++)g.add(n[e]);f.insert(t,n)}(t);break;case e.WorldOpType.Detach:!function(e){const[,t,n]=e,o=f.getComponentsOfEntity(t);for(let e=0;e<o.length;e++){const t=o[e];n.includes(t.type)&&T(t)}f.removeByTypeIds(t,n)}(t);break;case e.WorldOpType.Destroy:!function(e){const[,t]=e;d.add(t)}(t)}l.push(t)}function T(e){const t=u.get(e.type);m.delete(e),t&&t.release(e)}function v(e){f.getComponentsOfEntity(e).forEach(T),f.destroy(e)}function x(e,t){return f.findComponent(e,t)}function S(e,t=r){if(b.includes(e))throw new Error(`Tried to register componentType with type id ${e.type} more than once.`);b.push(e),u.set(e.type,y(e,t))}const E={[s]:f,addSystem:function(e){n.push(e)},applyOps:function(t){for(let n=0;n<t.length;n++){const o=t[n];if(o[0]===e.WorldOpType.Detach){const[,e,t]=o,n=f.getComponentsOfEntity(e);for(let e=0;e<n.length;e++){const o=n[e];t.includes(o.type)&&m.add(o)}}else if(o[0]===e.WorldOpType.Destroy){const[,e]=o,t=f.getComponentsOfEntity(e);for(let e=0;e<t.length;e++)m.add(t[n])}w(o)}},attach:function(t,...n){const o=a.retain();o[0]=e.WorldOpType.Attach,o[1]=t,o[2]=n,c.push(o)},attached:g,component:function(e,...t){const n=u.get(e.type),o=n?n.retain():p({type:e.type},e.schema);return e.initialize&&e.initialize(o,...t),o},componentTypes:b,destroy:function(t){const n=a.retain();n[0]=e.WorldOpType.Destroy,n[1]=t;const o=f.getComponentsOfEntity(t);for(let e=0;e<o.length;e++)m.add(o[e]);c.push(n)},detach:function(t,...n){const o=a.retain();o[0]=e.WorldOpType.Detach,o[1]=t,o[2]=n.map(e=>e.type);for(let e=0;e<n.length;e++)m.add(n[e]);c.push(o)},detached:m,getComponent:x,getMutableComponent:f.getMutableComponent,isChanged:f.isChanged,ops:l,registerComponentType:S,spawn:function(...t){const n=O++,o=a.retain();return o[0]=e.WorldOpType.Spawn,o[1]=n,o[2]=t,c.push(o),n},tick:function(e){for(f.resetMutationCache();l.length>0;)a.release(l.pop());for(d.forEach(v),d.clear(),g.clear();c.length>0;)w(c.pop());for(let t=0;t<n.length;t++)n[t](E,e)},tryGetComponent:function(e,t){try{return x(e,t)}catch(e){return null}}};return E},e.detached=c,e.initializeComponentFromSchema=p,e.isComponentOf=function(e,t){return e.type===t.type},e.isDataType=u,e.mutableEmpty=h,e.mutableRemove=function(e,t){const n=e.indexOf(t);return-1!==n&&(e.splice(n,1),!0)},e.mutableRemoveUnordered=function(e,t){const n=e.length,o=e.indexOf(t);if(-1===o)return!1;const r=e.pop();return o<n-1&&(e[o]=r),!0},e.noop=d,e.number=g,e.query=function(...e){const t=e.map(e=>"componentPredicate"in e?e.componentPredicate:null),n=e.length,o=e.map(e=>"componentType"in e?e.componentType.type:e.type),r=m(n),c=[-1,r],i=[];let l,a,u,p=-1,f=-1;const y={value:c,done:!1};function d(){const{table:e,entitiesByIndex:o}=u,[s]=e;e:for(;s[++f];){let s=!0;c[0]=o[f];for(let o=0;o<n;o++){const n=t[o],c=e[i[o]][f];if(s=n?n(c,l):!l.detached.has(c),!s)continue e;r[o]=c}return}g()}function g(){let e;e:for(;e=a[++p];){const{layout:t}=e;u=e,f=-1;for(let e=0;e<n;e++){const n=t.indexOf(o[e]);if(-1===n)continue e;i[e]=n}return void d()}y.done=!0,c[0]=-1,h(r)}const b={next:()=>(null===u?g():d(),y)},O={[Symbol.iterator]:()=>b};return e=>(l=e,a=e[s].archetypes,u=null,p=-1,f=-1,y.done=!1,O)},e.resetComponentFromSchema=f,e.string=O,Object.defineProperty(e,"__esModule",{value:!0})}));
