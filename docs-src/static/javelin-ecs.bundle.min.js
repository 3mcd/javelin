!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Javelin={})}(this,(function(e){"use strict";function t(e,t="",n){if(!e)throw new Error(void 0!==n?`${r[n]}: ${t}`:t)}var n;!function(e){e[e.Internal=0]="Internal",e[e.Query=1]="Query"}(n||(n={}));const r={[n.Internal]:"Internal Error",[n.Query]:"Query Error"},o=Symbol("javelin_model_flat"),s=Symbol("javelin_model_struct");var i,c;!function(e){e[e.Primitive=0]="Primitive",e[e.Array=1]="Array",e[e.Object=2]="Object",e[e.Set=3]="Set",e[e.Map=4]="Map"}(i||(i={})),function(e){e.Number="number",e.Boolean="boolean",e.String="string",e.Dynamic="dynamic"}(c||(c={}));const l={__kind__:i.Primitive,__type__:c.Number,create:()=>0,reset:(e,t)=>e[t]=0},a={__kind__:i.Primitive,__type__:c.String,create:()=>"",reset:(e,t)=>e[t]=0},u={__kind__:i.Primitive,__type__:c.Boolean,create:()=>!1,reset:(e,t)=>e[t]=0},d=(i.Primitive,c.Dynamic,e=>"__kind__"in e&&e.__kind__===i.Primitive),f=e=>"__kind__"in e&&e.__kind__===i.Array,p=e=>"__kind__"in e&&e.__kind__===i.Object;const h=(e,t)=>e.localeCompare(t),_=(e,r,o,c)=>{const l=++o,a="__kind__"in r?r.__kind__:s,u={id:l,lo:l,hi:-1,inCollection:e.inCollection||e.kind===i.Array||e.kind===i.Object||e.kind===i.Set||e.kind===i.Map,kind:a};let f;return a===s?(f={...u,edges:[],keys:{},idsByKey:{}},o=y(r,f,o)):d(r)?f={...u,type:r}:(f={...u},o=_(f,r.__type__,o)),f.hi=o,c?(f.key=c,t(e.kind===s,"expected target node to be struct",n.Internal),function(e){t("key"in e,"",n.Internal)}(f),e.edges.push(f),e.keys[f.key]=f,e.idsByKey[f.key]=l):(t(e.kind===i.Array||e.kind===i.Object||e.kind===i.Set||e.kind===i.Map,"expected target node to be collection but got "+String(e.kind),n.Internal),e.edge=f),o},y=(e,t,n=-1)=>{const r=Object.keys(e).sort(h);for(let o=0;o<r.length;o++){const s=r[o],i=e[s];n=_(t,i,n,s)}return t.hi=n,n},g=e=>{const t={[o]:{}};return e.forEach((e,n)=>{const r={edges:[],hi:1/0,lo:-1,id:-1,idsByKey:{},inCollection:!1,keys:{},kind:s};y(e,r),t[n]=r}),Object.defineProperty(t,o,{enumerable:!1,writable:!1,value:b(t)}),t},m=(e,t)=>{switch(t[e.id]=e,e.kind){case i.Array:case i.Object:case i.Set:case i.Map:m(e.edge,t);break;case s:for(let n=0;n<e.edges.length;n++)m(e.edges[n],t)}},b=e=>{const t={};for(const n in e){const r={};m(e[n],r),t[n]=r}return t};function k(e){for(;e.length>0;)e.pop()}function v(e,t,n){const r=[],o=()=>{for(let t=0;t<n;t++)r.push(e(s))},s={allocate:o,retain:()=>(r.length||o(),r.pop()),release:e=>{r.push(t(e))}};return s}const w=()=>{const e=[];return{subscribe:t=>(e.push(t),()=>function(e,t){const n=e.length,r=e.indexOf(t);if(-1===r)return!1;const o=e.pop();return r<n-1&&(e[r]=o),!0}(e,t)),dispatch:(t,n,r,o)=>{for(let s=0;s<e.length;s++)e[s](t,n,r,o)}}};function I(e){const t="snapshot"in e?e.snapshot:null,n=t?Object.keys(t.indices).map(Number):[],r=t?function(e){const t=[];for(const n in e){const r=parseInt(n,10);isNaN(r)||(t[r]=e[n])}return t}(t.indices):[],o=("signature"in e?e.signature:e.snapshot.signature).slice().sort((e,t)=>e-t),s=t?t.table.map(e=>e.slice()):o.map(()=>[]),i=o.reduce((e,t,n)=>(e[t]=n,e),[]);return{entities:n,indices:r,signature:o,signatureInverse:i,table:s}}function O(e){const{signature:t,signatureInverse:n,entities:r,indices:o,table:s}=I(e),i=w(),c=w();return{entities:r,indices:o,insert:function(e,t){for(let e=0;e<t.length;e++){const r=t[e],o=n[r.__type__];s[o].push(r)}o[e]=r.push(e)-1,i.dispatch(e)},inserted:i,remove:function(e){const t=r.length,n=o[e],i=r.pop();if(delete o[e],n===t-1)for(const e of s)e.pop();else{for(const e of s)e[n]=e.pop();r[n]=i,o[i]=n}c.dispatch(e)},removed:c,signature:t,signatureInverse:n,table:s}}const S={schemaIndex:new WeakMap,model:{[o]:{}},worlds:[],currentWorldId:-1};let T=0;function x(e){return Object.defineProperties({},{__type__:{value:S.schemaIndex.get(e),writable:!1,enumerable:!0}})}const A=new Map;function D(e,t){return v(()=>function e(t,n){for(const r in n){const o=n[r];d(o)?t[r]=o.create():o.__kind__===i.Array?t[r]=[]:o.__kind__===i.Object?t[r]={}:t[r]=e({},o)}return t}(x(e),e),t=>function e(t,n){for(const r in n){const o=n[r];if(d(o))o.reset(t,r,void 0);else if(f(o))k(t[r]);else if(p(o)){const e=t[r];for(const n in e)delete t[n]}else e(t[r],o)}return t}(t,e),t)}const C=new Map;function j(e,t,n=1e3){let r=S.schemaIndex.get(e);if(void 0!==r)return r;if(r=t,void 0===r){for(;C.has(T);)T++;r=T}else if(C.has(r))throw new Error("Failed to register component type: a component with same id is already registered");return A.set(r,D(e,n)),C.set(r,e),S.schemaIndex.set(e,r),S.model=g(C),r}function E(e,t={throw:!1,global:!1}){const{global:n}=t,r=[];let o,s,i,c,l,a=-1;return function(...t){c=S.currentWorldId;const u=S.worlds[c],d=u.state.currentTick;l=n?0:u.state.currentSystem;let f=r[c];void 0===r[c]&&(f=r[c]=[]);let p=f[l];if(void 0===p&&(p=f[l]={cells:[],cellCount:-1}),!0===n||s!==c&&void 0!==s)a=0;else if(void 0===i||o===d&&i===l)a++;else{let e=f[i];if(-1!==e.cellCount&&e.cellCount!==a)throw new Error(`Failed to execute effect: encountered too ${e.cellCount>a?"few":"many"} effects this tick`);e.cellCount=a,a=0}let h=p.cells[a];if(h||(h=p.cells[a]={executor:e(u),lockGlobal:!1,lockAsync:!1,lockGlobalTick:-1,state:null}),n&&(h.lockGlobalTick!==u.state.currentTick?(h.lockGlobal=!1,h.lockGlobalTick=u.state.currentTick):h.lockGlobal=!0),h.lockGlobal||h.lockAsync)return h.state;const _=h.executor(...t);var y;return"object"==typeof(y=_)&&null!==y&&"then"in y?(h.lockAsync=!0,_.then(e=>h.state=e).catch(e=>console.error("Uncaught error in effect: "+e.message,e)).then(()=>h.lockAsync=!1)):h.state=_,o=d,s=c,i=l,h.state}}const M=E(()=>{let e=!0;const t={value:null};return function(n){return e&&(t.value=n,e=!1),t}}),P=E(()=>{let e,t=0;return function(n,r=!1){return r&&(t=0,clearTimeout(e)),0===t&&(t=1,e=setTimeout(()=>{t=2},n)),2===t}}),W=E(()=>function(e){const t=M(!1),n=P(e,t.value);return t.value=n,n}),B=v(()=>[-1,[]],e=>(e[0]=-1,k(e[1]),e),1e3),F=E(e=>{const{storage:{entityRelocated:t,archetypes:[n]}}=e;let r=[],o=[],s=[],i=[],c=null;return t.subscribe((function(e,t,s,i){if(null===c)return;const l=c.matchesArchetype(s),a=c.matchesArchetype(t);if(a&&s===n){const t=r.findIndex(([t])=>t===e);-1!==t&&r.splice(t,1)}if(l!==a){const t=B.retain();t[0]=e,c.match(i,t[1]),(l?r:o).push(t)}})),function(e,t,n){let l;for(c!==e&&(e=>{c=e,k(r),k(o),k(s),k(i);for(const[t]of e)for(let n=0;n<t.length;n++){const o=t[n],s=B.retain();s[0]=o,e.get(o,s[1]),r.push(s)}})(e),k(s),k(i);void 0!==(l=r.pop());)s.push(l);for(;void 0!==(l=o.pop());)i.push(l);if(void 0!==t)for(let e=0;e<s.length;e++){const n=s[e];t(n[0],n[1]),B.release(n)}if(void 0!==n)for(let e=0;e<i.length;e++){const t=i[e];n(t[0],t[1]),B.release(t)}}}),G=E(()=>{let e,t={response:null,error:null,done:!1},n=!1,r=new window.AbortController;return function(o,s,i=void 0!==e&&o!==e){return(null===o||i)&&(r.abort(),r=new AbortController),null===o?t:(i&&(t={response:t.response,error:null,done:!1}),t.done||n||(n=!0,e=o,fetch(o,{...s,signal:r.signal}).then(e=>{t={response:e,error:null,done:!0}}).catch(e=>{t={response:t.response,error:e,done:!0}}).then(()=>{n=!1})),t)}}),N=E(()=>{let e;return function(...t){const n=M(null),r=G(...t);return r.response&&r.response!==n.value&&(r.response.json().then(t=>{e=t}),n.value=r.response),{...r,response:e||null}}}),Q="a query must be executed within a system or bound to a world using Query.bind()",R=(e,t,n)=>((e,t)=>{let n=0,r=0;if(e.length<t.length)return!1;for(;n<e.length&&r<t.length;)if(e[n]<t[r])n++;else{if(e[n]!==t[r])return!1;n++,r++}return r===t.length})(n.signature,e)&&n.signature.every(e=>!t.not.has(e));function q(e={}){const n=w(),r=w(),o=e.snapshot?e.snapshot.archetypes.map(e=>O({snapshot:e})):[O({signature:[]})],s=[];function i(e){let t=function(e){const t=e.length;for(let n=0;n<o.length;n++){const r=o[n],{signature:s}=r;if(s.length!==t)continue;let i=!0;for(let n=0;n<t;n++)if(-1===s.indexOf(e[n].__type__)){i=!1;break}if(i)return r}return null}(e);return t||(t=O({signature:e.map(e=>e.__type__)}),o.push(t),n.dispatch(t)),t}function c(e){const t=s[e];if(void 0===t)throw new Error("Failed to locate entity: entity has not been created");if(null===t)throw new Error("Failed to locate entity: entity has been removed");return o[t]}function l(e,t,n,c){e.remove(t);const l=i(n);l.insert(t,n),s[t]=o.indexOf(l),r.dispatch(t,e,l,c)}function a(e,t){const n=c(e),r=n.indices[e],o=t.slice();for(let e=0;e<n.signature.length;e++){const s=n.signature[e];t.find(e=>e.__type__===s)||o.push(n.table[e][r])}l(n,e,o,t)}function u(e,t){const n=c(e),r=n.indices[e];let o=[],s=[];for(let e=0;e<n.signature.length;e++){const i=n.signature[e],c=n.table[e][r];(t.includes(i)?s:o).push(c)}l(n,e,o,s)}const d=[];function f(e,t){const n=c(e),r=n.signatureInverse[t];if(void 0===r)return null;const o=n.indices[e];return n.table[r][o]}return{archetypeCreated:n,archetypes:o,clear:function(){k(o),k(s)},create:function(e,t){const n=i(t);return n.insert(e,t),s[e]=o.indexOf(n),r.dispatch(e,o[0],n,t),e},destroy:function(e){u(e,c(e).signature),s[e]=null},entityRelocated:r,findComponent:function(e,n){const r=S.schemaIndex.get(n);return t(void 0!==r,"Failed to locate component: schema not registered."),f(e,r)},findComponentBySchemaId:f,getEntityComponents:function(e){const t=c(e),n=t.indices[e],r=[];for(let e=0;e<t.table.length;e++)r.push(t.table[e][n]);return r},hasComponent:function(e,n){const r=c(e),o=S.schemaIndex.get(n);return t(void 0!==o,"Failed to locate component: schema not registered."),r.signature.includes(o)},insert:a,remove:u,snapshot:function(){return{archetypes:o.map(e=>{return{signature:e.signature.slice(),table:e.table.map(e=>e.map(e=>({...e}))),indices:(t=e.indices,t.reduce((e,t,n)=>(e[n]=t,e),{}))};var t})}},upsert:function(e,t){const n=c(e),r=n.indices[e];k(d);for(let e=0;e<t.length;e++){const o=t[e],s=n.signatureInverse[o.__type__];void 0===s?d.push(o):Object.assign(n.table[s][r],o)}d.length>0&&a(e,d)}}}var J;(J=e.DeferredOpType||(e.DeferredOpType={}))[J.Spawn=0]="Spawn",J[J.Attach=1]="Attach",J[J.Detach=2]="Detach",J[J.Mutate=3]="Mutate",J[J.Destroy=4]="Destroy",e.UNSAFE_internals=S,e.arrayOf=e=>({__kind__:i.Array,__type__:e}),e.boolean=u,e.component=(e,t)=>{const n=j(e),r=A.get(n).retain();return void 0!==t&&Object.assign(r,t),r},e.componentTypePools=A,e.createArchetype=O,e.createComponentBase=x,e.createComponentPool=D,e.createEffect=E,e.createQuery=(...e)=>function e(r){var o,s;const i=r.select.length,c=null!==(o=r.filters)&&void 0!==o?o:{not:new Set},l=r.select.map(e=>j(e)).sort((e,t)=>e-t),a=(null!==(s=r.include)&&void 0!==s?s:r.select).map(e=>j(e)),u=[];let d=r.context;const f=(e,t)=>{if(R(l,c,e)){const n=a.map(t=>e.table[e.signature.indexOf(t)]);t.push([e.entities,n,e.indices])}},p=e=>{const t=S.worlds[e],n=[];return u[e]=n,t.storage.archetypes.forEach(e=>f(e,n)),t.storage.archetypeCreated.subscribe(e=>f(e,n)),n},h=v(()=>[],e=>(k(e),e),1e3),_=e=>{const r=null!=d?d:S.currentWorldId;t(null!==r&&-1!==r,Q,n.Query);const o=u[r]||p(r),s=h.retain();for(let t=0;t<o.length;t++){const[n,r]=o[t];for(let t=0;t<n.length;t++){for(let e=0;e<i;e++)s[e]=r[e][t];e(n[t],s)}}h.release(s)};return _.not=(...t)=>e({...r,filters:{not:new Set(t.map(e=>S.schemaIndex.get(e)).filter(e=>"number"==typeof e))}}),_.select=(...t)=>e({...r,include:t}),_.get=(e,t=[])=>{const n=null!=d?d:S.currentWorldId,r=u[n];for(let n=0;n<r.length;n++){const[,o,s]=r[n],i=s[e];if(void 0!==i){for(let e=0;e<o.length;e++)t[e]=o[e][i];return t}}throw new Error("Failed to get components of query: entity does not match query")},_.bind=t=>e({...r,context:t.id}),_.test=e=>{const t=null!=d?d:S.currentWorldId,n=u[t];for(let t=0;t<n.length;t++){if(void 0!==n[t][2][e])return!0}return!1},_.matchesArchetype=e=>R(l,c,e),_[Symbol.iterator]=()=>{const e=null!=d?d:S.currentWorldId;t(null!==e&&-1!==e,Q,n.Query);return(u[e]||p(e))[Symbol.iterator]()},_.match=(e,t=[])=>{for(let e=0;e<a.length;e++)t[e]=null;for(let n=0;n<e.length;n++){const r=e[n],o=a.indexOf(r.__type__);-1!==o&&(t[o]=r)}return t},_}({select:e}),e.createRef=(e,t={})=>E(t=>{const n=e(t);return()=>M(n)},t),e.createStorage=q,e.createTopic=()=>{const e=[],t=[];return{*[Symbol.iterator](){for(let e=0;e<t.length;e++)yield t[e]},push:t=>e.push(t),pushImmediate:e=>t.push(e),flush:()=>{k(t);for(let n=e.length-1;n>=0;n--)t[n]=e.pop()},clear:()=>{k(e),k(t)}}},e.createWorld=function(t={}){var n,r;const{topics:o=[]}=t,s=[],i=[],c=v(()=>[],e=>(k(e),e),1e3),l=w(),a=w(),u=w(),d=w(),f=new Set,p=q({snapshot:null===(n=t.snapshot)||void 0===n?void 0:n.storage});let h={currentTickData:null,currentTick:0,currentSystem:0},_=0;function y(...e){const t=c.retain();for(let n=0;n<e.length;n++)t[n]=e[n];return t}function g(e,t){p.create(e,t),u.dispatch(e)}function m(e,t){p.insert(e,t),l.dispatch(e,t)}function b(e,t){const n=t.map(t=>p.findComponentBySchemaId(e,t)).filter(e=>Boolean(e));p.remove(e,t),a.dispatch(e,n)}function I(e){p.destroy(e),d.dispatch(e)}function O(t){switch(t[0]){case e.DeferredOpType.Spawn:!function(e){const[,t,n]=e;g(t,n)}(t);break;case e.DeferredOpType.Attach:!function(e){const[,t,n]=e;m(t,n)}(t);break;case e.DeferredOpType.Detach:!function(e){const[,t,n]=e;b(t,n)}(t);break;case e.DeferredOpType.Destroy:!function(e){const[,t]=e;I(t)}(t)}c.release(t)}function T(e){const t=A.get(e.__type__);t&&t.release(e)}function x(e){s.push(e),e.__JAVELIN_SYSTEM_ID__=0}null===(r=t.systems)||void 0===r||r.forEach(x),a.subscribe((e,t)=>t.forEach(T));const D={addSystem:x,addTopic:function(e){o.push(e)},attach:function(t,...n){i.push(y(e.DeferredOpType.Attach,t,n))},attachImmediate:m,destroy:function(t){f.has(t)||(i.push(y(e.DeferredOpType.Destroy,t)),f.add(t))},destroyImmediate:I,detach:function(t,...n){if(0===n.length)return;const r=n.map(e=>{var t;return"number"==typeof e?e:null!==(t=S.schemaIndex.get(e))&&void 0!==t?t:e.__type__});i.push(y(e.DeferredOpType.Detach,t,r))},detachImmediate:b,get:function(e,t){j(t);const n=p.findComponent(e,t);if(null===n)throw new Error("Failed to get component: entity does not have component");return n},has:function(e,t){return j(t),p.hasComponent(e,t)},id:-1,removeSystem:function(e){const t=s.indexOf(e);t>-1&&s.splice(t,1)},removeTopic:function(e){const t=o.indexOf(e);t>-1&&o.splice(t,1)},reserve:function(){return++_},reset:function(){for(k(i),k(s),f.clear(),h={currentTickData:null,currentTick:0,currentSystem:0},_=0;i.length>0;)c.release(i.pop());for(let e=0;e<p.archetypes.length;e++){const t=p.archetypes[e];for(let e=0;e<t.signature.length;e++){const n=t.table[e],r=A.get(t.signature[e]);for(let e=0;e<n.length;e++){const t=n[e];null==r||r.release(t)}}}p.clear()},snapshot:function(){return{storage:p.snapshot()}},spawn:function(...t){const n=_++;return i.push(y(e.DeferredOpType.Spawn,n,t)),n},spawnImmediate:g,state:h,storage:p,tick:function(e){let t=S.currentWorldId;S.currentWorldId=C,h.currentTickData=e;for(let e=0;e<i.length;e++)O(i[e]);k(i);for(let e=0;e<o.length;e++)o[e].flush();for(let e=0;e<s.length;e++){const t=s[e];D.state.currentSystem=t.__JAVELIN_SYSTEM_ID__,t(D)}f.clear(),h.currentTick++,S.currentWorldId=t},tryGet:function(e,t){return j(t),p.findComponent(e,t)},attached:l,detached:a,spawned:u,destroyed:d};let C=D.id=S.worlds.push(D)-1;return D},e.isComponentOf=function(e,t){return e.__type__===S.schemaIndex.get(t)},e.mapOf=(e,t)=>({__kind__:i.Map,__type__:e,__key__:t}),e.number=l,e.objectOf=e=>({__kind__:i.Object,__type__:e}),e.registerSchema=j,e.setOf=e=>({__kind__:i.Set,__type__:e}),e.string=a,e.useInterval=W,e.useJson=N,e.useMonitor=F,e.useRef=M,e.useRequest=G,e.useTimer=P,Object.defineProperty(e,"__esModule",{value:!0})}));
