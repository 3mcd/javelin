var e,t,n=Object.defineProperty,o=Object.defineProperties,r=Object.getOwnPropertyDescriptors,c=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,l=(e,t,o)=>t in e?n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,a=(e,t)=>{for(var n in t||(t={}))s.call(t,n)&&l(e,n,t[n]);if(c)for(var n of c(t))i.call(t,n)&&l(e,n,t[n]);return e},u=(e,t)=>o(e,r(t));import{W as f,P as d,O as p,S as h,a as y,V as m,A as g,D as b,B as v,b as w,c as S,M as I,d as k}from"./vendor.js";function C(e,t="",n){if(!e)throw new Error(void 0!==n?`${O[n]}: ${t}`:t)}(t=e||(e={}))[t.Internal=0]="Internal",t[t.Query=1]="Query";const O={[e.Internal]:"Internal Error",[e.Query]:"Query Error"},x=Symbol("javelin_field_kind"),T=Symbol("javelin_model_flat");var j,E;function q(e){for(;e.length>0;)e.pop();return e}(E=j||(j={}))[E.Number=0]="Number",E[E.String=1]="String",E[E.Boolean=2]="Boolean",E[E.Array=3]="Array",E[E.Object=4]="Object",E[E.Set=5]="Set",E[E.Map=6]="Map",E[E.Dynamic=7]="Dynamic";const A={[x]:j.Number,get:()=>0};function B(e){return x in e}function D(e,t,n=[]){let o,r={id:t.id,lo:t.id,hi:t.id,deep:n.length>0,traverse:n};if(t.id++,B(e))o=a(a({},r),e),"element"in o&&(o.element=D(o.element,t,"key"in o?[...n,o.key]:n));else{const c=Object.keys(e),s=[],i=[],l={},f={};for(let o=0;o<c.length;o++){const r=c[o],a=D(e[r],t,n);s[a.id]=r,l[r]=a,f[r]=a.id,i.push(a)}o=u(a({},r),{keys:c,keysByFieldId:s,fields:i,fieldsByKey:l,fieldIdsByKey:f})}return o.hi=t.id,o}function W(e,t){if(t[e.id]=e,B(e))"element"in e&&W(e.element,t);else for(let n=0;n<e.fields.length;n++)W(e.fields[n],t)}function P(e){const t={};for(const n in e)W(e[n],t[n]={});return t}function F(e){const t={};return e.forEach(((e,n)=>t[n]=D(e,{id:0}))),Object.defineProperty(t,T,{enumerable:!1,writable:!1,value:P(t)})}function z(e,t={}){for(const n in e){const o=e[n];let r;r=B(o)?o.get():z({},o),t[n]=r}return t}function M(e,t){for(const n in t){const o=t[n];B(o)?e[n]=o.get(e[n]):M(e[n],o)}return e}function _(e,t,n){const o=[],r=()=>{for(let t=0;t<n;t++)o.push(e(c))},c={allocate:r,retain:()=>(o.length||r(),o.pop()),release:e=>{o.push(t(e))}};return c}j.String,j.Boolean;const N=()=>{const e=[];return{subscribe:t=>(e.push(t),()=>function(e,t){const n=e.length,o=e.indexOf(t);if(-1===o)return!1;const r=e.pop();return o<n-1&&(e[o]=r),!0}(e,t)),dispatch:(t,n,o,r)=>{for(let c=0;c<e.length;c++)e[c](t,n,o,r)}}},Q={instanceTypeLookup:new WeakMap,model:{[T]:{}},schemaIndex:new WeakMap,schemaPools:new Map,worlds:[],currentWorldId:-1,worldIds:0},R=N();const $=Symbol("javelin_component_type"),L=Symbol("javelin_component_pool"),{schemaIndex:K,schemaPools:U,instanceTypeLookup:G}=Q;let V=0;function Y(e,t){return _((()=>z(e,function(e,t=!0){return Object.defineProperties({},{[$]:{value:K.get(e),writable:!1,enumerable:!1},[L]:{value:t,writable:!1,enumerable:!1}})}(e))),(t=>M(t,e)),t)}const H=new Map;function J(e,t,n=1e3){let o=K.get(e);if(void 0!==o)return o;if(o=t,void 0===o){for(;H.has(V);)V++;o=V}else if(H.has(o))throw new Error("Failed to register component type: a component with same id is already registered");var r;return n>0&&U.set(o,Y(e,n)),H.set(o,e),K.set(e,o),r=F(H),Q.model=r,R.dispatch(r),o}function X(e,t){try{e[$]=t,e[L]=!1}catch{}return e[$]!==t&&G.set(e,t),e}function Z(e,t){return X(e,J(t,void 0,0))}function ee(e){var t;const n=null!==(t=e[$])&&void 0!==t?t:G.get(e);if(void 0===n)throw new Error("Failed to get component type id: object is not a component");return n}function te(e,t={shared:!1}){const{shared:n}=t,o=[];let r,c,s,i,l,a=-1;return function(...t){i=Q.currentWorldId;const u=Q.worlds[i],f=u.latestTick;l=n?0:u.latestSystemId;let d=o[i];void 0===o[i]&&(d=o[i]=[]);let p=d[l];if(void 0===p&&(p=d[l]={cells:[],cellCount:-1}),!0===n||c!==i&&void 0!==c)a=0;else if(void 0===s||r===f&&s===l)a++;else{let e=d[s];if(-1!==e.cellCount&&e.cellCount!==a)throw new Error(`Failed to execute effect: encountered too ${e.cellCount>a?"few":"many"} effects this step`);e.cellCount=a,a=0}let h=p.cells[a];if(h||(h=p.cells[a]={executor:e(u),lockShare:!1,lockAsync:!1,lockShareTick:null,state:null}),n&&(h.lockShareTick!==u.latestTick?(h.lockShare=!1,h.lockShareTick=u.latestTick):h.lockShare=!0),h.lockShare||h.lockAsync)return h.state;const y=h.executor(...t);var m;return"object"==typeof(m=y)&&null!==m&&"then"in m?(h.lockAsync=!0,y.then((e=>h.state=e)).catch((e=>console.error(`Uncaught error in effect: ${e.message}`,e))).then((()=>h.lockAsync=!1))):h.state=y,r=f,c=i,s=l,h.state}}const ne=te((()=>{let e=!0;const t={value:null};return function(n){return e&&(t.value=n,e=!1),t}}));function oe(){const e=ne(!0),t=e.value;return e.value=!1,t}const re=_((()=>[-1,[],[]]),(e=>(e[0]=-1,q(e[1]),q(e[2]),e)),1e3),ce=te((e=>{const{storage:{entityRelocating:t,entityRelocated:n,archetypes:[o]}}=e,r=new Set;let c=[],s=[],i=[],l=[],a=null;return t.subscribe((function(e,t,n,i){if(null===a)return;const l=r.has(e),u=a.matchesType(t.type),f=a.matchesType(n.type);if(!(u&&(!f||n===o)))return;if(l){const t=c.findIndex((([t])=>t===e));return C(-1!==t),void function(e,t){const n=e.length;if(-1===t)return!1;const o=e.pop();t<n-1&&(e[t]=o)}(c,t)}const d=re.retain();d[0]=e,a.get(e,d[1]),a.match(i,d[2]),s.push(d)})),n.subscribe((function(e,t,n,o){if(null===a)return;const s=a.matchesType(t.type),i=a.matchesType(n.type);if(!s&&i){const t=re.retain();t[0]=e,a.get(e,t[1]),a.match(o,t[2]),c.push(t),r.add(e)}})),function(e,t,n){let o;for(a===e||(null==a?void 0:a.equals(e))||(e=>{a=e,q(c),q(s),q(i),q(l);for(const[t]of e)for(let n=0;n<t.length;n++){const o=t[n],r=re.retain();r[0]=o,e.get(o,r[1]),e.get(o,r[2]),c.push(r)}})(e),q(i),q(l);void 0!==(o=c.pop());)i.push(o);for(;void 0!==(o=s.pop());)l.push(o);if(r.clear(),void 0!==t)for(let r=0;r<i.length;r++){const e=i[r];t(e[0],e[1],e[2]),re.release(e)}if(void 0!==n)for(let r=0;r<l.length;r++){const e=l[r];n(e[0],e[1],e[2]),re.release(e)}}}));function se(e){return e.slice().sort(((e,t)=>e-t))}const ie="a query must be executed within a system or bound to a world using Query.bind()";function le(e,t,n){return function(e,t){let n=0,o=0;if(e.length<t.length)return!1;for(;n<e.length&&o<t.length;)if(e[n]<t[o])n++;else{if(e[n]!==t[o])return!1;n++,o++}return o===t.length}(t,e)&&t.every((e=>!n.not.has(e)))}function ae(t){var n,o;const r=t.select.length,c=null!==(n=t.filters)&&void 0!==n?n:{not:new Set},s=se(t.select.map((e=>J(e)))),i=(null!==(o=t.include)&&void 0!==o?o:t.select).map((e=>J(e))),l=[],f=_((()=>[]),(e=>(q(e),e)),1e3);let d=t.boundWorldId;function p(e,t){if(le(s,e.type,c)){const n=i.map((t=>e.table[e.type.indexOf(t)]));t.push([e.entities,n,e.indices])}}function h(e){const t=Q.worlds[e],n=[];return l[e]=n,t.storage.archetypes.forEach((e=>p(e,n))),t.storage.archetypeCreated.subscribe((e=>p(e,n))),n}let y=s;const m=function(t){const n=null!=d?d:Q.currentWorldId;C(null!==n&&-1!==n,ie,e.Query);const o=l[n]||h(n),c=f.retain();for(let e=0;e<o.length;e++){const[n,s]=o[e];for(let e=0;e<n.length;e++){for(let t=0;t<r;t++)c[t]=s[t][e];t(n[e],c)}}f.release(c)};return m[Symbol.iterator]=function(){const t=null!=d?d:Q.currentWorldId;return C(null!==t&&-1!==t,ie,e.Query),(l[t]||h(t))[Symbol.iterator]()},m.type=s,m.filters=c,m.not=function(...e){return ae(u(a({},t),{filters:{not:new Set(e.map((e=>Q.schemaIndex.get(e))).filter((e=>"number"==typeof e)))}}))},m.select=function(...e){return ae(u(a({},t),{include:e}))},m.get=function(e,t=[]){const n=null!=d?d:Q.currentWorldId,o=l[n];for(let r=0;r<o.length;r++){const[,n,c]=o[r],s=c[e];if(void 0!==s){for(let e=0;e<n.length;e++)t[e]=n[e][s];return t}}throw new Error("Failed to get components of query: entity does not match query")},m.bind=function(e){return ae(u(a({},t),{boundWorldId:e.id}))},m.test=function(e){const t=null!=d?d:Q.currentWorldId,n=l[t];for(let o=0;o<n.length;o++){if(void 0!==n[o][2][e])return!0}return!1},m.matchesType=function(e){return le(y,e,c)},m.equals=function(e){if(e.type.length!==s.length)return!1;for(let n=0;n<e.type.length;n++)if(e.type[n]!==s[n])return!1;if(e.filters.not.size!==c.not.size)return!1;let t=!0;return e.filters.not.forEach((e=>t=t&&c.not.has(e))),t},m.match=function(e,t=[]){for(let n=0;n<i.length;n++)t[n]=null;for(let n=0;n<e.length;n++){const o=e[n],r=i.indexOf(ee(o));-1!==r&&(t[r]=o)}return t},m}function ue(e){const t=Object.keys(e.indices).map(Number),n=function(e){const t=[];for(const n in e){const o=parseInt(n,10);isNaN(o)||(t[o]=e[n])}return t}(e.indices),o=se(e.type);return{entities:t,indices:n,type:o,table:function(e,t){return e.map(((e,n)=>{const o=t[n];return e.slice().map((e=>X(e,o)))}))}(e.table,o)}}function fe(e){const{table:t,indices:n,entities:o,type:r}=function(e){if("snapshot"in e)return ue(e.snapshot);const t=se(e.type),n=t.map((()=>[]));return{entities:[],indices:[],type:t,table:n}}(e),c=r.reduce(((e,t,n)=>(e[t]=n,e)),[]);return{entities:o,indices:n,insert:function(e,r){for(let n=0;n<r.length;n++){const e=r[n],o=c[ee(e)];t[o].push(e)}n[e]=o.push(e)-1},remove:function(e){const r=o.length,c=n[e],s=o.pop();if(delete n[e],c===r-1)for(const n of t)n.pop();else{for(const e of t)e[c]=e.pop();o[c]=s,n[s]=c}},type:r,typeInverse:c,table:t}}const de="Failed to locate component: schema not registered";function pe(e={}){const t=e.snapshot?e.snapshot.archetypes.map((e=>fe({snapshot:e}))):[fe({type:[]})],n=[],o=N(),r=N(),c=N();function s(e){let n=function(e){const n=e.length;e:for(let o=0;o<t.length;o++){const r=t[o],{type:c,typeInverse:s}=r;if(c.length===n){for(let t=0;t<n;t++)if(void 0===s[ee(e[t])])continue e;return r}}return null}(e);return null===n&&(n=fe({type:e.map(ee)}),t.push(n),c.dispatch(n)),n}function i(e){const t=n[e];return C(void 0!==t,"Failed to locate entity: entity has not been created"),C(null!==t,"Failed to locate entity: entity has been destroyed"),t}function l(e,t,c,i){const l=s(c);o.dispatch(t,e,l,i),e.remove(t),l.insert(t,c),n[t]=l,r.dispatch(t,e,l,i)}function u(e,c){const i=n[e];if(null==i){const i=s(c);o.dispatch(e,t[0],i,c),i.insert(e,c),n[e]=i,r.dispatch(e,t[0],i,c)}else{const t=i.indices[e],n=c.slice();for(let e=0;e<i.type.length;e++){const o=i.type[e];c.find((e=>ee(e)===o))||n.push(i.table[e][t])}l(i,e,n,c)}}function f(e,t){const n=i(e),o=[],r=[],c=n.indices[e];for(let s=0;s<n.type.length;s++){const e=n.type[s],i=n.table[s][c];(t.includes(e)?o:r).push(i)}l(n,e,r,o)}const d=[];function p(e,t){const n=i(e),o=n.typeInverse[t];if(void 0===o)return null;const r=n.indices[e];return n.table[o][r]}return{archetypeCreated:c,archetypes:t,attachComponents:u,attachOrUpdateComponents:function(e,t){const n=i(e),o=n.indices[e];q(d);for(let r=0;r<t.length;r++){const e=t[r],c=n.typeInverse[ee(e)];void 0===c?d.push(e):Object.assign(n.table[c][o],e)}d.length>0&&u(e,d)},clear:function(){q(t),q(n)},clearComponents:function(e){f(e,i(e).type),n[e]=null},detachBySchemaId:f,entityRelocated:r,entityRelocating:o,getComponentBySchemaId:p,getComponentBySchema:function(e,t){const n=Q.schemaIndex.get(t);return C(void 0!==n,de),p(e,n)},getAllComponents:function(e){const t=i(e),n=t.indices[e],o=[];for(let r=0;r<t.table.length;r++)o.push(t.table[r][n]);return o},createSnapshot:function(){return{archetypes:t.map((e=>{return{type:e.type.slice(),table:e.table.map((e=>e.map((e=>a({},e))))),indices:(t=e.indices,t.reduce(((e,t,n)=>(e[n]=t,e)),{}))};var t}))}},hasComponentOfSchema:function(e,t){const n=i(e),o=Q.schemaIndex.get(t);return C(void 0!==o,de),n.type.includes(o)}}}const he=Symbol("javelin_system_id");var ye,me;(me=ye||(ye={}))[me.Create=0]="Create",me[me.Attach=1]="Attach",me[me.Detach=2]="Detach",me[me.Destroy=3]="Destroy";const ge={x:A,y:A,z:A},be={x:A,y:A,z:A,w:A},ve={position:ge,quaternion:be},we={position:ge,quaternion:be},Se=document.getElementById("game"),Ie=new f({antialias:!0,canvas:Se}),ke=new d(45,1,.1,2e6),Ce=new p(ke,Ie.domElement),Oe=new h,xe=new y({gravity:new m(0,-9.81,0)});function Te(){const e=Se.parentElement,{width:t,height:n}=e.getBoundingClientRect();ke.aspect=t/n,ke.updateProjectionMatrix(),Ie.setSize(t,n)}Oe.add(new g(4210752),new b(16777215,.5)),window.addEventListener("resize",Te,!1),Te();const je=new v(new m(.5,.5,.5)),Ee=new w(1,1,1),qe=new v(new m(10,.5,10)),Ae=new w(20,1,20);function Be(e=new m(0,0,0),t=S.DYNAMIC,n=16711680,o=1){const r=new S({mass:o,type:t,position:e,shape:je}),c=new I({color:n}),s=new k(Ee,c);return[Z(r,ve),Z(s,we)]}function De(e=2){return(.5-Math.random())*e}const We=function(e={}){var t,n;const{topics:o=[]}=e,r=[],c=[],s=new Set,i=pe({snapshot:null===(t=e.snapshot)||void 0===t?void 0:t.storage});let l=0,a=0;function u(...e){const t=[];for(let n=0;n<e.length;n++)t[n]=e[n];return t}function f(e){const t=Q.schemaPools.get(ee(e));t&&Reflect.get(e,L)&&t.release(e)}function d(e){r.push(e),e[he]=a++}function p(e,t){i.attachComponents(e,t)}function h(e,t){const n=[];for(let o=0;o<t.length;o++){const r=t[o],c=i.getComponentBySchemaId(e,r);C(null!==c,`Failed to detach component: entity does not have component of type ${r}`),n.push(c)}i.detachBySchemaId(e,t),n.forEach(f)}function y(e){i.clearComponents(e)}function m(e){switch(e[0]){case ye.Attach:!function(e){const[,t,n]=e;p(t,n)}(e);break;case ye.Detach:!function(e){const[,t,n]=e;h(t,n)}(e);break;case ye.Destroy:!function(e){const[,t]=e;y(t)}(e)}}null===(n=e.systems)||void 0===n||n.forEach(d);const g=Q.worldIds++,b={id:g,storage:i,latestTick:-1,latestTickData:null,latestSystemId:-1,attach:function(e,...t){c.push(u(ye.Attach,e,t))},attachImmediate:p,addSystem:d,addTopic:function(e){o.push(e)},create:function(...e){const t=l++;return e.length>0&&c.push(u(ye.Attach,t,e)),t},destroy:function(e){s.has(e)||(c.push(u(ye.Destroy,e)),s.add(e))},destroyImmediate:y,get:function(e,t){J(t);const n=i.getComponentBySchema(e,t);if(null===n)throw new Error("Failed to get component: entity does not have component");return n},createSnapshot:function(){return{storage:i.createSnapshot()}},has:function(e,t){return J(t),i.hasComponentOfSchema(e,t)},detach:function(e,...t){if(0===t.length)return;const n=t.map((e=>{var t;return"number"==typeof e?e:null!==(t=Q.schemaIndex.get(e))&&void 0!==t?t:ee(e)}));c.push(u(ye.Detach,e,n))},detachImmediate:h,removeSystem:function(e){const t=r.indexOf(e);t>-1&&r.splice(t,1)},removeTopic:function(e){const t=o.indexOf(e);t>-1&&o.splice(t,1)},reset:function(){s.clear(),q(c),q(r),o.forEach((e=>e.clear())),q(o),l=0,b.latestTick=-1,b.latestTickData=null,b.latestSystemId=-1;for(let e=0;e<i.archetypes.length;e++){const t=i.archetypes[e];for(let e=0;e<t.type.length;e++){const n=t.table[e],o=Q.schemaPools.get(t.type[e]);for(let e=0;e<n.length;e++){const t=n[e];null==o||o.release(t)}}}i.clear()},step:function(e){let t=Q.currentWorldId;Q.currentWorldId=g,b.latestTickData=e;for(let n=0;n<c.length;n++)m(c[n]);q(c);for(let n=0;n<o.length;n++)o[n].flush();for(let n=0;n<r.length;n++){const e=r[n];b.latestSystemId=e[he],e(b)}s.clear(),b.latestTick++,Q.currentWorldId=t},tryGet:function(e,t){try{return J(t),i.getComponentBySchema(e,t)}catch(n){return null}}};return Q.worlds.push(b),b}(),Pe=function(...e){return ae({select:e})}(ve,we);We.addSystem((function({create:e}){if(oe()){e(...function(){const e=new S({mass:0,type:S.STATIC,position:new m(0,0,0),shape:qe}),t=new I({color:3355443}),n=new k(Ae,t);return[Z(e,ve),Z(n,we)]}());for(let t=0;t<100;t++)e(...Be(new m(De(20),20,De(20))))}})),We.addSystem((function({latestTickData:e}){ce(Pe,((e,[t])=>{xe.addBody(t)})),xe.step(e/1e3)})),We.addSystem((function(){oe()&&(Oe.add(ke),ke.position.x=50,ke.position.y=50,ke.position.z=50),ce(Pe,((e,[,t])=>Oe.add(t))),Pe(((e,[t,n])=>function(e,t){t.position.x=e.position.x,t.position.y=e.position.y,t.position.z=e.position.z,t.quaternion.x=e.quaternion.x,t.quaternion.y=e.quaternion.y,t.quaternion.z=e.quaternion.z,t.quaternion.w=e.quaternion.w}(t,n))),Ce.update(),Ie.render(Oe,ke)}));let Fe=0;requestAnimationFrame((function e(t){We.step(t-(Fe||t)),requestAnimationFrame(e),Fe=t}));
