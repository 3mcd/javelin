!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Javelin={})}(this,(function(e){"use strict";function t(...e){}function n(e,t){const n=e.length,o=e.indexOf(t);if(-1===o)return!1;const r=e.pop();return o<n-1&&(e[o]=r),!0}function o(e){for(;e.length>0;)e.pop()}function r(e){return e.reduce((e,t,n)=>(e[n]=t,e),{})}function s(e){const t=[];for(const n in e){const o=parseInt(n,10);isNaN(o)||(t[o]=e[n])}return t}const c=()=>{const e=[];return{subscribe:t=>(e.push(t),()=>n(e,t)),dispatch:(t,n,o)=>{for(let r=0;r<e.length;r++)e[r](t,n,o)}}};function i(e){const{signature:t,signatureInverse:n,entities:o,indices:r,table:i}=function(e){const t="snapshot"in e?e.snapshot:null,n=t?Object.keys(t.indices).map(Number):[],o=t?s(t.indices):[],r=("signature"in e?e.signature:e.snapshot.signature).slice().sort((e,t)=>e-t),c=t?t.table.map(e=>e.slice()):r.map(()=>[]),i=r.reduce((e,t,n)=>(e[t]=n,e),[]);return{entities:n,indices:o,signature:r,signatureInverse:i,table:c}}(e),a=c(),l=c();return{entities:o,indices:r,insert:function(e,t){for(let e=0;e<t.length;e++){const o=t[e],r=n[o._tid];i[r].push(o)}r[e]=o.push(e)-1,a.dispatch(e)},inserted:a,remove:function(e){const t=o.length,n=r[e],s=o.pop();if(delete r[e],n===t-1)for(const e of i)e.pop();else{for(const e of i)e[n]=e.pop();o[n]=s,r[s]=n}l.dispatch(e)},removed:l,signature:t,signatureInverse:n,table:i}}const a={__WORLDS__:[],__CURRENT_WORLD__:-1};function l(e,t={throw:!1,global:!1}){const{global:n}=t,o=[];let r,s,c,i,l,u=-1;return function(...t){i=a.__CURRENT_WORLD__;const p=a.__WORLDS__[i],f=p.state.currentTick;l=n?0:p.state.currentSystem;let h=o[i];void 0===o[i]&&(h=o[i]=[]);let d=h[l];if(void 0===d&&(d=h[l]={cells:[],cellCount:-1}),!0===n||s!==i&&void 0!==s)u=0;else if(void 0===c||r===f&&c===l)u++;else{let e=h[c];if(-1!==e.cellCount&&e.cellCount!==u)throw new Error(`Failed to execute effect: encountered too ${e.cellCount>u?"few":"many"} effects this tick`);e.cellCount=u,u=0}let y=d.cells[u];if(y||(y=d.cells[u]={executor:e(p),lockGlobal:!1,lockAsync:!1,lockGlobalTick:-1,state:null}),n&&(y.lockGlobalTick!==p.state.currentTick?(y.lockGlobal=!1,y.lockGlobalTick=p.state.currentTick):y.lockGlobal=!0),y.lockGlobal||y.lockAsync)return y.state;const g=y.executor(...t);var m;return"object"==typeof(m=g)&&null!==m&&"then"in m?(y.lockAsync=!0,g.then(e=>y.state=e).catch(e=>console.error("Uncaught error in effect: "+e.message,e)).then(()=>y.lockAsync=!1)):y.state=g,r=f,s=i,c=l,y.state}}const u=l(()=>{let e=!0;const t={value:null};return n=>(e&&(t.value=n,e=!1),t)}),p=l(()=>{let e,t=0;return(n,o=!1)=>(o&&(t=0,clearTimeout(e)),0===t&&(t=1,e=setTimeout(()=>{t=2},n)),2===t)}),f=l(()=>e=>{const t=u(!1),n=p(e,t.value);return t.value=n,n});function h(e,t,n){const o=[],r=()=>{for(let t=0;t<n;t++)o.push(e(s))},s={allocate:r,retain:()=>(o.length||r(),o.pop()),release:e=>{o.push(t(e))}};return s}const d=(e,t)=>((e,t)=>{let n=0,o=0;if(e.length<t.length)return!1;for(;n<e.length&&o<t.length;)if(e[n]<t[o])n++;else{if(e[n]!==t[o])return!1;n++,o++}return o===t.length})(t.signature,e.signature)&&t.signature.every(t=>!e.filters.not.has(t));const y=(e,t=!1)=>l(n=>{const{storage:{entityRelocated:r}}=n;let s=null,c=[],i=[];const a={forEach:e=>{for(let t=0;t<i.length;t++)e(i[t])},[Symbol.iterator]:()=>i[Symbol.iterator]()};return r.subscribe((t,n,o)=>{null!==s&&!1!==e(s,n,o)&&c.push(t)}),function(e){let n;for(s!==e&&(e=>{if(o(c),o(i),null===s&&t)for(const[t]of e)for(let e=0;e<t.length;e++)c.push(t[e]);s=e})(e),o(i);void 0!==(n=c.pop());)i.push(n);return a}}),g=y((e,t,n)=>{const o=d(e,t),r=d(e,n);return!o&&r},!0),m=y((e,t,n)=>{const o=d(e,t),r=d(e,n);return o&&!r}),b=h(()=>[-1,null],e=>(e[0]=-1,e[1]=null,e),1e3),_=(e,t=!1)=>l(n=>{const{storage:{archetypes:o}}=n,r=[],s=[],c={forEach:e=>{for(let t=0;t<r.length;t++)e(r[t][0],r[t][1])},[Symbol.iterator]:()=>r[Symbol.iterator]()},i=e(n);let a=null;return i.subscribe((e,t)=>{if(null!==a)for(let n=0;n<t.length;n++){const o=t[n];if(o._tid===a){const t=b.retain();t[0]=e,t[1]=o,s.push(t)}}}),e=>{let n,i;for(null===a&&(e=>{if(t)for(let t=0;t<o.length;t++){const{table:n,entities:r,signatureInverse:c}=o[t],i=c[e.type];if(void 0!==i){const e=n[i];for(let t=0;t<r.length;t++){const n=b.retain();n[0]=r[t],n[1]=e[t],s.push(n)}}}})(e),a=e.type;n=r.pop();)b.release(n);for(;i=s.pop();)r.push(i);return c}}),v=_(e=>e.attached,!0),T=_(e=>e.detached),S=l(()=>{let e,t={response:null,error:null,done:!1},n=!1,o=new window.AbortController;return(r,s,c=void 0!==e&&r!==e)=>((null===r||c)&&(o.abort(),o=new AbortController),null===r?t:(c&&(t={response:t.response,error:null,done:!1}),t.done||n||(n=!0,e=r,fetch(r,{...s,signal:o.signal}).then(e=>{t={response:e,error:null,done:!0}}).catch(e=>{t={response:t.response,error:e,done:!0}}).then(()=>{n=!1})),t))}),w=l(()=>{let e;return(...t)=>{const n=u(null),o=S(...t);return o.response&&o.response!==n.value&&(o.response.json().then(t=>{e=t}),n.value=o.response),{...o,response:e||null}}}),C=Symbol("is_data_type");function O(e){return{...e,[C]:!0}}function k(e){return"object"==typeof e&&null!==e&&e[C]}function E(e,t){for(const n in t){const o=t[n];if(k(o))e[n]=o.create(void 0);else if("type"in o&&k(o.type)){const{type:t,defaultValue:r}=o;e[n]=t.create(r)}else E(e,o)}return e}function R(e,t){for(const n in t){const o=t[n];if(k(o))o.reset(e,n,void 0);else if("type"in o&&k(o.type)){const{type:t,defaultValue:r}=o;t.reset(e,n,r)}else R(e,o)}return e}function A(e){const t={};for(const n in e){const o=e[n];k(o)?t[n]=o.name:"type"in o&&k(o.type)?t[n]=o.type.name:t[n]=A(o)}return t}function D(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e){const o=e[n];if(k(o)){if(t[n]!==o.name)return!1}else if("type"in o&&k(o.type)){if(t[n]!==o.type.name)return!1}else{if(!D(o,t[n]))return!1}}return!0}function W(e){return Object.defineProperties({},{_tid:{value:e.type,writable:!1,enumerable:!0}})}function x(e){return{name:e.name,type:e.type,schema:A(e.schema)}}function I(e,t){return h(()=>E(W(e),e.schema),t=>R(t,e.schema),t)}const M=O({name:"number",create:(e=0)=>e,reset(e,t,n=0){e[t]=n}}),N=O({name:"boolean",create:(e=!1)=>e,reset(e,t,n=!1){e[t]=n}}),L=O({name:"string",create:(e="")=>e,reset(e,t,n=""){e[t]=n}});var P;!function(e){e[e.Internal=0]="Internal"}(P||(P={}));const U={[P.Internal]:"Internal Error"},j=/^\d+\(\)$/,F=/\d+/;let G={};function $(e,t,n){var o;const r=function(e){let t=G[e];if(!t){t=e.split(".");for(let e=0;e<t.length;e++){const n=t[e];F.test(n)&&(t[e]=Number(n))}G[e]=t}return t}(t),s=r[r.length-1];let c=e;for(let e=0;e<r.length-1;e++)c=c[r[e]];const i="string"==typeof s&&s.match(j),a=i?Number(i[0]):null;"number"==typeof a&&(null===(o=V.get(a))||void 0===o||o.apply(r[r.length-2],n)),c[s]=n}var z;!function(e){e[e.Push=0]="Push",e[e.Pop=1]="Pop",e[e.Shift=2]="Shift",e[e.Unshift=3]="Unshift",e[e.Splice=4]="Splice"}(z||(z={}));const q=new Map([[Array.prototype.push,z.Push],[Array.prototype.pop,z.Pop],[Array.prototype.shift,z.Shift],[Array.prototype.unshift,z.Unshift],[Array.prototype.splice,z.Splice]]),V=new Map([[z.Push,Array.prototype.push],[z.Pop,Array.prototype.pop],[z.Shift,Array.prototype.shift],[z.Unshift,Array.prototype.unshift],[z.Splice,Array.prototype.splice]]);function B(e={}){const t=c(),n=c(),s=(({onChange:e})=>{const t=new WeakMap,n=new WeakMap,o=new WeakMap,r=new WeakMap,s=new WeakSet;function c(e,t){const o=n.get(e);return""===o?t.toString():`${o}.${t}`}function i(e,s=e,c=""){let i=o.get(e);return void 0===i&&(i=new Proxy(e,a),o.set(e,i),r.set(i,e),t.set(e,s),n.set(e,c)),i}const a={get(e,n,o){const r=Reflect.get(e,n,o);return"symbol"!=typeof n&&("object"==typeof(s=r)&&null!==s||"function"==typeof s)?i(r,t.get(e),c(e,n)):r;var s},set(n,o,r,i){const a=n[o];return n[o]=r,a===r||s.has(n)||"symbol"==typeof o||e(t.get(n),n,c(n,o),r),!0},apply(n,o,i){const a=Array.isArray(o),l=r.get(o);let u=q.get(n),p=a&&"number"==typeof u;p&&s.add(l);const f=Reflect.apply(n,o,i);return p&&(e(t.get(l),o,c(l,u+"()"),i),s.delete(o)),f}};return{proxy:function(e){return i(e)},revoke:function(e){const t=o.get(e);o.delete(e),r.delete(t)}}})({onChange(e,t,n,o,r){let s=a.get(e);s||(s=[],a.set(e,s)),r?s.push(n,o,r):s.push(n,o)}}),a=new Map,l=e.snapshot?e.snapshot.archetypes.map(e=>i({snapshot:e})):[],u=[];function p(e){let n=function(e){const t=e.length;for(let n=0;n<l.length;n++){const o=l[n],{signature:r}=o;if(r.length!==t)continue;let s=!0;for(let n=0;n<t;n++)if(-1===r.indexOf(e[n]._tid)){s=!1;break}if(s)return o}return null}(e);return n||(n=i({signature:e.map(e=>e._tid)}),l.push(n),t.dispatch(n)),n}function f(e){const t=u[e];if(void 0===t)throw new Error("Failed to locate entity. Entity does not exist.");if(null===t)throw new Error("Failed to locate entity. Entity has been removed.");return l[t]}function h(e,t,o){e.remove(t);const r=p(o);r.insert(t,o),u[t]=l.indexOf(r),n.dispatch(t,e,r)}function d(e,t){const n=f(e),o=n.indices[e];let r=t.slice();for(let e=0;e<n.signature.length;e++){const s=n.signature[e];if(t.find(e=>e._tid===s))throw new Error(`Cannot attach component with type ${s} â€” entity already has component of type.`);r.push(n.table[e][o])}h(n,e,r)}function y(e,t){g(e,t.map(e=>e._tid))}function g(e,t){const n=f(e),o=n.indices[e];let r=[];for(let e=0;e<n.signature.length;e++){const c=n.signature[e],i=n.table[e][o];t.includes(c)?(s.revoke(i),a.delete(i)):r.push(i)}h(n,e,r)}const m=[];function b(e,t){const n=f(e),o=n.signatureInverse[t];if(void 0===o)return null;const r=n.indices[e];return n.table[o][r]}function _(e){const t=f(e),n=t.indices[e],o=[];for(let e=0;e<t.table.length;e++)o.push(t.table[e][n]);return o}function v(e){return s.proxy(e)}return{archetypeCreated:t,archetypes:l,clear:function(){a.clear(),o(l),o(u)},clearMutations:function(){a.forEach(o)},create:function(e,t){const n=p(t);return n.insert(e,t),u[e]=l.indexOf(n),e},destroy:function(e){y(e,_(e)),u[e]=null},entityRelocated:n,findComponent:function(e,t){return b(e,t.type)},findComponentByComponentTypeId:b,getComponentMutations:function(e){const t=a.get(e);if(!t)throw new Error("ChangeSet does not exist for component.");return t},getEntityComponents:_,getObservedComponent:v,hasComponent:function(e,t){return f(e).signature.includes(t.type)},insert:d,isComponentChanged:function(e){const t=a.get(e);return!!t&&t.length>0},patch:function(e,t,n,o){const r=f(e),s=r.indices[e],c=r.signatureInverse[t];if(void 0===c)return;const i=r.table[c][s];!function(e,t,n){if(!e)throw new Error(void 0!==n?`${U[n]}: ${t}`:t)}(void 0!==i,"Failed to patch component: entity does not exist in archetype"),$(v(i),n,o)},remove:y,removeByTypeIds:g,snapshot:function(){return{archetypes:l.map(e=>({signature:e.signature.slice(),table:e.table.map(e=>e.map(e=>({...e}))),indices:r(e.indices)}))}},upsert:function(e,t){const n=f(e),r=n.indices[e];o(m);for(let e=0;e<t.length;e++){const o=t[e],s=n.signatureInverse[o._tid];if(void 0===s)m.push(o);else{const e=v(n.table[s][r]);Object.assign(e,o)}}m.length>0&&d(e,m)}}}var J;(J=e.WorldOpType||(e.WorldOpType={}))[J.Spawn=0]="Spawn",J[J.Attach=1]="Attach",J[J.Detach=2]="Detach",J[J.Mutate=3]="Mutate",J[J.Destroy=4]="Destroy",e.$isDataType=C,e.array=e=>O({name:"array",create:(e=[])=>e,reset(e,t,n){void 0!==n?e[t]=n.slice():o(e[t])}}),e.arrayOf=function(e=0,n=t){return Array(e).fill(void 0).map((e,t)=>n(t))},e.boolean=N,e.createArchetype=i,e.createComponentBase=W,e.createComponentPool=I,e.createComponentType=function(e){return{...e,schema:e.schema||{}}},e.createDataType=O,e.createEffect=l,e.createStorage=B,e.createTopic=()=>{const e=[],t=[];return{*[Symbol.iterator](){for(let e=0;e<t.length;e++)yield t[e]},push:t=>e.push(t),pushImmediate:e=>t.push(e),flush:()=>{o(t);for(let n=e.length-1;n>=0;n--)t[n]=e.pop()},clear:()=>{o(e),o(t)}}},e.createWorld=function(t={}){var n,r;const{componentPoolSize:s=1e3,topics:i=[]}=t,l=[],u=[],p=[],f=h(()=>[],e=>(o(e),e),1e3),d=[],y=new Map,g=c(),m=c(),b=c(),_=c(),v=new Set,T=B({snapshot:null===(n=t.snapshot)||void 0===n?void 0:n.storage});let S={currentTickData:null,currentTick:0,currentSystem:0},w=0;function C(...e){const t=f.retain();for(let n=0;n<e.length;n++)t[n]=e[n];return t}function O(t,n=!0){switch(!0===n&&p.push(t),t[0]){case e.WorldOpType.Spawn:return function(e){const[,t]=e;b.dispatch(t),T.create(t,[])}(t);case e.WorldOpType.Attach:return function(e){const[,t,n]=e;g.dispatch(t,n),T.insert(t,n)}(t);case e.WorldOpType.Detach:return function(e){const[,t,n]=e;m.dispatch(t,n),T.remove(t,n)}(t);case e.WorldOpType.Destroy:return function(e){const[,t]=e;_.dispatch(t),T.destroy(t)}(t)}}function k(e){const t=y.get(e._tid);t&&t.release(e)}function E(e){l.push(e),e.__JAVELIN_SYSTEM_ID__=0}function R(e,t){const n=T.findComponent(e,t);if(null===n)throw new Error("Component not found");return n}null===(r=t.systems)||void 0===r||r.forEach(E),m.subscribe((e,t)=>t.forEach(k));const{getObservedComponent:A,isComponentChanged:W,patch:M}=T,N={addSystem:E,addTopic:function(e){i.push(e)},applyOps:function(e){for(let t=0;t<e.length;t++)O(e[t],!1)},attach:function(t,...n){u.push(C(e.WorldOpType.Attach,t,n))},component:function(e,...n){d.includes(e)||function(e,n=s){if(d.find(({type:t})=>e.type===t))throw new Error("Failed to register component type: a componentType with same id is already registered");if(t.snapshot){const n=t.snapshot.componentTypes.find(t=>t.type===e.type);if(n&&!D(e.schema,n.schema))throw new Error("Failed to register component type: component type schema does not match world snapshot")}d.push(e),y.set(e.type,I(e,n))}(e);const o=y.get(e.type).retain();return e.initialize&&e.initialize(o,...n),o},componentTypes:d,destroy:function(t){if(v.has(t))return;const n=T.getEntityComponents(t);u.push(C(e.WorldOpType.Detach,t,n),C(e.WorldOpType.Destroy,t)),v.add(t)},detach:function(t,...n){0!==n.length&&("type"in n[0]&&(n=n.map(e=>R(t,e))),u.push(C(e.WorldOpType.Detach,t,n)))},get:R,getObserved:A,has:function(e,t){return T.hasComponent(e,t)},id:-1,isComponentChanged:W,ops:p,patch:M,removeSystem:function(e){const t=l.indexOf(e);t>-1&&l.splice(t,1)},removeTopic:function(e){const t=i.indexOf(e);t>-1&&i.splice(t,1)},reserve:function(){return++w},reset:function(){for(o(u),o(p),o(d),o(l),y.clear(),v.clear(),S={currentTickData:null,currentTick:0,currentSystem:0},w=0;u.length>0;)f.release(u.pop());for(;p.length>0;)f.release(p.pop());for(let e=0;e<T.archetypes.length;e++){const t=T.archetypes[e];for(let e=0;e<t.signature.length;e++){const n=t.table[e],o=y.get(t.signature[e]);for(let e=0;e<n.length;e++){const t=n[e];null==o||o.release(t)}}}T.clear()},snapshot:function(){return{componentTypes:d.map(x),storage:T.snapshot()}},spawn:function(...t){const n=w++;return u.push(C(e.WorldOpType.Spawn,n),C(e.WorldOpType.Attach,n,t)),n},state:S,storage:T,tick:function(e){for(a.__CURRENT_WORLD__=L,S.currentTickData=e,T.clearMutations();p.length>0;)f.release(p.pop());for(let e=0;e<u.length;e++)O(u[e]);o(u);for(let e=0;e<i.length;e++)i[e].flush();for(let e=0;e<l.length;e++){const t=l[e];N.state.currentSystem=t.__JAVELIN_SYSTEM_ID__,t(N)}v.clear(),S.currentTick++},tryGet:function(e,t){return T.findComponent(e,t)},attached:g,detached:m,spawned:b,destroyed:_};let L=N.id=a.__WORLDS__.push(N)-1;return N},e.initializeComponentFromSchema=E,e.interval=f,e.isComponentOf=function(e,t){return e._tid===t.type},e.isDataType=k,e.json=w,e.mutableEmpty=o,e.mutableRemove=function(e,t){const n=e.indexOf(t);return-1!==n&&(e.splice(n,1),!0)},e.mutableRemoveUnordered=n,e.noop=t,e.number=M,e.onAttach=v,e.onDetach=T,e.onInsert=g,e.onRemove=m,e.packSparseArray=r,e.query=function(...e){const t=e.length,n=e.map(e=>e.type),r={not:new Set},s=n.slice().sort((e,t)=>e-t),c=[],i=(e,t)=>{if(d(p,e)){const o=n.map(t=>e.table[e.signature.indexOf(t)]);t.push([e.entities,o])}},l=e=>{const t=a.__WORLDS__[e],n=[];return c[e]=n,t.storage.archetypes.forEach(e=>i(e,n)),t.storage.archetypeCreated.subscribe(e=>i(e,n)),n},u=h(()=>[],e=>(o(e),e),1e3),p={layout:n,length:t,signature:s,filters:r,not(...e){for(let t=0;t<e.length;t++)r.not.add(e[t].type);return p},forEach(e){const n=c[a.__CURRENT_WORLD__]||l(a.__CURRENT_WORLD__),o=u.retain();for(let r=0;r<n.length;r++){const[s,c]=n[r];for(let n=0;n<s.length;n++){for(let e=0;e<t;e++)o[e]=c[e][n];e(s[n],o)}}u.release(o)},[Symbol.iterator]:()=>(c[a.__CURRENT_WORLD__]||l(a.__CURRENT_WORLD__))[Symbol.iterator]()};return p},e.queryMatchesArchetype=d,e.ref=u,e.request=S,e.resetComponentFromSchema=R,e.schemaEqualsSerializedSchema=D,e.serializeComponentType=x,e.serializeSchema=A,e.string=L,e.timer=p,e.unpackSparseArray=s,Object.defineProperty(e,"__esModule",{value:!0})}));
