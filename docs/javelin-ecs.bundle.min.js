!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Javelin={})}(this,(function(t){"use strict";function e(t){const e=t.length,n=[],o=[],r=[],c=[];for(let t=0;t<e;t++)n[t]=[];let i=-1;return{layout:t,table:n,indices:r,entities:o,insert:function(e,p){i++;for(let e=0;e<p.length;e++){const o=p[e],r=t.indexOf(o.type);n[r][i]=o}o[i]=e,r[e]=i,c[i]=e},remove:function(t){const e=r[t];if(e===i)for(const t of n)t[i]=null;else for(const t of n)t[e]=t[i],t[i]=null;o[e]=o[i],c[e]=c[i],r[o[i]]=e,r[t]=-1,o.pop(),i--},entitiesByIndex:c}}function n(t){return e=>({componentType:e,componentPredicate:t()})}const o=n(()=>(t,{attached:e})=>e.has(t)),r=n(()=>(t,{isComponentChanged:e})=>e(t)),c=n(()=>(t,{detached:e})=>e.has(t));function i(t,e,n){const o=[],r=()=>{for(let e=0;e<n;e++)o.push(t())};return{allocate:r,retain:()=>(o.length||r(),o.pop()),release:t=>{o.push(e(t))}}}const p=Symbol("world_storage"),s=Symbol("is_data_type");function a(t){return{...t,[s]:!0}}function l(t){return"object"==typeof t&&null!==t&&t[s]}function u(t,e){for(const n in e){const o=e[n];if(l(o))t[n]=o.create(void 0);else if("type"in o&&l(o.type)){const{type:e,defaultValue:r}=o;t[n]=e.create(r)}else u(t,o)}return t}function f(t,e){for(const n in e){const o=e[n];if(l(o))o.reset(t,n,void 0);else if("type"in o&&l(o.type)){const{type:e,defaultValue:r}=o;e.reset(t,n,r)}else f(t,o)}return t}function y(t,e){return i(()=>u({type:t.type,_v:0},t.schema),e=>f(e,t.schema),e)}function h(...t){}function d(t){for(;t.length>0;)t.pop()}function m(t=0,e=h){return Array(t).fill(void 0).map((t,n)=>e(n))}const g=a({name:"number",create:(t=0)=>t,reset(t,e,n=0){t[e]=n}}),b=a({name:"boolean",create:(t=!1)=>t,reset(t,e,n=!1){t[e]=n}}),w=a({name:"string",create:(t="")=>t,reset(t,e,n=""){t[e]=n}}),C=/^\w\(\)$/,T=/\d+/;let S={};function v(t,e,n){var o;const r=function(t){let e=S[t];if(!e){e=t.split(".");for(let t=0;t<e.length;t++){const n=e[t];T.test(n)&&(e[t]=Number(n))}S[t]=e}return e}(e),c=e[e.length-1];let i=t;for(let t=0;t<r.length-1;t++)i=i[r[t]];const p=c.match(C),s=p?Number(p[0]):null;"number"==typeof s&&(null===(o=A.get(s))||void 0===o||o.apply(e[e.length-2],n)),i[c]=n}var O;!function(t){t[t.Push=0]="Push",t[t.Pop=1]="Pop",t[t.Shift=2]="Shift",t[t.Unshift=3]="Unshift",t[t.Splice=4]="Splice"}(O||(O={}));const x=new Map([[Array.prototype.push,O.Push],[Array.prototype.pop,O.Pop],[Array.prototype.shift,O.Shift],[Array.prototype.unshift,O.Unshift],[Array.prototype.splice,O.Splice]]),A=new Map([[O.Push,Array.prototype.push],[O.Pop,Array.prototype.pop],[O.Shift,Array.prototype.shift],[O.Unshift,Array.prototype.unshift],[O.Splice,Array.prototype.splice]]);function E(){const t=(({onChange:t})=>{const e=new WeakMap,n=new WeakMap,o=new WeakMap,r=new WeakMap,c=new WeakSet;function i(t,e){const o=n.get(t);return""===o?e.toString():`${o}.${e}`}function p(t,c=t,i=""){let p=o.get(t);return void 0===p&&(p=new Proxy(t,s),o.set(t,p),r.set(p,t),e.set(t,c),n.set(t,i)),p}const s={get(t,n,o){const r=Reflect.get(t,n,o);return"object"==typeof(c=r)&&null!==c||"function"==typeof c?p(r,e.get(t),i(t,n)):r;var c},set(n,o,r,p){const s=Reflect.get(n,o,p),a=Reflect.has(n,o);return!!Reflect.set(n,o,r,p)&&(a&&Object.is(s,r)||c.has(n)||t(e.get(n),n,i(n,o),r),!0)},apply(n,o,p){const s=Array.isArray(o),a=r.get(o);let l=x.get(n),u=s&&"number"==typeof l;u&&c.add(a);const f=Reflect.apply(n,o,p);return u&&(t(e.get(a),o,i(a,l+"()"),p),c.delete(o)),f}};return{proxy:function(t){return p(t)},revoke:function(t){const e=o.get(t);o.delete(t),r.delete(e)}}})({onChange(t,e,o,r,c){let i=n.get(t);i||(i=[],n.set(t,i)),c?i.push(o,r,c):i.push(o,r)}}),n=new Map,o=[],r=[];function c(t){let n=function(t){const e=t.length;for(let n=0;n<o.length;n++){const r=o[n],{layout:c}=r;if(c.length!==e)continue;let i=!0;for(let n=0;n<e;n++)if(-1===c.indexOf(t[n].type)){i=!1;break}if(i)return r}return null}(t);return n||(n=e(t.map(t=>t.type)),o.push(n)),n}function i(t){const e=r[t];if(void 0===e)throw new Error("Failed to locate entity. Entity does not exist.");if(null===e)throw new Error("Failed to locate entity. Entity has been removed.");return o[e]}function p(t,e,n){if(t.remove(e),0===n.length)return;const i=c(n);i.insert(e,n),r[e]=o.indexOf(i)}function s(t,e){a(t,e.map(t=>t.type))}function a(e,o){const r=i(e),c=r.indices[e];let s=[];for(let e=0;e<r.layout.length;e++){const i=r.layout[e],p=r.table[e][c];o.includes(i)?(t.revoke(p),n.delete(p)):s.push(p)}p(r,e,s)}function l(t){const e=i(t),n=e.indices[t],o=[];for(let t=0;t<e.table.length;t++)o.push(e.table[t][n]);return o}function u(e){return t.proxy(e)}return{archetypes:o,clearMutations:function(){n.forEach(d)},create:function(t,e){const n=c(e);return n.insert(t,e),r[t]=o.indexOf(n),t},destroy:function(t){s(t,l(t)),r[t]=null},findComponent:function(t,e){const n=i(t),o=n.layout.indexOf(e.type);if(-1===o)throw new Error("Failed to find component. Component could not exist with entity.");const r=n.indices[t];return n.table[o][r]},getEntityComponents:l,getMutableComponent:u,getComponentMutations:function(t){const e=n.get(t);if(!e)throw new Error("ChangeSet does not exist for component.");return e},insert:function(t,e){const n=i(t),o=n.indices[t];let r=e.slice();for(let t=0;t<n.layout.length;t++){const c=n.layout[t];if(e.find(t=>t.type===c))throw new Error(`Cannot attach component with type ${c} â€” entity already has component of type.`);r.push(n.table[t][o])}p(n,t,r)},isComponentChanged:function(t){const e=n.get(t);return!!e&&e.length>0},remove:s,removeByTypeIds:a,applyComponentPatch:function(t,e,n,o){const r=i(t),c=r.indices[t],p=r.layout.indexOf(e);if(-1===p)return;v(u(r.table[p][c]),n,o)}}}var P;(P=t.WorldOpType||(t.WorldOpType={}))[P.Spawn=0]="Spawn",P[P.Attach=1]="Attach",P[P.Detach=2]="Detach",P[P.Mutate=3]="Mutate",P[P.Destroy=4]="Destroy";t.$isDataType=s,t.$worldStorageKey=p,t.array=t=>a({name:"array",create:(t=[])=>t,reset(t,e,n){void 0!==n?t[e]=n.slice():d(t[e])}}),t.arrayOf=m,t.attached=o,t.boolean=b,t.changed=r,t.createArchetype=e,t.createComponentFilter=n,t.createComponentPool=y,t.createComponentType=function(t){return t},t.createDataType=a,t.createStorage=E,t.createTopic=()=>{const t=[],e=[];return{*[Symbol.iterator](){for(let t=0;t<e.length;t++)yield e[t]},push:e=>t.push(e),pushImmediate:t=>e.push(t),flush:()=>{d(e);for(let n=t.length-1;n>=0;n--)e[n]=t.pop()}}},t.createWorld=(e={})=>{const{systems:n=[],componentTypes:o=[],componentPoolSize:r=1e3}=e,c=[],s=[],a=i(()=>[],t=>(d(t),t),1e3),l=new Map,f=E(),h=[],m=new Set,g=new Set,b=new Set;let w=0;for(let t=0;t<o.length;t++)O(o[t]);function C(e){switch(e[0]){case t.WorldOpType.Spawn:!function(t){const[,e,n]=t;for(let t=0;t<n.length;t++)b.add(n[t]);f.create(e,n)}(e);break;case t.WorldOpType.Attach:!function(t){const[,e,n]=t;for(let t=0;t<n.length;t++)b.add(n[t]);f.insert(e,n)}(e);break;case t.WorldOpType.Detach:!function(t){const[,e,n]=t,o=f.getEntityComponents(e);for(let t=0;t<o.length;t++){const e=o[t];n.includes(e.type)&&T(e)}f.removeByTypeIds(e,n)}(e);break;case t.WorldOpType.Destroy:!function(t){const[,e]=t;m.add(e)}(e)}s.push(e)}function T(t){const e=l.get(t.type);g.delete(t),e&&e.release(t)}function S(t){f.getEntityComponents(t).forEach(T),f.destroy(t)}function v(t,e){return f.findComponent(t,e)}function O(t,e=r){if(h.includes(t))throw new Error(`Tried to register componentType with type id ${t.type} more than once.`);h.push(t),l.set(t.type,y(t,e))}const{getMutableComponent:x,isComponentChanged:A,applyComponentPatch:P}=f,W={[p]:f,addSystem:function(t){n.push(t)},applyComponentPatch:P,applyOps:function(e){for(let n=0;n<e.length;n++){const o=e[n];if(o[0]===t.WorldOpType.Detach){const[,t,e]=o,n=f.getEntityComponents(t);for(let t=0;t<n.length;t++){const o=n[t];e.includes(o.type)&&g.add(o)}}else if(o[0]===t.WorldOpType.Destroy){const[,t]=o,e=f.getEntityComponents(t);for(let t=0;t<e.length;t++)g.add(e[n])}C(o)}},attach:function(e,...n){const o=a.retain();o[0]=t.WorldOpType.Attach,o[1]=e,o[2]=n,c.push(o)},attached:b,component:function(t,...e){const n=l.get(t.type),o=n?n.retain():u({type:t.type},t.schema);return t.initialize&&t.initialize(o,...e),o},componentTypes:h,destroy:function(e){const n=a.retain();n[0]=t.WorldOpType.Destroy,n[1]=e;const o=f.getEntityComponents(e);for(let t=0;t<o.length;t++)g.add(o[t]);c.push(n)},detach:function(e,...n){const o=a.retain();o[0]=t.WorldOpType.Detach,o[1]=e,o[2]=n.map(t=>t.type);for(let t=0;t<n.length;t++)g.add(n[t]);c.push(o)},detached:g,getComponent:v,getMutableComponent:x,isComponentChanged:A,ops:s,registerComponentType:O,spawn:function(...e){const n=w++,o=a.retain();return o[0]=t.WorldOpType.Spawn,o[1]=n,o[2]=e,c.push(o),n},tick:function(t){for(f.clearMutations();s.length>0;)a.release(s.pop());for(m.forEach(S),m.clear(),b.clear();c.length>0;)C(c.pop());for(let e=0;e<n.length;e++)n[e](W,t)},tryGetComponent:function(t,e){try{return v(t,e)}catch(t){return null}}};return W},t.detached=c,t.initializeComponentFromSchema=u,t.isComponentOf=function(t,e){return t.type===e.type},t.isDataType=l,t.mutableEmpty=d,t.mutableRemove=function(t,e){const n=t.indexOf(e);return-1!==n&&(t.splice(n,1),!0)},t.mutableRemoveUnordered=function(t,e){const n=t.length,o=t.indexOf(e);if(-1===o)return!1;const r=t.pop();return o<n-1&&(t[o]=r),!0},t.noop=h,t.number=g,t.query=function(...t){const e=t.map(t=>"componentPredicate"in t?t.componentPredicate:null),n=t.length,o=t.map(t=>"componentType"in t?t.componentType.type:t.type),r=m(n),c=[-1,r],i=[];let s,a,l,u=-1,f=-1;const y={value:c,done:!1};function h(){const{table:t,entitiesByIndex:o}=l,[p]=t;t:for(;p[++f];){let p=!0;c[0]=o[f];for(let o=0;o<n;o++){const n=e[o],c=t[i[o]][f];if(p=n?n(c,s):!s.detached.has(c),!p)continue t;r[o]=c}return}g()}function g(){let t;t:for(;t=a[++u];){const{layout:e}=t;l=t,f=-1;for(let t=0;t<n;t++){const n=e.indexOf(o[t]);if(-1===n)continue t;i[t]=n}return void h()}y.done=!0,c[0]=-1,d(r)}const b={next:()=>(null===l?g():h(),y)},w={[Symbol.iterator]:()=>b};return t=>(s=t,a=t[p].archetypes,l=null,u=-1,f=-1,y.done=!1,w)},t.resetComponentFromSchema=f,t.string=w,Object.defineProperty(t,"__esModule",{value:!0})}));
