!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Javelin={})}(this,(function(t){"use strict";function e(t){const e=t.length,n=[],o=[],r=[],c=[];for(let t=0;t<e;t++)n[t]=[];let i=-1;return{layout:t,table:n,indices:r,entities:o,insert:function(e,s){i++;for(let e=0;e<s.length;e++){const o=s[e],r=t.indexOf(o._t);n[r][i]=o}o[i]=e,r[e]=i,c[i]=e},remove:function(t){const e=r[t];if(e===i)for(const t of n)t[i]=null;else for(const t of n)t[e]=t[i],t[i]=null;o[e]=o[i],c[e]=c[i],r[o[i]]=e,r[t]=-1,o.pop(),i--},entitiesByIndex:c}}function n(t){return e=>({componentType:e,componentPredicate:t()})}const o=n(()=>(t,e)=>e.attached.has(t)),r=n(()=>{const t=new WeakMap;return e=>{const n=t.get(e),o=e._v!==(void 0===n?-1/0:n);return o&&t.set(e,e._v),o}}),c=n(()=>(t,e)=>-1===t._v);function i(t,e,n){const o=[],r=()=>{for(let e=0;e<n;e++)o.push(t())};return{allocate:r,retain:()=>(o.length||r(),o.pop()),release:t=>{o.push(e(t))}}}const s=Symbol("world_storage"),l=Symbol("is_data_type");function a(t){return{...t,[l]:!0}}function u(t){return"object"==typeof t&&null!==t&&t[l]}function p(t,e){for(const n in e){const o=e[n];if(u(o))t[n]=o.create(void 0);else if("type"in o&&u(o.type)){const{type:e,defaultValue:r}=o;t[n]=e.create(r)}else p(t,o)}return t}function f(t,e){for(const n in e){const o=e[n];if(u(o))o.reset(t,n,void 0);else if("type"in o&&u(o.type)){const{type:e,defaultValue:r}=o;e.reset(t,n,r)}else f(t,o)}return t}function y(t,e){return i(()=>p({_t:t.type,_v:0},t.schema),e=>f(e,t.schema),e)}function d(...t){}function h(t){for(;t.length>0;)t.pop()}function m(t=0,e=d){return Array(t).fill(void 0).map((t,n)=>e(n))}const g=a({name:"number",create:(t=0)=>t,reset(t,e,n=0){t[e]=n}}),v=a({name:"boolean",create:(t=!1)=>t,reset(t,e,n=!1){t[e]=n}}),_=a({name:"string",create:(t="")=>t,reset(t,e,n=""){t[e]=n}});function b(t,e){if(t.find(t=>t._t===e))throw new Error(`Cannot attach component with type ${e} â€” entity already has component of type.`)}function T(){const t=[],n=[];function o(n){let o=function(e){const n=e.length;for(let o=0;o<t.length;o++){const r=t[o],{layout:c}=r;if(c.length!==n)continue;let i=!0;for(let t=0;t<n;t++)if(-1===c.indexOf(e[t]._t)){i=!1;break}if(i)return r}return null}(n);return o||(o=e(n.map(t=>t._t)),t.push(o)),o}function r(e){const o=n[e];return function(t){if(void 0===t)throw new Error("Failed to locate entity. Entity does not exist.");if(null===t)throw new Error("Failed to locate entity. Entity has been removed.")}(o),t[o]}function c(e,r,c){e.remove(r),c.forEach(l);const i=o(c);i.insert(r,c),n[r]=t.indexOf(i)}function i(t,e){const n=r(t),o=n.indices[t];let i=e.slice();for(let t=0;t<n.layout.length;t++)b(e,n.layout[t]),i.push(n.table[t][o]);c(n,t,i)}function s(t,e){const n=r(t),o=n.indices[t];let i=[];for(let t=0;t<n.layout.length;t++){const r=n.layout[t],c=n.table[t][o];e.includes(r)||i.push(c)}c(n,t,i)}function l(t){t._v=0}function a(t){!function(t){if(-1===t._v)throw new Error("Tried to modify detached component.")}(t),t._v++}const u=[];return{create:function(e,r){const c=o(r);return r.forEach(l),c.insert(e,r),n[e]=t.indexOf(c),e},insert:i,remove:function(t,e){s(t,e.map(t=>t._t))},removeByTypeIds:s,destroy:function(t){r(t).remove(t),n[t]=null},archetypes:t,incrementVersion:a,findComponent:function(t,e){const n=r(t),o=n.layout.indexOf(e.type);!function(t){if(-1===t)throw new Error("Failed to find component. Component could not exist with entity.")}(o);const c=n.indices[t];return n.table[o][c]},upsert:function(t,e){const n=r(t),o=n.indices[t];for(let t=0;t<e.length;t++){const r=e[t],{_t:c}=r,i=n.layout.indexOf(c);if(-1===i)u.push(r);else{const t=n.table[i][o];Object.assign(t,r),a(t)}}u.length>0&&i(t,u),h(u)},getEntityComponents:function(t){const e=r(t),n=e.indices[t],o=[];for(let t=0;t<e.table.length;t++)o.push(e.table[t][n]);return o}}}var w;(w=t.WorldOpType||(t.WorldOpType={}))[w.Spawn=0]="Spawn",w[w.Attach=1]="Attach",w[w.Detach=2]="Detach",w[w.Mutate=3]="Mutate",w[w.Destroy=4]="Destroy";t.$isDataType=l,t.$worldStorageKey=s,t.array=t=>a({name:"array",create:(t=[])=>t,reset(t,e,n){void 0!==n?t[e]=n.slice():h(t[e])}}),t.arrayOf=m,t.attached=o,t.boolean=v,t.changed=r,t.createArchetype=e,t.createComponentFilter=n,t.createComponentPool=y,t.createComponentType=function(t){return t},t.createDataType=a,t.createStorage=T,t.createTopic=()=>{const t=[],e=[];return{*[Symbol.iterator](){for(let t=0;t<e.length;t++)yield e[t]},push:e=>t.push(e),pushImmediate:t=>e.push(t),flush:()=>{h(e);for(let n=t.length-1;n>=0;n--)e[n]=t.pop()}}},t.createWorld=(e={})=>{const{systems:n=[],componentTypes:o=[],componentPoolSize:r=1e3}=e,c=[],l=[],a=i(()=>[],t=>(h(t),t),1e3),u=new Map,f=T(),d=new Set,m=new Set,g=[];let v=0;for(let t=0;t<o.length;t++)C(o[t]);function _(e){switch(e[0]){case t.WorldOpType.Spawn:!function(t){const[,e,n]=t;for(let t=0;t<n.length;t++){const e=n[t];m.add(e)}f.create(e,n)}(e);break;case t.WorldOpType.Attach:!function(t){const[,e,n]=t;for(let t=0;t<n.length;t++)m.add(n[t]);f.insert(e,n)}(e);break;case t.WorldOpType.Detach:!function(t){const[,e,n]=t,o=f.getEntityComponents(e);for(let t=0;t<o.length;t++){const e=o[t];n.includes(e._t)&&b(e)}f.removeByTypeIds(e,n)}(e);break;case t.WorldOpType.Destroy:!function(t){const[,e]=t;d.add(e)}(e)}l.push(e)}function b(t){const e=u.get(t._t);e&&e.release(t)}function w(t){f.getEntityComponents(t).forEach(b),f.destroy(t)}function O(t,e){return f.findComponent(t,e)}function C(t,e=r){if(g.includes(t))throw new Error(`Tried to register componentType with type id ${t.type} more than once.`);g.push(t),u.set(t.type,y(t,e))}const E={[s]:f,addSystem:function(t){n.push(t)},applyOps:function(e){for(let n=0;n<e.length;n++){const o=e[n];if(o[0]===t.WorldOpType.Detach){const[,t,e]=o,n=f.getEntityComponents(t);for(let t=0;t<n.length;t++){const o=n[t];e.includes(o._t)&&(o._v=-1)}}else if(o[0]===t.WorldOpType.Destroy){const[,t]=o,e=f.getEntityComponents(t);for(let t=0;t<e.length;t++){e[t]._v=-1}}_(o)}},attach:function(e,...n){const o=a.retain();o[0]=t.WorldOpType.Attach,o[1]=e,o[2]=n,c.push(o)},attached:m,componentTypes:g,spawn:function(...e){const n=v++,o=a.retain();return o[0]=t.WorldOpType.Spawn,o[1]=n,o[2]=e,c.push(o),n},destroy:function(e){const n=a.retain();n[0]=t.WorldOpType.Destroy,n[1]=e;const o=f.getEntityComponents(e);for(let t=0;t<o.length;t++)o[t]._v=-1;c.push(n)},detach:function(e,...n){const o=a.retain();o[0]=t.WorldOpType.Detach,o[1]=e,o[2]=n.map(t=>t._t);for(let t=0;t<n.length;t++)n[t]._v=-1;c.push(o)},getComponent:O,mut:function(t){return f.incrementVersion(t),t},ops:l,registerComponentType:C,component:function(t,...e){const n=u.get(t.type),o=n?n.retain():p({_t:t.type,_v:0},t.schema);return t.initialize&&t.initialize(o,...e),o},tick:function(t){for(;l.length>0;)a.release(l.pop());for(d.forEach(w),d.clear(),m.clear();c.length>0;)_(c.pop());for(let e=0;e<n.length;e++)n[e](E,t)},tryGetComponent:function(t,e){try{return O(t,e)}catch(t){return null}}};return E},t.detached=c,t.initializeComponentFromSchema=p,t.isComponentOf=function(t,e){return t._t===e.type},t.isDataType=u,t.mutableEmpty=h,t.mutableRemove=function(t,e){const n=t.indexOf(e);return-1!==n&&(t.splice(n,1),!0)},t.mutableRemoveUnordered=function(t,e){const n=t.length,o=t.indexOf(e);if(-1===o)return!1;const r=t.pop();return o<n-1&&(t[o]=r),!0},t.noop=d,t.number=g,t.query=function(...t){const e=t.map(t=>"componentPredicate"in t?t.componentPredicate:null),n=t.length,o=t.map(t=>"componentType"in t?t.componentType.type:t.type),r=m(n),c=[-1,r],i=[];let l,a,u,p=-1,f=-1;const y={value:c,done:!1};function d(){const{table:t,entitiesByIndex:o}=u,[s]=t;t:for(;s[++f];){let s=!0;c[0]=o[f];for(let o=0;o<n;o++){const n=e[o],c=t[i[o]][f];if(s=n?n(c,l):c._v>-1,!s)continue t;r[o]=c}return}g()}function g(){let t;t:for(;t=a[++p];){const{layout:e}=t;u=t,f=-1;for(let t=0;t<n;t++){const n=e.indexOf(o[t]);if(-1===n)continue t;i[t]=n}return void d()}y.done=!0,c[0]=-1,h(r)}const v={next:()=>(null===u?g():d(),y)},_={[Symbol.iterator]:()=>v};return t=>(l=t,a=t[s].archetypes,u=null,p=-1,f=-1,y.done=!1,_)},t.resetComponentFromSchema=f,t.string=_,Object.defineProperty(t,"__esModule",{value:!0})}));
